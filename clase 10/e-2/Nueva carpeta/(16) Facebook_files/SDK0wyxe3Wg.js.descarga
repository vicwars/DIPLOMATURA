;/*FB_PKG_DELIM*/

__d("Cache",["TimeSlice"],(function(a,b,c,d,e,f,g){"use strict";var h=6e4;a=function(){function a(){this.$1=new Map()}var b=a.prototype;b.has=function(a){return this.$1.has(a)};b.get=function(a,b){a=this.__getRaw(a);return!a?b:a.$2};b.getAll=function(a,b){var c=this,d=new Map();a.forEach(function(a){return d.set(a,c.get(a,b))});return d};b["delete"]=function(a){var b=this.__getRaw(a);b&&b.$3&&clearTimeout(b.$3);return this.$1["delete"](a)};b.clear=function(){this.$1.forEach(function(a){a&&a.$3&&clearTimeout(a.$3)}),this.$1.clear()};b.set=function(a,b,d,e){if(!this.shouldUpdate(a,d))return!1;var f=this.__getRaw(a);f||(f=this.__getNewRawObject());delete f.$2;delete f.$4;f.$3&&clearTimeout(f.$3);delete f.$3;f.$2=b;d!=null&&(f.$4=d);e!=null&&e>=0&&(f.$3=setTimeout(c("TimeSlice").guard(this["delete"].bind(this,a),"Cache expiration timeout"),e*h));this.__setRaw(a,f);return!0};b.shouldUpdate=function(a,b){a=this.__getRaw(a);return a==null||a.$4==null||b==null||b>a.$4};b.size=function(){return this.$1.size};b.__getRaw=function(a){return this.$1.get(a)};b.__setRaw=function(a,b){this.$1.set(a,b)};b.__getNewRawObject=function(){return{$2:null,$3:null,$4:null,$5:null,$6:null}};b.__keys=function(){return this.$1.keys()};return a}();g["default"]=a}),98);
__d("EncryptedBackupsAttachmentProductType",["$InternalEnum"],(function(a,b,c,d,e,f){a=b("$InternalEnum")({MSGR:"msgr",IGD:"igd"});c=a;f["default"]=c}),66);
__d("IGDWEBUploadMessageUtils",["I64","MAWExtractMsFromExternalId","WALogger","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";var h,i;function a(a,b){var c=d("MAWExtractMsFromExternalId").extractMsFromExternalId((i||(i=d("I64"))).of_string(a));c==null&&d("WALogger").WARN(h||(h=babelHelpers.taggedTemplateLiteralLoose(["[sortOrder] Could not extract ms from externalId: ",""])),a);return d("WATimeUtils").castToMillisTime(Number(b)*1e3+(c!=null?c:0))}g.generateProtobufServerTs=a}),98);
__d("EncryptedBackupsUploadEntity",["$InternalEnum","EncryptedBackupsUtils","IGDWEBUploadMessageUtils","WAArmadilloBackupMessage.pb","WAByteArray","WAGlobals","WAJids","WATimeUtils","encodeProtobuf"],(function(a,b,c,d,e,f,g){"use strict";function a(a){return a instanceof ArrayBuffer?new Uint8Array(a):a}var h=b("$InternalEnum").Mirrored(["NEEDS_BACKUP","COMPLETED","NEEDS_BACKUP_RETRY","PERMANENT_FAILURE","EXPIRED","THREAD_DELETED","DELETION_PURGED","MESSAGE_DELETED","UPLOADING"]);b=b("$InternalEnum")({INVALID:"-1",IMAGE:"0",PTT:"1",DOCUMENT:"3",VIDEO:"4",GIF:"5",STICKER:"6",XMA:"22",MESSENGER_PREVIEW:"25"});function c(a){return a}function i(a){var b=a.messageApplication,c=a.msgId,e=a.reportingMeta;a=a.sortOrderMs;var f=d("WAJids").authorToUserId(c.author,d("WAJids").extractUserId(d("WAGlobals").getMyUserJid()));return d("encodeProtobuf").encodeProtobuf(d("WAArmadilloBackupMessage.pb").BackupMessageSpec,d("EncryptedBackupsUtils").asBackupMessage(f,c.externalId,a,e!=null?e:{frankingKey:null,frankingTag:null,frankingVersion:null,reportingContent:null,reportingTag:null},b)).readByteArrayView()}function e(a){return d("WAByteArray").uint8ArrayToBuffer(a)}function f(a){var b=a.attachmentContext,c=a.backupDirective,e=a.dbMsgType,f=a.instanceKey,g=a.isOpenEB,j=a.isRetroactiveUpload,k=a.legacyAttachmentContext,l=a.messageApplication,m=a.msgId,n=a.originalMsgProtocolId,o=a.reportingMeta,p=a.retryCount,q=a.senderId,r=a.serverTs,s=a.sortOrderMs,t=a.tags;a=a.triggerSource;l=i({messageApplication:l,msgId:m,reportingMeta:o,sortOrderMs:c.actionType===4?d("IGDWEBUploadMessageUtils").generateProtobufServerTs(m.externalId,r):s});o={backupActionType:c.actionType,backupDirective:c,dbMsgType:e,failTsMs:d("WATimeUtils").castToMillisTime(0),instanceKey:f,isOpenEB:g,isRetroactiveUpload:j,msgId:m,msgIdKey:d("EncryptedBackupsUtils").convertWAMsgIdToStringId(m),msgType:"text",originalMsgProtocolId:n,protobuf:l,retryCount:p,senderId:q,serverTs:r,sortOrderMs:s,supplementalKey:c.supplementalKey,tags:t,triggerSource:a,uploadStatus:h.NEEDS_BACKUP,uploadTsSec:d("WATimeUtils").unixTime()};b!=null&&(o=babelHelpers["extends"]({},o,{attachmentContext:b,legacyAttachmentContext:k,msgType:"media"}));return o}g.toEbBackupMessageBytes=a;g.EbUploadStatus=h;g.AttachmentContextMediaType=b;g.castToEBQueueId=c;g.encodeBackupMessage=i;g.getEbBackupMessageBytesBuffer=e;g.asEBUploadEntity=f}),98);
__d("LFUCache",["Cache","ExecutionEnvironment"],(function(a,b,c,d,e,f,g){"use strict";var h,i=15,j=1,k=6e4;a=function(a){function b(b,d){var e;e=a.call(this)||this;e.$LFUCache2=b&&b>0?b:i;e.$LFUCache3=d&&d>0?d:j;((h||(h=c("ExecutionEnvironment"))).canUseDOM||(h||(h=c("ExecutionEnvironment"))).isInWorker)&&e.$LFUCache4();return e}babelHelpers.inheritsLoose(b,a);var d=b.prototype;d.$LFUCache4=function(){clearTimeout(this.$LFUCache1),this.$LFUCache1=setTimeout(this.purge.bind(this),this.$LFUCache2*k)};d.destroy=function(){clearTimeout(this.$LFUCache1)};d.get=function(b,c){this.has(b)&&this.$LFUCache5(b);return a.prototype.get.call(this,b,c)};d.set=function(b,c,d,e){var f=this.has(b);c=a.prototype.set.call(this,b,c,d,e);c&&(f?this.$LFUCache5(b):this.$LFUCache6(b,this.$LFUCache3));return c};d.purge=function(){var a=this,b=Array.from(this.__keys());b.forEach(function(b){a.$LFUCache7(b)<a.$LFUCache3?a["delete"](b):a.$LFUCache6(b,0)});this.$LFUCache4()};d.$LFUCache5=function(a){var b=this.$LFUCache7(a)+1;this.$LFUCache6(a,b);return b};d.$LFUCache7=function(a){a=this.__getRaw(a);return a&&a.$LFUCache8?a.$LFUCache8:0};d.$LFUCache6=function(a,b){var c=this.__getRaw(a);c||(c=this.__getNewRawObject());c.$LFUCache8=b;this.__setRaw(a,c);return!0};return b}(c("Cache"));g["default"]=a}),98);
__d("MAWBridgeThread",["MAWTimeUtils","WAJids","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,c,e,f){var g=d("WAJids").switchOnMsgrChatJidType(a.jid,{group:function(a){return!0},user:function(a){return!1}});return{authoritativeThreadKey:c,cannotReplyReason:a.cannotReplyReason,clientThreadKey:b,description:e,folder:a.folder,instanceKey:f,isGroup:g,jid:a.jid,lastReadTs:d("MAWTimeUtils").ensureValidMillisTime(a.lastReadMsgTs)||d("WATimeUtils").castToMillisTime(0)}}g.createBridgeThread=a}),98);
__d("MAWGetOrCreateThreadTxns",["MAWAdminMsgTxns","MAWBridgeThread","MAWBridgeTypesCreators","MAWDbMsgTxns","MAWDbThread","MAWDexieTable","MAWFolderTypes","MAWIndexedDb","MAWQplProxy","MAWThreadMappingQPL","MAWWriteBulkWriteIncomingAdminMsgTxns","WATimeUtils","getErrorSafe","gkx","qpl"],(function(a,b,c,d,e,f,g){"use strict";function h(a,b){if(a!=null&&b!=null){var c=d("WATimeUtils").fromMillisTime(a),e=d("WATimeUtils").fromMillisTime(b);return d("WATimeUtils").castToMillisTime(Math.max(c,e))}return a!=null?a:b}function i(a,b){return a.threads.get({jid:b})}function j(a,b){return(c("gkx")("10029")?d("MAWDexieTable").dexieAll(b.map(function(b){return a.threads.get({jid:b})})).then(function(a){return a.filter(Boolean)}):a.threads.where("jid").anyOf(b).toArray()).then(function(a){var c=new Map();for(a of a)c.set(a.jid,a);return b.map(function(a){return c.get(a)})})}function a(a,b,e){var f=b.instanceKey,g=b.jid;d("MAWQplProxy").sendQplPointThroughBridge(c("qpl")._(1056836502,"2778"),"get_or_create_thread_start",{instanceKey:f});e!=null&&d("MAWQplProxy").sendQplPointThroughBridge(c("qpl")._(25313175,"1551"),"thread_mapping_get_or_create_thread_start",{instanceKey:e});return i(a,g).then(function(f){if(f==null){e!=null&&d("MAWQplProxy").sendQplPointThroughBridge(c("qpl")._(25313175,"1551"),"create-1-1-thread-start",{instanceKey:e});return l(a,b,e).then(function(a){return{created:!0,thread:a}})}else return o(a,b,f).then(function(a){return{created:!1,thread:a}})}).then(function(a){d("MAWQplProxy").sendQplPointThroughBridge(c("qpl")._(1056836502,"2778"),"get_or_create_thread_end",{instanceKey:f});e!=null&&d("MAWQplProxy").sendQplPointThroughBridge(c("qpl")._(25313175,"1551"),"thread_mapping_get_or_create_thread_end",{instanceKey:e});return a})}function b(a,b,c){c=c===void 0?{}:c;var e=c.logState;return j(a,b.map(function(a){a=a.jid;return a})).then(function(c){e==null||e("threadMapping2FetchedThreads");var f={},g=[],h=[];for(c of c.entries()){var i=c[0],j=c[1];j==null?g.push(b[i]):h.push({params:b[i],thread:j})}return d("MAWDexieTable").dexieAll([g.length?m(a,g):d("MAWDexieTable").dexieResolve([]),h.length?p(a,h):d("MAWDexieTable").dexieResolve([])]).then(function(a){var c=a[0];a=a[1];e==null||e("threadMapping3ThreadsUpdated");for(c of c){var d=c.adminMsgParams,g=c.thread;f[g.jid]={adminMsgParams:d,created:!0,thread:g}}for(d of a)f[d.jid]={adminMsgParams:null,created:!1,thread:d};return b.map(function(a){a=a.jid;return f[a]})})})}function k(a){var b=a.authoritativeThreadKey,c=a.clientThreadKey,e=a.createTs,f=a.deduplicationKey,g=a.folder,h=a.jid;a=a.lastActivityTimestamp;var i=d("WATimeUtils").millisTime();e=(a=a!=null?a:e)!=null?a:i;a={authoritativeThreadKey:b!=null?b:void 0,deduplicationKey:f,folder:g!=null?g:d("MAWFolderTypes").FOLDER_ID.INBOX,jid:h,lastReadMsg:null,lastReadMsgReceiptSent:null,newestMsgTs:e,oldestMsg:null,optimisticThreadKey:c!=null?c:void 0,threadOrder:d("MAWDbThread").craftThreadOrder(e,h)};return a}function l(a,b,e){var f=b.authoritativeThreadKey,g=b.description,h=b.instanceKey,i=b.skipVerifyThread,j=k(b);return a.threads.add(j).then(function(b){b=babelHelpers["extends"]({},j,{chatId:b});i!==!0&&d("MAWIndexedDb").afterTransaction({tag:"VerifyThreadExists",value:d("MAWBridgeThread").createBridgeThread(b,b.optimisticThreadKey,f,g,h)});e!=null&&d("MAWQplProxy").sendQplPointThroughBridge(c("qpl")._(25313175,"1551"),"write-e2ee-admin-msg-in-new-thread",{instanceKey:e});return d("MAWAdminMsgTxns").writeE2EEThreadDescriptionMsg(a,b,e)})["catch"](function(a){a=c("getErrorSafe")(a);h!=null&&d("MAWThreadMappingQPL").endFailureInWorker("create_thread_failed",h,{string:{createThreadFailureReason:a.message}});a.message="Error creating thread: "+a.message;throw a})}function m(a,b){var e=b.map(k);return a.threads.bulkAdd(e,{allKeys:!0}).then(function(c){c=c.map(function(a,c){return{data:babelHelpers["extends"]({},e[c],{chatId:a}),params:b[c]}});for(var f of c)f.params.skipVerifyThread!==!0&&d("MAWIndexedDb").afterTransaction({tag:"VerifyThreadExists",value:d("MAWBridgeThread").createBridgeThread(f.data,f.data.optimisticThreadKey,f.params.authoritativeThreadKey,f.params.description,f.params.instanceKey)});return d("MAWWriteBulkWriteIncomingAdminMsgTxns").writeE2EEAdminMsgsForIncomingCreatedThreadsWithoutAfterTxns(a,c.map(function(a){return a.data}))})["catch"](function(a){a=c("getErrorSafe")(a);a.message="Error bulk creating threads: "+a.message;throw a})}function n(a,b,c){var d=b.authoritativeThreadKey,e=b.clientThreadKey,f=b.deduplicationKey,g=b.folder;b=b.lastActivityTimestamp;d={authoritativeThreadKey:d!=null?d:a.authoritativeThreadKey,cannotReplyReason:g!=null||e!=null?null:a.cannotReplyReason,deduplicationKey:g!=null||e!=null?f:a.deduplicationKey,folder:g!=null?g:a.folder,newestMsgTs:h(c,b),optimisticThreadKey:e!=null?e:a.optimisticThreadKey};return babelHelpers["extends"]({},a,d)}function o(a,b,e){var f=b.authoritativeThreadKey,g=b.description,h=b.instanceKey,i=b.skipVerifyThread;return d("MAWDbMsgTxns").getThreadNewestMessageMs(a,e.jid).then(function(j){var k=n(e,b,j);return a.threads.update(e.chatId,k).then(function(){var a;i!==!0&&d("MAWIndexedDb").afterTransaction({tag:"VerifyThreadExists",value:d("MAWBridgeThread").createBridgeThread(k,k.optimisticThreadKey,f,g,h)});d("MAWIndexedDb").afterTransaction({tag:"ThreadUpdated",value:d("MAWBridgeTypesCreators").createBridgeUpdatedThread({folder:(a=k==null?void 0:k.folder)!=null?a:d("MAWFolderTypes").FOLDER_ID.INBOX,threadJid:k.jid})});return k})["catch"](function(a){a=c("getErrorSafe")(a);a.message="Error updating thread: "+a.message;throw a})})}function p(a,b){return d("MAWDexieTable").dexieAll(b.map(function(b){var c=b.params,e=b.thread;return d("MAWDbMsgTxns").getThreadNewestMessageMs(a,e.jid).then(function(a){a=n(e,c,a);return{params:c,thread:a}})})).then(function(b){return a.threads.bulkUpdate(b.map(function(a){a=a.thread;return{changes:a,key:a.chatId}})).then(function(){for(var a of b){var c=a.params,e=c.authoritativeThreadKey,f=c.description,g=c.instanceKey;c=c.skipVerifyThread;var h=a.thread;c!==!0&&d("MAWIndexedDb").afterTransaction({tag:"VerifyThreadExists",value:d("MAWBridgeThread").createBridgeThread(h,h.optimisticThreadKey,e,f,g)})}return b.map(function(a){a=a.thread;return a})})})["catch"](function(a){a=c("getErrorSafe")(a);a.message="Error bulk updating threads: "+a.message;throw a})}g.getExistingThread=i;g.bulkGetExistingThread=j;g.getOrCreateThread=a;g.bulkGetOrCreateThread=b;g.createThread=l;g.prepareUpdatedThreadData=n}),98);
__d("MAWAdminMsgTxns",["MAWDbMsg","MAWDbThread","MAWDbThreadTxns","MAWExternalId","MAWLocalizationType","MAWLocalizationUtils","MAWTimeUtils","MAWWriteBulkWriteIncomingAdminMsgTxns","MAWWriteMsgTxns","WALogger","WATimeUtils","emptyFunction"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a,b,c){var e=a.ts;e=d("WATimeUtils").castUnixTimeToMillisTime(e);c=d("MAWTimeUtils").ensureValidMillisTime(c)||d("WATimeUtils").castToMillisTime(0);e=e>c?e:c;return babelHelpers["extends"]({},b,{newestMsgTs:e,oldestMsg:a.msgId,snippetMsg:a.msgId,snippetMsgTs:d("WATimeUtils").castUnixTimeToMillisTime(d("MAWDbMsg").getCanonicalTsFromMsg(a)),threadOrder:d("MAWDbThread").craftThreadOrder(e,b.jid)})}function b(a,b){return d("MAWDbThreadTxns").getThread(a,b).then(function(b){if(!b.success){d("WALogger").WARN(h||(h=babelHelpers.taggedTemplateLiteralLoose(["writeReachabilityErrorAdminMsg failed to create or get 1:1 thread"])));return}b=b.value;var e=d("MAWLocalizationUtils").buildUnstoredDbAdminMsg({adminMsgContent:[],adminType:d("MAWLocalizationType").LOCALIZATION_TYPE.REACHABILITY_ERROR,version:0},b.jid,d("MAWExternalId").generateExternalId(),d("WATimeUtils").castMillisTimeToUnixTime(d("WATimeUtils").millisTime()));return d("MAWWriteMsgTxns").writeMsg(a,e,b).then(c("emptyFunction"))})}function e(a,b,c){return d("MAWWriteBulkWriteIncomingAdminMsgTxns").writeE2EEAdminMsgsForIncomingCreatedThreadsWithAfterTxns(a,[b],c).then(function(a){a=a[0];return a})}function f(a){var b=d("MAWDbMsg").craftE2eeAdminMsgAltIndex(a.chatId);b=d("MAWLocalizationUtils").buildUnstoredDbAdminMsg({adminMsgContent:[],adminType:d("MAWLocalizationType").LOCALIZATION_TYPE.E2EE_THREAD_DESCRIPTION,version:0},a.jid,d("MAWExternalId").generateExternalId(),d("WATimeUtils").castToUnixTime(0),b);return babelHelpers["extends"]({},b,{msgId:d("MAWDbMsg").craftMsgIdV2(a.chatId,1,b),sortOrderMs:0})}g.getUpdatedThreadForAdminMsg=a;g.writeReachabilityErrorAdminMsg=b;g.writeE2EEThreadDescriptionMsg=e;g.buildE2EEThreadDescriptionMsg=f}),98);
__d("MAWBridgeTrace",["WAJids"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,c,e,f,g,h,i){var j=a.ack,k=a.externalId,l=a.ts;a=a.type;var m=d("WAJids").switchOnMsgrChatJidType(b,{group:function(a){return"Group"},user:function(a){return"User"}});return{ack:j,externalId:k,isFirstMsg:!!f,openMessageOtid:e,openMessageParticipantCount:g,participantCount:h,threadJid:b,threadKey:i,threadType:m,traceType:c,ts:l,type_:a}}function b(a,b,c){return{traceContext:c,traceId:b,traceType:a}}function c(a,b,c,d){return{errorMessage:d,event:b,externalIds:a,traceType:c}}function e(a,b,c,d,e,f){return{checkPointId:a,dataTraceId:b,errorMessage:c,shouldFlush:d,syncChannel:e,tags:f}}g.createBridgeStartTraceData=a;g.createBridgeStartTraceWithTraceIdData=b;g.createBridgeUpdateTraceData=c;g.createBridgeTraceRecordCheckpointData=e}),98);
__d("MAWAfterWriteMsgUtil",["$InternalEnum","ArmadilloDataTraceType","MAWBridgeMsg","MAWBridgeTrace","MAWDbMsg","MAWIndexedDb","MAWXMAUtils"],(function(a,b,c,d,e,f,g){"use strict";c=b("$InternalEnum").Mirrored(["DO_NOT_BUMP_THREAD","BUMP_LOCAL_ONLY","BUMP_LOCAL_AND_SERVER"]);function a(a){var b=a.dbMsg,c=a.isFirstMsg,e=a.openMessageOtid,f=a.openMessageParticipantCount,g=a.participantCount,h=a.quotedReplyAttachmentMeta;a=a.updatedThread;var i=a.authoritativeThreadKey;a=a.jid;if(b.altIndex===d("MAWDbMsg").SPAM_ALT_INDEX||b.altIndex===d("MAWDbMsg").FUTUREPROOF_SPAM_ALT_INDEX)return;d("MAWIndexedDb").afterTransaction({tag:"StartTrace",value:d("MAWBridgeTrace").createBridgeStartTraceData(b,a,d("ArmadilloDataTraceType").armadilloMessageSend,e,c,f,g,i)});d("MAWXMAUtils").isXMAStoryReply(b.xmaMessageType)||d("MAWIndexedDb").afterTransaction({tag:"NewMsg",value:d("MAWBridgeMsg").createBridgeMsg(b,h)})}g.WriteMsgAfterTxnBumpThreadOption=c;g.writeMsgAfterTransaction=a}),98);
__d("MAWWriteBulkWriteIncomingAdminMsgTxns",["MAWAdminMsgTxns","MAWAfterWriteMsgUtil","MAWDbMsgTxns","MAWDexieTable","MAWQplProxy","WALogger","qpl"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(a,b){var c=[],e=[],f=[],g=new Map(),i=new Map(),j=b.map(function(b){return d("MAWDbMsgTxns").getThreadOldestMessageId(a,b.jid).then(function(a){return g.set(b.jid,a)})}),k=b.map(function(b){return d("MAWDbMsgTxns").getThreadNewestMessageMs(a,b.jid).then(function(a){return i.set(b.jid,a)})});return d("MAWDexieTable").dexieAll([j,k]).then(function(){b.forEach(function(a){a==null&&d("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["OfflineBulkWriteAdminmsg - Missing thread when write e2ee thread description"])));var b=d("MAWAdminMsgTxns").buildE2EEThreadDescriptionMsg(a);a=d("MAWAdminMsgTxns").getUpdatedThreadForAdminMsg(b,a,i.get(a.jid));c.push(b);f.push(a);e.push({dbMsg:b,isFirstMsg:!1,updatedThread:a})});return{afterTransactionSyncMsgsData:e,e2eeThreadAdminMsgs:c,threadsToUpdate:f}})}function a(a,b,c){return j(a,b,c).then(function(a){var b=a.afterTransactionSyncMsgsData;a=a.threadsToUpdate;var c=new Map();b.forEach(function(a){var b=a.updatedThread.jid;c.set(b,{externalId:a.dbMsg.externalId,msgId:a.dbMsg.msgId})});return a.map(function(a){return{adminMsgParams:c.get(a.jid),thread:a}})})}function b(a,b,c){return j(a,b,c).then(function(a){var b=a.afterTransactionSyncMsgsData;a=a.threadsToUpdate;b.forEach(function(a){return d("MAWAfterWriteMsgUtil").writeMsgAfterTransaction(a)});return a})}function j(a,b,e){return i(a,b).then(function(b){var f=b.afterTransactionSyncMsgsData,g=b.e2eeThreadAdminMsgs,h=b.threadsToUpdate;e!=null&&d("MAWQplProxy").sendQplPointThroughBridge(c("qpl")._(25313175,"1551"),"write-bulk-admin-msgs-start",{instanceKey:e});return d("MAWDexieTable").dexieAll([a.messages.bulkAdd(g),a.threads.bulkPut(h)]).then(function(){e!=null&&d("MAWQplProxy").sendQplPointThroughBridge(c("qpl")._(25313175,"1551"),"write-bulk-admin-msgs-end",{instanceKey:e});return{afterTransactionSyncMsgsData:f,threadsToUpdate:h}})})}g.writeE2EEAdminMsgsForIncomingCreatedThreadsWithoutAfterTxns=a;g.writeE2EEAdminMsgsForIncomingCreatedThreadsWithAfterTxns=b}),98);
__d("MAWBuildIncomingMsgs",["MAWAckLevel","MAWDbMsg","MAWMsgType","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";var h=6*d("WATimeUtils").HOUR_SECONDS;function a(a,b){var c=a.author;a=a.externalId;return{ack:d("MAWAckLevel").ACK.received,altIndex:void 0,author:c,externalId:a,serverTs:b,ts:b,type:d("MAWMsgType").MSG_TYPE.CIPHERTEXT}}function b(a,b){var c=a.author;a=a.externalId;return{ack:d("MAWAckLevel").ACK.failed,altIndex:void 0,author:c,externalId:a,serverTs:b,ts:b,type:d("MAWMsgType").MSG_TYPE.UNAVAILABLE}}function c(a,b){var c;return{ack:a.ack,author:a.author,externalId:a.externalId,messageDeleteForMeTs:d("WATimeUtils").castToUnixTime(d("WATimeUtils").unixTime()+h),msgContent:(c=d("MAWDbMsg").getMsgContent(a))==null?void 0:c.content,threadJid:b.jid,ts:a.ts,type:d("MAWMsgType").MSG_TYPE.DELETE_FOR_ME}}function e(a,b,c){return{ack:a.ack,altIndex:void 0,author:a.author,externalId:c.externalId,msgContent:d("MAWDbMsg").getMsgContent(a),originalTs:a.ts,revokedExternalId:c.revokedExternalId,threadJid:b.jid,ts:c.ts,type:d("MAWMsgType").MSG_TYPE.REVOKED,unsendMsgContentDeleteTs:d("WATimeUtils").castToUnixTime(d("WATimeUtils").unixTime()+h)}}g.REVOKE_CONTENT_EXPIRATION_IN_SEC=h;g.buildUnstoredCiphertextMsg=a;g.buildUnstoredUnavailableMsg=b;g.buildUnstoredDeleteForMeMsg=c;g.buildUnstoredRevokedMsg=e}),98);
__d("MAWDbEditMsgHistoryTxns",["MAWAckLevel","MAWDbEditMsgHistory","MAWDexieTable","MAWVault","MWFBLogger","emptyFunction"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l=d("MWFBLogger").MWLogger().tags(["maw_db","txn","MAWDbEditMsgHistoryTxns"]);function a(a,b){var c=[];if(b.length===0)return d("MAWDexieTable").dexieResolve(c);b=b.filter(function(a){return a.editCount!=null&&a.editCount>0});var e=b.map(function(a){return[a.externalId,a.threadJid]});if(e.length===0)return d("MAWDexieTable").dexieResolve([]);var f=b.reduce(function(a,b){b.msgId!=null&&a.set(b.externalId,b.msgId);return a},new Map()),g=b.reduce(function(a,b){b.msgId!=null&&a.set(b.externalId,b);return a},new Map());return m(a,e).then(function(a){if(a.length===0){l.MUSTFIX(h||(h=babelHelpers.taggedTemplateLiteralLoose(["No edit history found for the messages despite there being an editCount greater than 0"])));return[]}for(a of a){var b=f.get(a.originalMsgExternalId);b!=null&&c.push(babelHelpers["extends"]({},a,{editMsgHistoryId:d("MAWDbEditMsgHistory").convertToEditMsgHistoryId64(a.editMsgHistoryId),originalMsgId:b}));b=g.get(a.originalMsgExternalId);b!=null&&(a.threadJid!==b.threadJid&&l.MUSTFIX(i||(i=babelHelpers.taggedTemplateLiteralLoose(["Edit history threadJid does not match original message threadJid"]))))}return c})}function m(a,b){return a.editMsgHistory.where(["originalMsgExternalId","threadJid"]).anyOf(b).toArray()}function b(a,b){return b==null?d("MAWDexieTable").dexieResolve():a.editMsgHistory.get({editMsgHistoryId:b})}function e(a,b,c){return a.editMsgHistory.where("originalMsgExternalId").equals(c).filter(function(a){return a.editExternalId===b.externalId&&a.author===b.author&&a.threadJid===b.chat}).toArray().then(function(a){if(a.length>1){var b=a.map(function(a){return""+a.editTs.toString()});b=new Set(b).size===1;!b?l.MUSTFIX(j||(j=babelHelpers.taggedTemplateLiteralLoose(["[getEditHistoryMsgByEditedProtocolMsgId] Can't have "," messages with the same editExternalId!"])),a.length):l.MUSTFIX(k||(k=babelHelpers.taggedTemplateLiteralLoose(["[getEditHistoryMsgByEditedProtocolMsgId] Suspected multiple instances of same message!"])))}return a[0]})}function f(a,b){return b==null?d("MAWDexieTable").dexieResolve([]):a.editMsgHistory.where("originalMsgExternalId").equals(b.externalId).filter(function(a){return a.author===b.author&&a.threadJid===b.chat}).toArray().then(function(a){var b=[];a.forEach(function(a){if(a==null)return;b.push(a)});return b})}function n(a,b){return a.editMsgHistory.bulkGet(b)}function o(a,b){return a.editMsgHistory.bulkAdd(b,{allKeys:!0}).then(function(a){return d("MAWDexieTable").dexieResolve(a)})}function p(a,b,c,d){return d.then(function(d){return q(a,b,c,d)})}function q(a,b,c,e){var f=[];return a.editMsgHistory.where("originalMsgExternalId").equals(b).filter(function(a){return a.threadJid===e&&a.author===c&&(a.sendStatus==null||a.sendStatus>=d("MAWAckLevel").ACK.sent)}).toArray().then(function(a){a.forEach(function(a){f.push({messageId:a.editExternalId,originalMessageId:a.originalMsgExternalId,text:d("MAWVault").unvault(a.msgContent.content),timestamp:a.editTs})});return f})}function r(a,b,d,e){return a.editMsgHistory.where("originalMsgExternalId").equals(b).filter(function(a){return a.threadJid===e&&a.author===d})["delete"]().then(c("emptyFunction"))}var s=function(a,b){return a.editMsgHistory.where(["originalMsgExternalId","threadJid"]).anyOf(b)["delete"]().then(function(){return d("MAWDexieTable").dexieResolve(b.length)})};function t(a,b,c){return a.editMsgHistory.put(babelHelpers["extends"]({},b,{msgContent:c.msgContent})).then(function(){})}g.loadEditMsgHistory=a;g.getEditHistoryByOriginalMsgExternalIdAndThreadJid=m;g.maybeGetEditMsgHistoryFromEditMsgHistoryId=b;g.getEditHistoryMsgByEditedProtocolMsgId=e;g.maybeGetEditMsgHistoryFromProtocolMsgId=f;g.bulkGetEditMsgHistorys=n;g.bulkAddEditMsgHistory=o;g.getEditHistoryAsEchoWithJidPromise=p;g.getEditHistoryAsEcho=q;g.bulkRemoveEditHistory=r;g.deleteExpiredEditMsgHistory=s;g.updateEditMsgHistoryWithNewIncomingMsg=t}),98);
__d("MAWDbPendingStanza",["WAAssertUnreachable"],(function(a,b,c,d,e,f,g){"use strict";var h="revoked",i="deleteForMe",j="deleteThread";b="Revoked";d="DeleteForMe";e="DeleteThread";f={DELETE_FOR_ME:d,DELETE_THREAD:e,REVOKED:b};function a(a){switch(a){case"Revoked":return h;case"DeleteForMe":return i;case"DeleteThread":return j;default:return c("WAAssertUnreachable")(a)}}g.PENDING_REVOKED=h;g.PENDING_DELETE_FOR_ME=i;g.REVOKED=b;g.DELETE_FOR_ME=d;g.PENDING_TYPE=f;g.getPendingSuffix=a}),98);
__d("MAWDeleteThreadUtil",[],(function(a,b,c,d,e,f){"use strict";function a(a){var b=[];a.forEach(function(a){if(a.pendingContent.type==="DeleteThread"){a=a.pendingContent.content.metaSyncMessageRange.lastMessageTimestamp;a!=null&&b.push(a)}});if(b.length===0)return null;b.sort(function(a,b){return b-a});a=b[0];return{lastMessageTimestamp:a}}function b(a,b){return b!=null&&b.lastMessageTimestamp>=a}f.getLatestDeleteThreadInfo=a;f.isMsgDeletedViaDeleteThread=b}),66);
__d("MAWMsgCleaner",["MAWLoggerUtils","MWFBLogger","Promise","WAAssertUnreachable","WAShiftTimer","WATimeUtils","WorkerScheduler","promiseDone"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k;a="Unsend";e="Ephemeral";f="DeleteForMe";var l="PendingStanza",m="Xma",n="IGDDM",o="Quote",p=d("MWFBLogger").MWLogger().tags([d("MAWLoggerUtils").Tag.MsgCleaner,d("MAWLoggerUtils").Tag.CleanerUpdate]);f={DELETE_FOR_ME:f,EPHEMERAL:e,IGDDM:n,PENDING_STANZA:l,QUOTE:o,UNSEND:a,XMA:m};var q;function r(){q==null&&(q=d("WorkerScheduler").makeScheduler("cleaner",{concurrency:1,maxTaskLimit:1,maxThrottleMs:8e3}));return q}e=function(){function a(a,b){var e=this;this.$1=new(d("WAShiftTimer").ShiftTimer)(function(){c("promiseDone")(e.$2())});this.getNextTs=a.getNextTs;this.removeExpired=a.removeExpired;this.cleanerType=b;this.purgeEnabled=a.purgeEnabled;this.$1.forceRunNow()}var e=a.prototype;e.update=function(a){var b=s(this.cleanerType);p.DEBUG(h||(h=babelHelpers.taggedTemplateLiteralLoose(["","::update ",""])),b,a);this.$1.onOrBefore(d("WATimeUtils").cappedMillisecondsUntil(a))};e.$2=function(){var a=this,c=function(){if(!a.purgeEnabled())return(k||(k=b("Promise"))).resolve();var c=s(a.cleanerType);p.DEBUG(i||(i=babelHelpers.taggedTemplateLiteralLoose(["","::_purgeNow"])),c);return a.removeExpired().then(function(b){b>0&&p.DEBUG(j||(j=babelHelpers.taggedTemplateLiteralLoose(["","::_purgeNow "," msgs' content cleaned"])),c,b);return a.getNextTs()}).then(function(b){b!=null&&a.update(b)})};if(this.$3!=null)return(k||(k=b("Promise"))).resolve();this.$3=r().task({fn:c,name:this.cleanerType,priority:d("WorkerScheduler").BACKGROUND_PRIORITY});return this.$3.run()["finally"](function(){a.$3=null})};return a}();function s(a){switch(a){case"Unsend":return"UnsendMsgCleaner";case"Ephemeral":return"EphemeralCleaner";case"DeleteForMe":return"DeleteForMeCleaner";case"PendingStanza":return"PendingStanzaCleaner";case"Xma":return"XmaCleaner";case"IGDDM":return"IGDDisappearingMsgCleaner";case"Quote":return"QuoteCleaner";default:return c("WAAssertUnreachable")(a)}}n=e;g.CLEANER_TYPE=f;g.MsgCleaner=e;g.MSG_CLEANER_FOR_TESTING_ONLY=n}),98);
__d("MAWPendingStanzaCleaner",["FBLogger","MAWMsgCleaner","WALogger"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j=null;function a(a){j==null&&(j=new(d("MAWMsgCleaner").MsgCleaner)(a,d("MAWMsgCleaner").CLEANER_TYPE.PENDING_STANZA))}function b(a){if(j==null){var b="Trying to add new PendingStanzaCleanerTimestamp before the cleaner is initialized!";d("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["",""])),b);throw c("FBLogger")("messenger_web").mustfixThrow(b)}else d("WALogger").DEV(i||(i=babelHelpers.taggedTemplateLiteralLoose(["PendingStanzaCleaner: Adding timestamps (",")"])),a),j.update(a)}function e(){return j}function f(){j=null}g.startPendingStanzaCleaner=a;g.addNewPendingStanzaCleanerTimestamp=b;g.getPendingStanzaCleaner_FOR_TESTING_ONLY=e;g.resetPendingStanzaCleaner_FOR_TESTING_ONLY=f}),98);
__d("MAWDbPendingStanzaTxns",["MAWDbPendingStanza","MAWDeleteThreadUtil","MAWPendingStanzaCleaner","WAJids","WATimeUtils","emptyFunction"],(function(a,b,c,d,e,f,g){"use strict";function h(a,b,c,e,f){var g=d("MAWDbPendingStanza").getPendingSuffix(f);return a.pendingStanzas.where("externalIdWithType").equals(b+"_"+g).filter(function(a){a=a.pendingContent;return a.type===f&&a.content.author===c&&a.content.threadJid===e}).first()}function a(a,b,c,e){return h(a,b,c,e,d("MAWDbPendingStanza").PENDING_TYPE.REVOKED)}function b(a,b,c,e){return h(a,b,c,e,d("MAWDbPendingStanza").PENDING_TYPE.DELETE_FOR_ME)}function e(a,b){var e=b.map(function(a){a=a.expirationInSeconds;return d("WATimeUtils").castToUnixTime(d("WATimeUtils").unixTime()+a)});b=b.map(function(a,b){var c=a.content,f=a.externalId;a=a.pendingStanzaType;return{deleteTs:e[b],externalIdWithType:f+"_"+d("MAWDbPendingStanza").getPendingSuffix(a),pendingContent:c}});return a.pendingStanzas.bulkAdd(b).then(function(){return e.forEach(d("MAWPendingStanzaCleaner").addNewPendingStanzaCleanerTimestamp)}).then(c("emptyFunction"))}function f(a,b,c,e,f){f=d("MAWDbPendingStanza").getPendingSuffix(f);var g=d("WATimeUtils").castToUnixTime(d("WATimeUtils").unixTime()+c);c={deleteTs:g,externalIdWithType:e+"_"+f,pendingContent:b};return a.pendingStanzas.add(c).then(function(){d("MAWPendingStanzaCleaner").addNewPendingStanzaCleanerTimestamp(g)})}function i(a,b){var c=d("MAWDbPendingStanza").getPendingSuffix(d("MAWDbPendingStanza").PENDING_TYPE.DELETE_THREAD);return a.pendingStanzas.where("externalIdWithType").equals(b+"_"+c).toArray().then(function(a){return d("MAWDeleteThreadUtil").getLatestDeleteThreadInfo(a)})}function j(a){return a.pendingStanzas.toArray()}function k(a,b){b=b.map(function(a){return a.rowId});return a.pendingStanzas.bulkDelete(b)}function l(a){var b,c;return(a==null||(b=a.pendingContent)==null?void 0:b.type)===d("MAWDbPendingStanza").PENDING_TYPE.REVOKED?a==null||(c=a.pendingContent)==null?void 0:c.content:null}function m(a,b){var c=d("MAWDbPendingStanza").getPendingSuffix(d("MAWDbPendingStanza").PENDING_TYPE.DELETE_THREAD);b=b.map(function(a){return a+"_"+c});return a.pendingStanzas.where("externalIdWithType").anyOf(b).toArray().then(function(a){a=a.reduce(function(a,b){var c=a.get(b.externalIdWithType);c==null?a.set(b.externalIdWithType,[b]):c.push(b);return a},new Map());var b=new Map();a.forEach(function(a,c){c=d("WAJids").unsafeCoerceToChatJid(c.split("_")[0]);a=d("MAWDeleteThreadUtil").getLatestDeleteThreadInfo(a);a!=null&&b.set(c,a)});return b})}g.maybeGetPendingStanzaByExternalId=h;g.maybeGetPendingRevokedStanza=a;g.maybeGetPendingDeletedStanza=b;g.bulkPutPendingStanzas=e;g.putPendingStanza=f;g.maybeGetDeleteThreadFromPendingStanza=i;g.getAllPendingStanzas=j;g.deletePendingStanzas=k;g.getRevokedContent=l;g.bulkGetDeleteThreadPendingStanzas=m}),98);
__d("MAWDeleteForMeMsgContentCleaner",["FBLogger","MAWMsgCleaner","WALogger"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j=null;function a(a){j==null&&(j=new(d("MAWMsgCleaner").MsgCleaner)(a,d("MAWMsgCleaner").CLEANER_TYPE.DELETE_FOR_ME))}function b(a){if(j==null){var b="Trying to add new DeleteForMeContentCleanerTimestamp before the cleaner is initialized!";d("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["",""])),b);throw c("FBLogger")("messenger_web").mustfixThrow(b)}else d("WALogger").DEV(i||(i=babelHelpers.taggedTemplateLiteralLoose(["DeleteForMeMsgContentCleaner: Adding timestamps (",")"])),a),j.update(a)}function e(){return j}function f(){j=null}g.startDeleteForMeMsgContentCleaner=a;g.addNewDeleteForMeMsgContentCleanerTimestamp=b;g.getDeleteForMeMsgContentCleaner_FOR_TESTING_ONLY=e;g.resetDeleteForMeMsgContentCleaner_FOR_TESTING_ONLY=f}),98);
__d("MAWBridgeMsgCountdown",["MAWDbMsg","MAWLoggerUtils","MWFBLogger","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j=d("MWFBLogger").MWLogger().tags(["bridge",d("MAWLoggerUtils").Tag.Countdown]);function a(a){return{msgs:a.map(function(a){var b,c=a.messageExpirationTs;b=(b=a.ephemeralSetting)==null?void 0:b.ephemeralExpirationInSec;if(c==null||b==null)return;var e=d("WATimeUtils").cappedMillisecondsUntil(c);if(e<=0){j.DEBUG(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Calling the messages starting countdown bridge event with remaning time less or equal to 0 (expired message)"])));return}var f=b*1e3;e>f&&(e=f);j.DEBUG(i||(i=babelHelpers.taggedTemplateLiteralLoose(["createBridgeMsgsStartCountdown: msg ",", expiration ",", ms until countdown ",", duration ",""])),a.msgId,c,e,b);return{countdownTs:c,millisecondsUntilCountdownTs:e,msgId:a.msgId,threadJid:a.threadJid,ts:d("MAWDbMsg").getCanonicalTsFromMsg(a)}}).filter(Boolean)}}function b(a,b){return{countdownTs:b,msgId:a}}g.createBridgeMsgsStartCountdown=a;g.createBridgeMsgClearCountdown=b}),98);
__d("MAWEphemeralCleaner",["MAWLoggerUtils","MAWMsgCleaner","MWFBLogger"],(function(a,b,c,d,e,f,g){"use strict";var h,i=null,j=d("MWFBLogger").MWLogger().tags([d("MAWLoggerUtils").Tag.Ephemeral,d("MAWLoggerUtils").Tag.MsgCleaner,d("MAWLoggerUtils").Tag.CleanerTimestamp,"backend"]);function a(a){var b=a.expiryFns;a=a.purgeDeletionsFns;if(i==null){var c;i={expiry:new((c=d("MAWMsgCleaner")).MsgCleaner)(b,c.CLEANER_TYPE.EPHEMERAL),purgeDeletions:new c.MsgCleaner(a,c.CLEANER_TYPE.EPHEMERAL)}}}function b(a,b){if(i==null)throw j.mustfixThrow("Trying to add new ephemeral timestamp before the cleaner is initialized!");else{var c=i,d=c.expiry;c=c.purgeDeletions;j.DEBUG(h||(h=babelHelpers.taggedTemplateLiteralLoose(["EphemeralCleaner: Adding timestamps for expiry(",") and deletion(",")"])),a,b);d.update(a);c.update(b)}}function c(){return i}function e(){i=null}g.startEphemeralCleaner=a;g.addNewEphemeralTimestamp=b;g.getEphemeralCleaner_FOR_TESTING_ONLY=c;g.resetEphemeralCleaner_FOR_TESTING_ONLY=e}),98);
__d("MAWEphemeralSettingsCache",["MAWBridge","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";var h=new Map();function i(a,b){h.set(a,b)}function a(a){var b={ephemeralExpirationInSec:0,ephemeralLastUpdatedOrSetTimestamp:d("WATimeUtils").castToUnixTime(0)};return(a=h.get(a))!=null?a:b}async function b(a){var b={ephemeralExpirationInSec:0,ephemeralLastUpdatedOrSetTimestamp:d("WATimeUtils").castToUnixTime(0)};if(!h.has(a)){var c=await d("MAWBridge").getBridge().sendAndReceive("event","getLSDBEphemeralSetting",{chatJid:a});i(a,c!=null?c:b)}}g.setEphemeralSettingCache=i;g.getEphemeralSettingCache=a;g.requestLSDBCacheForJid=b}),98);
__d("MAWEphemeralUtil",["FBLogger","MAWAckLevel","MAWBridgeMsgCountdown","MAWExternalId","MAWIndexedDb","MAWLocalizationType","MAWMsgType","WAArmadilloApplication.pb","WAJids","WALogger"],(function(a,b,c,d,e,f,g){"use strict";var h,i;function a(a,b){var c=b.ephemeralExpirationInSec!==a.ephemeralExpirationInSec&&b.ephemeralLastUpdatedOrSetTimestamp===a.ephemeralLastUpdatedOrSetTimestamp;return c||a.ephemeralLastUpdatedOrSetTimestamp>b.ephemeralLastUpdatedOrSetTimestamp}function b(a,b,c){if(a==null)return!0;a=a.ephemeralSetting;if(a!=null&&a.ephemeralExpirationInSec===b){d("WALogger").DEV(h||(h=babelHelpers.taggedTemplateLiteralLoose(["New ephemeral duration should be different from the existing duration"])));return!1}if(a!=null&&a.ephemeralLastUpdatedOrSetTimestamp>c){d("WALogger").DEV(i||(i=babelHelpers.taggedTemplateLiteralLoose(["The new ephemeral setting timestamp should be greater than the existing timestamp"])));return!1}return!0}function e(a){a={ack:d("MAWAckLevel").ACK.sent,altIndex:void 0,author:d("WAJids").AUTHOR_SYSTEM,externalId:d("MAWExternalId").generateExternalId(),msgContent:{adminMsgContent:[],adminType:d("MAWLocalizationType").LOCALIZATION_TYPE.YOU_EPHEMERAL_SETTING_CHANGE_MINUTES},ts:a,type:d("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_ADMIN};return{unstoredDbMedia:null,unstoredDbMsg:a,unstoredDbReaction:null}}function f(a,b){var e;switch(b){case d("WAArmadilloApplication.pb").ARMADILLO_CONTENT_SCREENSHOT_ACTION_SCREENSHOT_TYPE.SCREENSHOT_IMAGE:e=d("WAArmadilloApplication.pb").ARMADILLO_CONTENT_SCREENSHOT_ACTION_SCREENSHOT_TYPE.SCREENSHOT_IMAGE;break;case d("WAArmadilloApplication.pb").ARMADILLO_CONTENT_SCREENSHOT_ACTION_SCREENSHOT_TYPE.SCREEN_RECORDING:e=d("WAArmadilloApplication.pb").ARMADILLO_CONTENT_SCREENSHOT_ACTION_SCREENSHOT_TYPE.SCREEN_RECORDING;break;default:throw c("FBLogger")("messenger_web").mustfixThrow("Received unexpected screenshot action type")}b={ack:d("MAWAckLevel").ACK.sent,altIndex:void 0,author:d("WAJids").AUTHOR_SYSTEM,externalId:d("MAWExternalId").generateExternalId(),msgContent:{adminMsgContent:[],adminType:d("MAWLocalizationType").LOCALIZATION_TYPE.YOU_EPHEMERAL_TAKE_SCREENSHOT,screenshotActionType:e},ts:a,type:d("MAWMsgType").MSG_TYPE.EPHEMERAL_SCREENSHOT_ACTION};return{unstoredDbMedia:null,unstoredDbMsg:b,unstoredDbReaction:void 0}}function j(a){return d("WAJids").switchOnMsgrChatJidType(a,{group:function(a){throw c("FBLogger")("messenger_web").mustfixThrow("Received invalid chatJid. We only support ephemeral messaging in 1:1 threads.")},user:function(a){return a}})}function k(a){a!=null&&a.messageExpirationTs!=null&&a.ephemeralCounterStarted===!0&&d("MAWIndexedDb").afterTransaction({tag:"MsgClearCountdown",value:d("MAWBridgeMsgCountdown").createBridgeMsgClearCountdown(a.msgId,a.messageExpirationTs)})}g.isLocalSettingOutdated=a;g.shouldUpdateForOutgoingUserEphemeralSettingChange=b;g.buildUnstoredDbEphemeralSettingMsgWithoutContentPlaceholder=e;g.buildUnstoredDbEphemeralScreenshotActionMsgWithoutContentPlaceholder=f;g.getUserJidForEphemeralSetting=j;g.maybeClearEphemeralMsgCountdown=k}),98);
__d("MAWEphemeralSettingsTxns",["DateConsts","MAWDbThreadTxns","MAWDexieTable","MAWEphemeralSettingsCache","MAWEphemeralUtil","MAWIndexedDb","MAWLoggerUtils","MAWUserJidWrapper","MWFBLogger","WAJids","WAResultOrError","WATimeUtils","emptyFunction"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l,m,n,o,p=d("MWFBLogger").MWLogger().tags(["maw_db","txn",(o=d("MAWLoggerUtils")).Tag.Ephemeral,o.Tag.SettingChange,o.Tag.Incoming]),q=d("MWFBLogger").MWLogger().tags(["maw_db","txn",o.Tag.Ephemeral,o.Tag.SettingChange,o.Tag.Outgoing]),r=null,s=90*d("DateConsts").SEC_PER_DAY;function a(a,b,c,e,f,g,l,m,n){if(c<0||c>s){l=d("WAJids").interpretAndValidateJid(g.jid).toString();throw p.mustfixThrow("EphemeralSetting duration is invalid "+c+", jidType: "+l)}m={ephemeralExpirationInSec:c,ephemeralLastUpdatedOrSetTimestamp:e};p.DEBUG(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Handle Incoming Ephemeral Setting duration: ",", lastUpdated: ",". Thread: ",", Author: ",""])),c,e,String(g),b);l=d("WAJids").interpretAsUserJid(g.jid);if(l==null){p.MUSTFIX(i||(i=babelHelpers.taggedTemplateLiteralLoose(["Received invalid chat jid for incoming ephemeral settings"])));return d("MAWDexieTable").dexieResolve(r)}c=d("WAJids").isAuthorMe(b)?d("MAWUserJidWrapper").getMyUserJid():b;b=d("MAWEphemeralSettingsCache").getEphemeralSettingCache(g.jid);var o=b==null?void 0:b.ephemeralExpirationInSec,q=b==null?void 0:b.ephemeralLastUpdatedOrSetTimestamp;if(n){if(b!=null&&!d("MAWEphemeralUtil").isLocalSettingOutdated(m,b))if(e!==q){p.DEBUG(j||(j=babelHelpers.taggedTemplateLiteralLoose(["Sending Sync Response with duration ",", timestamp ",""])),o,q);return d("MAWDexieTable").dexieResolve({outOfSyncEphemeralSetting:{chatJid:g.jid,correctEphemeralExpirationInSec:b.ephemeralExpirationInSec,correctEphemeralLastUpdatedOrSetTimestamp:b.ephemeralLastUpdatedOrSetTimestamp}})}else{p.DEBUG(k||(k=babelHelpers.taggedTemplateLiteralLoose(["Ephemeral setting in sync"])));return d("MAWDexieTable").dexieResolve(r)}d("MAWIndexedDb").afterTransaction({tag:"EphemeralSettingsUpdatedForUI",value:{author:d("WAJids").userIdFromJid(c),chatJid:g.jid,ephemeralSettingArgs:m,isEphemeralSettingReset:f}});return d("MAWDexieTable").dexieResolve(r)}n={ephemeralSetting:m,ephemeralSyncResponseBackoffInfo:void 0,userJid:l};return a.ephemeralSettings.put(n).then(function(){return r})}function b(a,b,c,e,f){var g=c;if(g<0)throw q.mustfixThrow("Ephemeral duration should be 0 or more");var h=d("MAWEphemeralUtil").getUserJidForEphemeralSetting(b);return d("MAWDbThreadTxns").getThread(a,b).then(function(b){return!b.success?d("WAResultOrError").makeResult({shouldUpdateSetting:!1}):a.ephemeralSettings.get({userJid:h}).then(function(b){if(!d("MAWEphemeralUtil").shouldUpdateForOutgoingUserEphemeralSettingChange(b,g,e))return d("WAResultOrError").makeResult({shouldUpdateSetting:!1});b=b==null?{ephemeralSetting:{ephemeralExpirationInSec:g,ephemeralLastUpdatedOrSetTimestamp:e},userJid:h}:babelHelpers["extends"]({},b,{ephemeralSetting:{ephemeralExpirationInSec:g,ephemeralLastUpdatedOrSetTimestamp:e}});return a.ephemeralSettings.put(b).then(function(){return d("WAResultOrError").makeResult({shouldUpdateSetting:!0})})})})}function e(a,b,e){var f=d("MAWEphemeralUtil").getUserJidForEphemeralSetting(b);return a.ephemeralSettings.get({userJid:f}).then(function(b){if(b==null||b.ephemeralSetting==null){q.MUSTFIX(l||(l=babelHelpers.taggedTemplateLiteralLoose(["Contact "," "," and ephemeral setting "," should not be null when receiving the server ack for outgoing ephemeral setting change"])),f,String(b),String(b==null?void 0:b.ephemeralSetting));throw q.mustfixThrow("Contact and ephemeral setting should not be null when receiving the server ack for outgoing ephemeral setting change")}b=babelHelpers["extends"]({},b,{ephemeralSetting:{ephemeralExpirationInSec:b.ephemeralSetting.ephemeralExpirationInSec,ephemeralLastUpdatedOrSetTimestamp:e}});return a.ephemeralSettings.put(b).then(c("emptyFunction"))})}function f(a,b){a=d("WAJids").interpretAsUserJid(b);a==null&&q.mustfixThrow("Unexpected chatJid input to isEphemeralMessagesEnabledForContact");a=d("MAWEphemeralSettingsCache").getEphemeralSettingCache(b);if(a.ephemeralLastUpdatedOrSetTimestamp===d("WATimeUtils").castToUnixTime(0))return d("MAWDexieTable").dexieResolve(d("WAResultOrError").makeError("no_ephemeral_setting"));return a!=null&&a.ephemeralExpirationInSec>0?d("MAWDexieTable").dexieResolve(d("WAResultOrError").makeResult({outOfSyncEphemeralSetting:{chatJid:b,correctEphemeralExpirationInSec:a.ephemeralExpirationInSec,correctEphemeralLastUpdatedOrSetTimestamp:a.ephemeralLastUpdatedOrSetTimestamp}})):d("MAWDexieTable").dexieResolve(d("WAResultOrError").makeError("no_ephemeral_setting"))}function t(a,b){return a.ephemeralSettings.get({userJid:b}).then(function(c){if((c==null?void 0:c.ephemeralSyncResponseBackoffInfo)==null){p.DEBUG(m||(m=babelHelpers.taggedTemplateLiteralLoose(["maybeResetEphemeralSyncResponseBackoffInfo no op for ",""])),b);return d("WAResultOrError").makeResult()}c.ephemeralSyncResponseBackoffInfo=void 0;p.DEBUG(n||(n=babelHelpers.taggedTemplateLiteralLoose(["maybeResetEphemeralSyncResponseBackoffInfo reset for ",""])),b);return a.ephemeralSettings.put(c).then(function(){return d("WAResultOrError").makeResult()})})}g.handleAndWriteIncomingEphemeralSetting=a;g.handleAndWriteOutgoingUserEphemeralSettingChange=b;g.updateContactWhenEphemeralSettingChangeMarkedSent=e;g.getOutOfSyncEphemeralSettingForIncomingNonEphemeralMsg=f;g.maybeResetEphemeralSyncResponseBackoffInfo=t}),98);
__d("MAWEphemeralMsgTxns",["EBLogger","MAWBridgeMsgCountdown","MAWDbMsg","MAWDbMsgTxns","MAWDbThreadTxns","MAWDbXMATxns","MAWDexieTable","MAWEphemeralCleaner","MAWEphemeralConsts","MAWEphemeralMsgUtils","MAWEphemeralSettingsTxns","MAWIndexedDb","MAWLoggerUtils","MAWODSProxy","MAWThreadSnippetUtils","MWFBLogger","WAJids","WAOdsEnums","WATimeUtils","emptyFunction"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l,m,n=d("MWFBLogger").MWLogger().tags([(f=d("MAWLoggerUtils")).Tag.Ephemeral,f.Tag.SettingSync,f.Tag.Incoming]),o=d("MWFBLogger").MWLogger().tags([f.Tag.Ephemeral,f.Tag.OnRead,f.Tag.Countdown]);function p(a,b,c){c===void 0&&(c=function(){return!0});return d("MAWDbMsgTxns").getThreadMessagesBySortOrder(a,b,!1,!0).filter(c).limit(1).toArray().then(function(a){return{needsUpdate:!0,value:(a=a[0])!=null?a:null}})}function q(a,b,c){return c.size===0?d("MAWDexieTable").dexieResolve():d("MAWDbThreadTxns").getThread(a,b).then(function(b){if(!b.success)return;var e=b.value;return d("MAWDexieTable").dexieAll([d("MAWDbMsgTxns").getThreadOldestMessageId(a,e.jid),d("MAWDbMsgTxns").getThreadNewestMessageId(a,e.jid)]).then(function(b){var f=b[0],g=b[1];if(f==null||g==null)return;b=d("MAWEphemeralMsgUtils").filterNonExpiredMsg(c);var h=c.has(f)?p(a,e.jid,b):d("MAWDexieTable").dexieResolve({needsUpdate:!1});b=c.has(g)?d("MAWDbMsgTxns").getThreadMessagesBySortOrder(a,e.jid,!0,!1).filter(b).reverse().limit(1).toArray().then(function(b){b=b[0];return b!=null&&d("MAWThreadSnippetUtils").isDbMsgDisabledForThreadSnippet(b)?d("MAWThreadSnippetUtils").recalculateSnippetFromScratch_EXPENSIVE(a,e,c).then(function(a){return{needsUpdate:!0,value:a!=null?a:null}}):{needsUpdate:!0,value:b!=null?b:null}}):d("MAWDexieTable").dexieResolve({needsUpdate:!1});return d("MAWDexieTable").dexieAll([h,b]).then(function(b){var c,h=b[0];b=b[1];if(!h.needsUpdate&&!b.needsUpdate)return;c=b.needsUpdate?(c=(c=b.value)==null?void 0:c.msgId)!=null?c:void 0:g;b=b.needsUpdate?b.value!=null?d("WATimeUtils").castUnixTimeToMillisTime(d("MAWDbMsg").getCanonicalTsFromMsg(b.value)):void 0:e.snippetMsgTs;h=babelHelpers["extends"]({},e,{oldestMsg:h.needsUpdate?(h=(h=h.value)==null?void 0:h.msgId)!=null?h:null:f,snippetMsg:c,snippetMsgTs:b});a.threads.put(h)})})})}function a(a,b,c){c===void 0&&(c=!0);if(b==null||b.ephemeralSetting==null||b.ephemeralSetting.ephemeralExpirationInSec===0)return d("MAWDexieTable").dexieResolve(b);var e=d("WATimeUtils").castToUnixTime(b.ts+b.ephemeralSetting.ephemeralExpirationInSec),f=d("WATimeUtils").castToUnixTime(e+d("MAWEphemeralConsts").ephemeralReportingWindowInSeconds);b.ebTimestampMs!=null&&(d("EBLogger").EBLogger().tags(["eb_restore"]).WARN(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Delete DM backup - S472027 follow up"]))),d("MAWODSProxy").odsBumpEntityKey({entity:d("WAOdsEnums").Entity.EB_RESTORE,key:"restore_dm_s472027"}));return r(a,[{messageDeleteTs:f,messageExpirationTs:e,msgId:b.msgId,readTsForLogging:b.ts}]).then(function(a){var b=a[0],e=a[1];a=a[2];a.length>0&&(o.DEBUG(i||(i=babelHelpers.taggedTemplateLiteralLoose(["markEphemeralMessageAsSent EphemeralCounter: Showing UI counter for ",""])),String(a.map(function(a){return a.msgId}))),c&&d("MAWIndexedDb").afterTransaction({tag:"MsgsStartCountdown",value:d("MAWBridgeMsgCountdown").createBridgeMsgsStartCountdown(a)}));b!=null&&e!=null&&d("MAWEphemeralCleaner").addNewEphemeralTimestamp(b,e);return a[0]})}function r(a,b){var c=b.map(function(a){return a.msgId});return d("MAWDbXMATxns").getXMAMsgIdsFromAssociatedMsgIds(a,c).then(function(d){var e=new Map();b.forEach(function(a){e.set(a.msgId,{messageDeleteTs:a.messageDeleteTs,messageExpirationTs:a.messageExpirationTs,readTsForLogging:a.readTsForLogging});var b=d.get(a.msgId);b!=null&&e.set(b,{messageDeleteTs:a.messageDeleteTs,messageExpirationTs:a.messageExpirationTs,readTsForLogging:a.readTsForLogging})});var f=null,g=null,h=[],i=Array.from(new Set(c.concat(Array.from(d.values()))));return a.messages.where("msgId").anyOf(i).toArray().then(function(b){if(b.length===0)return;b.forEach(function(a){var b=a.messageExpirationTs,c=a.messageDeleteTs,d=e.get(a.msgId),i=d==null?void 0:d.messageExpirationTs;d=d==null?void 0:d.messageDeleteTs;o.DEBUG(j||(j=babelHelpers.taggedTemplateLiteralLoose(["updating ephemeral timestamp msg ",", existing expiration ",", existing deletion ",", updated expiration ",", updated deletion ",""])),a.msgId,b,c,i,d);if(i==null||d==null)return;if(a.ephemeralCounterStarted===!0)return;f==null?f=i:i<f&&(f=i);g==null?g=d:d<g&&(g=d);b=babelHelpers["extends"]({},a,{ephemeralCounterStarted:!0,messageDeleteTs:d,messageExpirationTs:i});h.push(b)});return a.messages.bulkPut(h)}).then(function(){return[f,g,h]})})}function b(a,b){if(b.size===0)return d("MAWDexieTable").dexieResolve();var e=[];b.forEach(function(b,c){e.push(q(a,c,b))});return d("MAWDexieTable").dexieAll(e).then(c("emptyFunction"))}function e(a,b,e,f,g){if(b==null)return d("MAWDexieTable").dexieResolve();n.DEBUG(k||(k=babelHelpers.taggedTemplateLiteralLoose(["maybeUpdateEphemeralSettingOrCheckOutOfSyncAfterWritingIncomingMsg: Message from ",", chat ",", type ",""])),e,f.jid,b.type);var h=d("MAWDexieTable").dexieResolve();if(b.ephemeralSetting==null)d("WAJids").switchOnMsgrChatJidType(f.jid,{group:function(){return d("MAWEphemeralSettingsTxns").maybeResetEphemeralSyncResponseBackoffInfo(a,e).then(c("emptyFunction"))},user:function(){d("MAWDbMsg").isMsgEligibleForTriggeringEphemeralSyncResponse(b)&&(h=d("MAWEphemeralSettingsTxns").getOutOfSyncEphemeralSettingForIncomingNonEphemeralMsg(a,f.jid).then(function(a){var b;return a==null||(b=a.value)==null?void 0:b.outOfSyncEphemeralSetting}))}});else if(b.messageExpirationTs!=null&&b.messageDeleteTs!=null){var i=b.ephemeralSetting,j=b.messageDeleteTs,o=b.messageExpirationTs;n.DEBUG(l||(l=babelHelpers.taggedTemplateLiteralLoose(["incoming msg is ephemeral: duration ",", timestamp ",""])),i.ephemeralExpirationInSec,i.ephemeralLastUpdatedOrSetTimestamp);d("MAWEphemeralCleaner").addNewEphemeralTimestamp(o,j);h=d("MAWEphemeralSettingsTxns").handleAndWriteIncomingEphemeralSetting(a,e,i.ephemeralExpirationInSec,i.ephemeralLastUpdatedOrSetTimestamp,!1,f,g,null,!0).then(function(a){return a==null?void 0:a.outOfSyncEphemeralSetting})}return h.then(function(b){if(b!=null)n.DEBUG(m||(m=babelHelpers.taggedTemplateLiteralLoose(["incoming msg is out of sync: correct duration ",", correct timestamp ",""])),b.correctEphemeralExpirationInSec,b.correctEphemeralLastUpdatedOrSetTimestamp);else return d("MAWEphemeralSettingsTxns").maybeResetEphemeralSyncResponseBackoffInfo(a,e).then(c("emptyFunction"))})}g.markEphemeralMessageAsSent=a;g.bulkUpdateEphemeralMessageTimestamps=r;g.updateThreadsOnMessagesExpiredFromUi=b;g.syncEphemeralSettingOnIncomingMsg=e}),98);
__d("MAWExpiredQuoteCleaner",["FBLogger","MAWMsgCleaner","WALogger"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j=null;function a(a){j==null&&(j=new(d("MAWMsgCleaner").MsgCleaner)(a,d("MAWMsgCleaner").CLEANER_TYPE.QUOTE))}function b(a){if(j==null){var b="Trying to add new addNewExpiredQuoteCleanerTimestamp before the cleaner is initialized!";d("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["",""])),b);throw c("FBLogger")("messenger_web").mustfixThrow(b)}else d("WALogger").DEV(i||(i=babelHelpers.taggedTemplateLiteralLoose(["ExpiredQuoteCleaner: Adding timestamps backend(",")"])),a),j.update(a)}function e(){return j}function f(){j=null}g.startExpiredQuoteCleaner=a;g.addNewExpiredQuoteCleanerTimestamp=b;g.getExpiredQuoteCleaner_FOR_TESTING_ONLY=e;g.resetExpiredQuoteCleaner_FOR_TESTING_ONLY=f}),98);
__d("isWAFTSContentSearchEnabled",["isE2EEConversationSearchEnabled","isMAWUniversalSearchEnabled"],(function(a,b,c,d,e,f,g){"use strict";function a(){return c("isE2EEConversationSearchEnabled")()||c("isMAWUniversalSearchEnabled")()}g["default"]=a}),98);
__d("MAWFTSTxns",["MAWDexieTable","isWAFTSContentSearchEnabled","justknobx"],(function(a,b,c,d,e,f,g){"use strict";var h=c("justknobx")._("1146");function a(a,b){return!c("isWAFTSContentSearchEnabled")()?d("MAWDexieTable").dexieResolve(null):a.ftsPurgeBacklog.put({externalId:b})}function b(a,b){return!c("isWAFTSContentSearchEnabled")()||!h?d("MAWDexieTable").dexieResolve(null):a.ftsBackloggedMessages.put({rowId:b})}function e(a,b){return!c("isWAFTSContentSearchEnabled")()||!h?d("MAWDexieTable").dexieResolve(null):a.ftsBackloggedMessages.bulkPut(b.map(function(a){return{rowId:a}}))}function f(a,b){return!c("isWAFTSContentSearchEnabled")()?d("MAWDexieTable").dexieResolve(null):a.ftsPurgeThreadBacklog.put({chatJid:b})}g.maybePutMessageToPurgeBacklog=a;g.maybePutMessageToBacklog=b;g.maybePutMessagesToBacklog=e;g.maybePutThreadToPurgeBacklog=f}),98);
__d("MAWBridgeUpload",["MAWMainTraceUtils"],(function(a,b,c,d,e,f,g){"use strict";function a(a){var b=a.actionType,c=a.attachmentContext,d=a.attachmentContextArray,e=a.authTs,f=a.echoDocument,g=a.echoEncodingLatencyNs,i=a.errorCode,j=a.errorMessage,k=a.messageId,l=a.messageType,m=a.productType,n=a.protoMsg,o=a.sortOrderMs,p=a.threadId,q=a.traceId;a=a.uploadTrackingInstanceKey;c=h(c,m!=null?m:"msgr",d);return{actionType:b,attachmentBackupContext:c,authTs:e,echoDocument:f,echoEncodingLatencyNs:g,errorCode:i,errorMessage:j,messageId:k,messageType:l,protoMsg:n,sortOrderMs:o,threadId:p,traceId:q,uploadTrackingInstanceKey:a}}function b(a,b,c,d,e,f){return{actionType:f,echoDocument:e,folderType:b,threadId:a,transportKey:c,ts:d}}function c(a,b,c,d,e,f,g,h){return{deliveryObjectId:a,mediaType:b,messageId:c,productType:d,threadId:e,threadJid:f,traceId:h,ts:g}}function h(a,b,c){if(c==null)return void 0;else{a=c.map(function(a){return{attachmentTraceId:d("MAWMainTraceUtils").createTraceId(),mediaType:a.mediaType,zippyObjectId:a.mediaObjectId}});c={attachmentInfos:a,productType:b};return c}}g.createBridgeUploadMessage=a;g.createBridgeDeleteMessagesOfThread=b;g.createBridgeUploadAttachment=c;g.createBridgeUploadAttachmentBackupContext=h}),98);
__d("MAWUploadThreadTxns",["$InternalEnum","MAWFolderTypes"],(function(a,b,c,d,e,f,g){"use strict";var h=b("$InternalEnum")({INBOX:0,PENDING:1,OTHER:2,SPAM:3,ARCHIVED:4,HIDDEN:5});function i(a){switch(a){case d("MAWFolderTypes").FOLDER_ID.INBOX:return h.INBOX;case d("MAWFolderTypes").FOLDER_ID.PENDING:return h.PENDING;case d("MAWFolderTypes").FOLDER_ID.ARCHIVED:return h.ARCHIVED;default:return h.INBOX}}function a(a){return i(a).toString()}g.FolderType=h;g.getFolderTypeAsText=a}),98);
__d("MpsDeletedCleaner",["FBLogger","MAWMsgCleaner","WALogger"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j=null;function a(a){j==null&&(j=new(d("MAWMsgCleaner").MsgCleaner)(a,d("MAWMsgCleaner").CLEANER_TYPE.UNSEND))}function b(a){if(j==null){var b="Trying to add new MpsDeletedTimestamp before the cleaner is initialized!";d("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["",""])),b);throw c("FBLogger")("messenger_web").mustfixThrow(b)}else d("WALogger").DEV(i||(i=babelHelpers.taggedTemplateLiteralLoose(["MpsDeletedCleaner: Adding timestamps (",")"])),a),j.update(a)}function e(){return j}function f(){j=null}g.startMpsDeletedCleaner=a;g.addNewMpsDeletedTimestamp=b;g.getMpsDeletedCleaner_FOR_TESTING_ONLY=e;g.resetMpsDeletedCleaner_FOR_TESTING_ONLY=f}),98);
__d("MpsEphemeralCleaner",["MAWLoggerUtils","MAWMsgCleaner","MWFBLogger"],(function(a,b,c,d,e,f,g){"use strict";var h,i=null,j=d("MWFBLogger").MWLogger().tags([d("MAWLoggerUtils").Tag.Ephemeral,d("MAWLoggerUtils").Tag.MsgCleaner,d("MAWLoggerUtils").Tag.CleanerTimestamp,"purgeDeletions"]);function a(a){i==null&&(i=new(d("MAWMsgCleaner").MsgCleaner)(a,d("MAWMsgCleaner").CLEANER_TYPE.EPHEMERAL))}function b(a){if(i==null)throw j.mustfixThrow("Trying to add new ephemeral timestamp before the cleaner is initialized!");else j.DEBUG(h||(h=babelHelpers.taggedTemplateLiteralLoose(["EphemeralCleaner: Adding timestamps for expiry(",")"])),a),i.update(a)}function c(){return i}function e(){i=null}g.startMpsEphemeralCleaner=a;g.addNewMpsEphemeralTimestamp=b;g.getEphemeralCleaner_FOR_TESTING_ONLY=c;g.resetEphemeralCleaner_FOR_TESTING_ONLY=e}),98);
__d("MpsLogger",["FBLogger"],(function(a,b,c,d,e,f,g){"use strict";a=function(a){return c("FBLogger")("mps",a)};g.MpsLogger=a}),98);
__d("WormMemoryDriver",["WAResolvable","WormStoreFunctions","err"],(function(a,b,c,d,e,f,g){"use strict";var h=0;function i(){h+=1;return h}function a(){h=0}b=function(){function a(a){this.$2={};this.$3=Promise.resolve();this.$1=a;for(a of Object.keys(a))this.$2[a]=new Map()}var b=a.prototype;b.getSchema=function(){return this.$1};b.runInTransaction=function(a,b,c,e){var f=this,g=new(d("WAResolvable").Resolvable)();this.$3=this.$3.then(async function(){var d={};for(var e of Object.keys(f.$1))d[e]=new Map(f.$2[e]);e=a.reduce(function(a,b){return babelHelpers.extends({},a,(a={},a[b]=new j(d[b],f.$1[b]),a))},{});e={abort:function(){},commit:function(){return g.promise.then(function(){})},stores:e};e=await c(e);b==="readwrite"&&(f.$2=d);g.resolve(e)}).catch(function(a){g.reject(a)});return g.promise};b.close=function(){};b.init=function(a){return Promise.resolve()};return a}();var j=function(){function a(a,b){var d=this;this.readIndexRange=function(a,b,e){var f=d.$2.indexes;if(f==null)throw c("err")("No indexes found");f=f[a];if(f==null)throw c("err")("Index not found");var g=Array.from(d.$1.values());if(b!=null){var h;g=l(g,(h=(h=b.lessThan)!=null?h:b.lessThanOrEqual)!=null?h:b.only,b.lessThanOrEqual!=null||b.only!=null,(h=(h=b.greaterThan)!=null?h:b.greaterThanOrEqual)!=null?h:b.only,b.greaterThanOrEqual!=null||b.only!=null,f)}return Promise.resolve(d.$4(g,e,a))};this.$1=a;this.$2=b}var b=a.prototype;b.bulkAdd=function(a){var b=this;for(var d of a){this.$2.autoIncrement===!0&&d[this.$2.primaryKey]===void 0&&(d[this.$2.primaryKey]=i());if(this.$1.has(d[this.$2.primaryKey]))throw c("err")("Item with key already exists");this.$3(d);this.$1.set(d[this.$2.primaryKey],d)}return Promise.resolve(a.map(function(a){return a[b.$2.primaryKey]}))};b.bulkPut=function(a){for(a of a)this.$3(a),this.$1.set(a[this.$2.primaryKey],a);return Promise.resolve()};b.$3=function(a){var b=this,d=this.$2.indexes;if(d==null)return;for(d of Object.values(d)){if(typeof d!=="object"||d==null)continue;var e=d.fields,f=d.unique;if(f===!1)continue;var g=e.map(function(b){return a[b]}).join(":");f=function(d){if(d[b.$2.primaryKey]===a[b.$2.primaryKey])return 1;var f=e.map(function(a){return d[a]}).join(":");if(g===f)throw c("err")("ConstraintError")};for(var h of this.$1.values())if(f(h))continue}};b.bulkGet=function(a){var b=this;return Promise.resolve(a.map(function(a){return b.$1.get(a)}))};b.get=function(a){return Promise.resolve(this.$1.get(a))};b.getByIndex=function(a,b,c){return d("WormStoreFunctions").getByIndex(this,a,b,c)};b.readByKeyRange=function(a,b){var c;c=k(Array.from(this.$1.values()),(c=a.lessThan)!=null?c:a.lessThanOrEqual,a.lessThanOrEqual!=null,(c=a.greaterThan)!=null?c:a.greaterThanOrEqual,a.greaterThanOrEqual!=null,this.$2.primaryKey);return Promise.resolve(this.$4(c,b))};b.bulkDelete=function(a){for(a of a)this.$1.delete(a);return Promise.resolve()};b.delete=function(a){this.$1.delete(a);return Promise.resolve()};b.bulkUpsert=function(a,b){return d("WormStoreFunctions").bulkUpsert(this,this.$2,a,b)};b.readKeysByIndexRange=function(a,b,c){var d=this;return this.readIndexRange(a,b,c).then(function(a){return a.map(function(a){return a[d.$2.primaryKey]})})};b.getIndexRangeIterator=function(a,b,c,e){return d("WormStoreFunctions").getIndexRangeIterator(this.readIndexRange,this.$2,a,b,c,e)};b.$4=function(a,b,c){a=a;(b==null?void 0:b.filter)!=null&&(a=a.filter(b.filter));(b==null?void 0:b.order)!=null&&c!=null&&(a=a.sort(function(a,d){a=a[c];d=d[c];if(a===d)return 0;if(b.order==="desc")return d>a?1:-1;else return a>d?1:-1}));(b==null?void 0:b.limit)!=null&&(a=a.slice(0,b.limit));return a};b.readIndex=function(a,b,d){var e=this.$2.indexes;if(e==null)throw c("err")("No indexes found");var f=e[a];if(f==null)throw c("err")("Index not found");e=Array.from(this.$1.values());b!=null&&(e=e.filter(function(a){for(var c=0;c<f.fields.length;c++)if(a[f.fields[c]]!==b[c])return!1;return!0}));return Promise.resolve(this.$4(e,d,a))};b.readIndexAnyOf=function(a,b,d){var e=this.$2.indexes;if(e==null)throw c("err")("No indexes found");var f=e[a];if(f==null)throw c("err")("Index not found");if(b.length===0)return Promise.resolve([]);e=Array.from(this.$1.values());e=e.filter(function(a){return b.some(function(b){for(var c=0;c<f.fields.length;c++)if(b[c]!==void 0&&a[f.fields[c]]!==b[c])return!1;return!0})});return Promise.resolve(this.$4(e,d,a))};b.readIndexKeys=function(a,b,c){var d=this;return this.readIndex(a,b,c).then(function(a){return a.map(function(a){return a[d.$2.primaryKey]})})};b.readAll=function(a){var b=this,c=Array.from(this.$1.values());(a==null?void 0:a.filter)!=null&&(c=c.filter(a.filter));(a==null?void 0:a.order)!=null&&(c=c.sort(function(c,d){c=c[b.$2.primaryKey];d=d[b.$2.primaryKey];if(c===d)return 0;if(a.order==="desc")return d>c?1:-1;else return c>d?1:-1}));(a==null?void 0:a.limit)!=null&&(c=c.slice(0,a.limit));return Promise.resolve(c)};b.readKeys=function(a){var b=this;return this.readAll(a).then(function(a){return a.map(function(a){return a[b.$2.primaryKey]})})};b.clear=function(){this.$1.clear();return Promise.resolve()};b.count=function(){return Promise.resolve(this.$1.size)};return a}();function k(a,b,c,d,e,f){return a.filter(function(a){if(d!=null&&d>a[f])return!1;if(b!=null&&b<a[f])return!1;if(b!=null&&c===!1&&a[f]===b)return!1;return d!=null&&e===!1&&a[f]===d?!1:!0})}function l(a,b,c,d,e,f){return a.filter(function(a){for(var g=0;g<f.fields.length;g++){if(d!=null&&d[g]>a[f.fields[g]])return!1;if(b!=null&&b[g]<a[f.fields[g]])return!1;if(g===f.fields.length-1){if(b!=null&&c===!1&&a[f.fields[g]]===b[g])return!1;if(d!=null&&e===!1&&a[f.fields[g]]===d[g])return!1}}return!0})}g.TEST_ONLY_resetPK=a;g.WormMemoryDriver=b;g.WormMemoryStore=j}),98);
__d("WebReverbSchema",["FBLogger","MAWWormOdsLogger","WAHex","Worm","WormEAR","WormIDbDriver","WormMemoryDriver"],(function(a,b,c,d,e,f,g){"use strict";e={autoIncrement:!0,indexes:{"[threadId+messageId]":{fields:["threadId","messageId"],unique:!0},"[threadId+timestampMs+messageId]":{fields:["threadId","timestampMs","messageId"],unique:!1},expiryTimestampMs:{fields:["expiryTimestampMs"],unique:!1},messageId:{fields:["messageId"],unique:!1},timestampMs:{fields:["timestampMs"],unique:!1}},nonEncryptedFields:["timestampMs","expiryTimestampMs","messageId","debugFlags"],primaryKey:"pk",secure:!0};f={autoIncrement:!0,indexes:{"[threadId+topLevelMessageId+supplementalKey]":{fields:["threadId","topLevelMessageId","supplementalKey"],unique:!0}},nonEncryptedFields:["topLevelMessageId"],primaryKey:"pk",secure:!0};var h={autoIncrement:!0,indexes:{"[threadId+deletedMessageId]":{fields:["threadId","deletedMessageId"],unique:!0},"[threadId+timestampMs+deletedMessageId]":{fields:["threadId","timestampMs","deletedMessageId"],unique:!0},"[threadId+topLevelMessageId+supplementalKey]":{fields:["threadId","topLevelMessageId","supplementalKey"],unique:!1},deletionTimestampMs:{fields:["deletionTimestampMs"],unique:!1}},nonEncryptedFields:["topLevelMessageId","deletionTimestampMs"],primaryKey:"pk",secure:!0},i={autoIncrement:!0,indexes:{"[threadId+messageId+tag]":{fields:["threadId","messageId","tag"],unique:!0},"[threadId+tag+timestampMs]":{fields:["threadId","tag","timestampMs"],unique:!1}},nonEncryptedFields:["messageId","timestampMs","messagePk","tag"],primaryKey:"pk",secure:!0},j={autoIncrement:!1,indexes:{},primaryKey:"pk",secure:!0},k={dbMetadata:j,deleted:h,message:e,supplemental:f,tags:i};function a(a,b,e,f,g){b=d("WAHex").parseHex(b);var h="reverb";b=new(d("WormEAR").WormEAR)(k,h,b);var i=new(d("Worm").WormDatabase)(new(d("WormIDbDriver").WormIDbDriver)(a,h,k,b,d("MAWWormOdsLogger").wormOdsWorkerLogger,{blockingErrorThreshold:e,onBlockingError:f,onTransactionError:function(a){if(a instanceof d("WormEAR").DecryptionError){var b=a;c("FBLogger")("mps").mustfix("EAR decryption error in store: %s. Dropping corrupted entity %s",b.store,b.maybeHashedPk);void i.runInTransaction([b.store],"readwrite",function(a){a=a.stores[b.store];return b.maybeHashedPk!=null?a["delete"](b.maybeHashedPk):a.clear()},"delete-corrupted-entity")}}}),g);return i}function b(a){return new(d("Worm").WormDatabase)(new(d("WormMemoryDriver").WormMemoryDriver)(k),a)}g.schema=k;g.makeWebReverbSchema=a;g.makeInMemoryReverbSchema_TEST_ONLY=b}),98);
__d("WebReverbDB",["MpsLogger","WAResolvable","WebReverbSchema","err","getErrorSafe"],(function(a,b,c,d,e,f,g){"use strict";var h,i=new(d("WAResolvable").Resolvable)();async function a(a,b,e,f,g){try{a=d("WebReverbSchema").makeWebReverbSchema(a,b,e,f,g);h=a;await a.init();i.resolve(a);return a}catch(a){d("MpsLogger").MpsLogger().catching(c("getErrorSafe")(a)).mustfix("Error performing WebReverb init");throw a}}function b(){if(h==null)throw c("err")("Reverb DB is not initialized");return h}function e(){return i.promise}function f(a){return"WebReverb - "+a}g.makeWebReverb=a;g.getWebReverbDB=b;g.getDbPromise=e;g.mpsOp=f}),98);
__d("MpsReverbDbDump",["WebReverbDB","WormDump"],(function(a,b,c,d,e,f,g){"use strict";function a(){var a=d("WebReverbDB").getWebReverbDB();return a.dump({dbMetadata:{customFields:{mawDBMigrationCurrentMessageId:(a=d("WormDump")).wormNonSensitiveField,mawDBMigrationCurrentThread:a.wormNonSensitiveField,mawDBMigrationStartMs:a.wormNonSensitiveField,mawDBMigrationState:a.wormNonSensitiveField,pk:a.wormNonSensitiveField}},deleted:{customFields:{deletedMessageId:a.wormNonSensitiveField,deletionMessageId:a.wormNonSensitiveField,deletionTimestampMs:a.wormNonSensitiveField,isLocalOnlyMessage:a.wormNonSensitiveField,pk:a.wormNonSensitiveField,supplementalKey:a.wormNonSensitiveField,threadId:a.wormNonSensitiveField,timestampMs:a.wormNonSensitiveField,topLevelMessageId:a.wormNonSensitiveField},limit:1e3},message:{customFields:{debugFlags:a.wormNonSensitiveField,expiryTimestampMs:a.wormNonSensitiveField,isLocalOnlyMessage:a.wormNonSensitiveField,isTransportErrorPlaceholder:a.wormNonSensitiveField,messageId:a.wormNonSensitiveField,pk:a.wormNonSensitiveField,senderId:a.wormNonSensitiveField,threadId:a.wormNonSensitiveField,timestampMs:a.wormNonSensitiveField},limit:2500},supplemental:{customFields:{messageId:a.wormNonSensitiveField,pk:a.wormNonSensitiveField,supplementalKey:a.wormNonSensitiveField,threadId:a.wormNonSensitiveField,timestampMs:a.wormNonSensitiveField,topLevelMessageId:a.wormNonSensitiveField},limit:1e3},tags:{customFields:{messageId:a.wormNonSensitiveField,messagePk:a.wormNonSensitiveField,pk:a.wormNonSensitiveField,threadId:a.wormNonSensitiveField,timestampMs:a.wormNonSensitiveField},limit:1e3}})}g.debugGetReverbDbDump=a}),98);
__d("WebMpsReverbWrites",[],(function(a,b,c,d,e,f){"use strict";function a(a,b,c,d,e,f,g){var h=[e,d,c];return g(async function(g){var i=await g.stores.supplemental.getByIndex("[threadId+topLevelMessageId+supplementalKey]",h);if(((i=i==null?void 0:i.timestampMs)!=null?i:0)>=f)return;i={messageId:a,payload:b,supplementalKey:c,threadId:e,timestampMs:f,topLevelMessageId:d};await g.stores.supplemental.bulkUpsert("[threadId+topLevelMessageId+supplementalKey]",[{item:i,selector:h}])})}function b(a,b,c){var d=a.messageId,e=a.threadId;return c(async function(c){var f,g=await c.stores.message.getByIndex("[threadId+messageId]",[e,d]);if(g!=null&&!g.isTransportErrorPlaceholder)return;if(g!=null&&g.isTransportErrorPlaceholder&&b.isTransportErrorPlaceholder)return;var h=await c.stores.deleted.getByIndex("[threadId+deletedMessageId]",[a.threadId,a.messageId]),i=babelHelpers.extends({},a,{debugFlags:b.debugFlags,expiryTimestampMs:b.expiryTimestampMs,isLocalOnlyMessage:b.isLocalOnly,isTransportErrorPlaceholder:b.isTransportErrorPlaceholder,timestampMs:(f=g==null?void 0:g.timestampMs)!=null?f:a.timestampMs});if(!h){f=await c.stores.message.bulkUpsert("[threadId+messageId]",[{item:i,selector:[e,d]}]);var j=f[0];f=await c.stores.tags.readIndexRange("[threadId+messageId+tag]",{only:[e,d]});f.length>0&&await c.stores.tags.bulkDelete(f.map(function(a){return a.pk}));b.tags.length>0&&await c.stores.tags.bulkAdd(b.tags.map(function(a){return{messageId:i.messageId,messagePk:j,tag:a,threadId:i.threadId,timestampMs:i.timestampMs}}))}else h.payload=i.payload,await c.stores.deleted.bulkPut([h]),g!=null&&(g.timestampMs=a.timestampMs,await c.stores.message.bulkPut([g]))})}f.upsertSupplementalToReverb=a;f.upsertTopLevelToReverb=b}),66);
__d("WebMpsMigrationReverbTxns",["FBLogger","MpsTypes","WebMpsReverbWrites","WebReverbDB"],(function(a,b,c,d,e,f,g){"use strict";var h=function(){return c("FBLogger")("mps").tags(["mps_migration"])};async function a(a,b){try{await d("WebReverbDB").getWebReverbDB().runInTransaction(["message","supplemental","deleted","tags","dbMetadata"],"readwrite",function(b){var c=function(a){return a(b)};return Promise.all(a.map(function(a){return i(a,c)}))},"mps-persist-messages-migrated-from-maw-db")}catch(a){b.endFail("reverb_write_failure");throw a}}async function i(a,b){var c=[],e=[];c.push(d("WebMpsReverbWrites").upsertTopLevelToReverb(a.toplevelProtobuf,{actionType:d("MpsTypes").ActionType.UpsertTopLevel,debugFlags:["MAW_Migration"],isLocalOnly:!0,isTransportErrorPlaceholder:!1,tags:[],targetMessageId:a.toplevelProtobuf.messageId},b));for(var f of a.supplementalsToInsert.entries()){var g=f[0],i=f[1];c.push(d("WebMpsReverbWrites").upsertSupplementalToReverb(i.messageId,i.payload,g,a.toplevelProtobuf.messageId,a.toplevelProtobuf.threadId,i.timestampMs,b))}g=await Promise.allSettled(c);i=g.filter(function(a){return a.status==="rejected"});for(f of i)h().mustfix("Failed to upsert a row into Reverb: %s",f.reason);if(i.length>0)throw h().mustfixThrow("Reverb upsert failed");c=async function(){var c=j[0];j[1];e.push(b(async function(b){var d=[a.toplevelProtobuf.threadId,a.toplevelProtobuf.messageId,c];d=await b.stores.supplemental.getByIndex("[threadId+topLevelMessageId+supplementalKey]",d);if(d==null)return;await b.stores.supplemental.bulkDelete([d.pk])}))};for(var j of a.supplementalsToDelete.entries())await c();g=await Promise.allSettled(e);f=g.filter(function(a){return a.status==="rejected"});for(i of f)h().mustfix("Failed to delete a row from Reverb: %s",i.reason);if(f.length>0)throw h().mustfixThrow("Reverb delete failed")}function b(){return d("WebReverbDB").getWebReverbDB().runInTransaction(["dbMetadata"],"readonly",function(a){return a.stores.dbMetadata.get("db-info")},"mps-get-db-metadata")}function e(a,b){try{return d("WebReverbDB").getWebReverbDB().runInTransaction(["dbMetadata"],"readwrite",async function(b){await b.stores.dbMetadata.bulkAdd([babelHelpers.extends({},a,{pk:"db-info"})])},"mps-set-db-metadata")}catch(a){b.endFail("migration_state_write_failure");throw a}}function f(a,b){try{return d("WebReverbDB").getWebReverbDB().runInTransaction(["dbMetadata"],"readwrite",async function(b){var c,d=await b.stores.dbMetadata.get("db-info");if(d==null)throw h().mustfixThrow("DB Metadata row does not exist, cannot update the cursor");d=d;c=babelHelpers.extends({},d,{mawDBMigrationCurrentMessageId:(c=a.mawDBMigrationCurrentMessageId)!=null?c:d.mawDBMigrationCurrentMessageId,mawDBMigrationCurrentThread:(c=a.mawDBMigrationCurrentThread)!=null?c:d.mawDBMigrationCurrentThread,mawDBMigrationStartMs:(c=a.mawDBMigrationStartMs)!=null?c:d.mawDBMigrationStartMs,mawDBMigrationState:(c=a.mawDBMigrationState)!=null?c:d.mawDBMigrationState});await b.stores.dbMetadata.bulkPut([c])},"mps-update-db-metadata")}catch(a){b.endFail("migration_state_write_failure");throw a}}g.persistMigratedMessagesFromMawDb=a;g.getMawMpsMigrationState=b;g.setInitialMawMpsMigrationState=e;g.setMawMpsMigrationState=f}),98);
__d("MpsReverbInit",["MAWMpsMigrationStatus","MpsTypes","WebMpsMigrationReverbTxns","WebReverbDB"],(function(a,b,c,d,e,f,g){"use strict";async function a(a){await d("WebReverbDB").makeWebReverb(a.name,a.strEncKey,a.blockingErrorThreshold,a.onBlockingError,a.qplEvent);a=await d("WebMpsMigrationReverbTxns").getMawMpsMigrationState();d("MAWMpsMigrationStatus").setStatus((a==null?void 0:a.mawDBMigrationState)===d("MpsTypes").MawDBMigrationState.Completed)}g.initReverb=a}),98);
__d("WAPromiseQueue",["Promise"],(function(a,b,c,d,e,f){"use strict";var g;a=function(){function a(a){a===void 0&&(a=-1),this.$1=(g||(g=b("Promise"))).resolve(),this.$3=0,this.$2=a}var c=a.prototype;c.wait=function(){return this.$1};c.enqueueHandlers=function(a,b,c){var d=this;this.$3++;b=this.$1.then(function(){return a}).then(b,c);c=b.then();this.$1=h(b,this.$2)["finally"](function(){d.$3--});return c};c.enqueue=function(a){var b=this;this.$3++;a=this.$1.then(a);var c=a.then();this.$1=h(a,this.$2)["finally"](function(){b.$3--});return c};c.size=function(){return this.$3};return a}();c=function(){function a(a){a===void 0&&(a=-1),this.$1=new Map(),this.$2=a}var c=a.prototype;c.waitIfPending=function(a){return this.$1.get(a)};c.wait=function(a){return this.$1.get(a)||(g||(g=b("Promise"))).resolve()};c.enqueueHandlers=function(a,b,c,d){c=this.wait(a).then(function(){return b}).then(c,d);return this.$3(a,c)};c.enqueue=function(a,b){b=this.wait(a).then(b);return this.$3(a,b)};c.$3=function(a,b){var c=this,d=b.then(),e,f=function(){c.$1.get(a)===e&&c.$1["delete"](a)};e=h(b,this.$2).then(f,f);this.$1.set(a,e);return d};return a}();function h(a,c){if(c>=0)return new(g||(g=b("Promise")))(function(b){var d=function(){return void b()};a.then(d,d);setTimeout(d,c)});else return a.then(i,i)}function i(){}f.PromiseQueue=a;f.PromiseQueueMap=c}),66);
__d("WAWaitForUserUnblocked",["WAResolvable","WorkerScheduler"],(function(a,b,c,d,e,f,g){"use strict";f=2*60*1e3;var h=new(d("WAResolvable").Resolvable)(),i=d("WorkerScheduler").makeScheduler("offline-queue",{concurrency:1,maxTaskLimit:1,defaultSamplingRate:1e3,timeoutMs:f});function a(){h.resolveWasCalled()&&(h=new(d("WAResolvable").Resolvable)(),j())}function j(){void i.runTask({name:"offline-queue",fn:function(){return h.promise},priority:d("WorkerScheduler").BLOCKING_PRIORITY})}function b(){return h.promise}function c(){h.resolve()}function e(){return!h.resolveWasCalled()}g.maybeResetWaitForUserUnblocked=a;g.markOfflineQueueAsStarted=j;g.waitForUserUnblocked=b;g.unblockUser=c;g.isStillWaitingForUserUnblocked=e}),98);
__d("WebMpsGetDistinctSupplementals",[],(function(a,b,c,d,e,f){"use strict";function a(a,b){var c=new Map(a),d=new Map();b.forEach(function(a,b){var e=c.get(b);if(e==null)c.set(b,a),d.set(b,a);else{e=e.timestampMs;var f=a.timestampMs;f>e&&(c.set(b,a),d.set(b,a))}});return{supplementals:c,supplementalsToWriteToReverb:d}}f.getDistinctSupplementals=a}),66);
__d("WebMpsGetDistinctMessages",["WebMpsGetDistinctSupplementals"],(function(a,b,c,d,e,f,g){"use strict";var h=["debugFlags","expiryTimestampMs","isLocalOnlyMessage","isTransportErrorPlaceholder","pk"],i=["debugFlags","expiryTimestampMs","isLocalOnlyMessage","isTransportErrorPlaceholder","pk"];function a(a,b){var c=new Map(),e=new Map();a.forEach(function(a){var b=a.reverbTopLevel;b.debugFlags;var d=b.expiryTimestampMs;b.isLocalOnlyMessage;b.isTransportErrorPlaceholder;b.pk;b=babelHelpers.objectWithoutPropertiesLoose(b,h);e.set(a.reverbTopLevel.messageId,a);c.set(a.reverbTopLevel.messageId,{expiryTimestampMs:d,supplementalProtobufs:a.supplementalProtobufs,tags:a.tags,toplevelProtobuf:b})});var f=new Map(),g=new Map(),j=new Map();b.forEach(function(a){var b=a.supplementalProtobufs,h=a.tags,k=a.toplevelProtobuf,l=k.messageId,m=e.get(l);if(m==null||m.reverbTopLevel.isTransportErrorPlaceholder===!0)c.set(l,a),f.set(l,k),g.set(l,new Map(b)),j.set(l,h);else{a=m.supplementalProtobufs;k=d("WebMpsGetDistinctSupplementals").getDistinctSupplementals(a,b);h=k.supplementals;a=k.supplementalsToWriteToReverb;b=m.reverbTopLevel;b.debugFlags;k=b.expiryTimestampMs;b.isLocalOnlyMessage;b.isTransportErrorPlaceholder;b.pk;b=babelHelpers.objectWithoutPropertiesLoose(b,i);c.set(l,{expiryTimestampMs:k,supplementalProtobufs:h,tags:m.tags,toplevelProtobuf:b});a.size>0&&g.set(l,new Map(a))}});return{messages:Array.from(c.values()),supplementalMessagesToWriteToReverb:g,tagsToWriteToReverb:j,topLevelMessagesToWriteToReverb:f}}g.getDistinctMessages=a}),98);
__d("WebMpsGetIsMessageExpired",["WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";function a(a){return a!=null&&d("WATimeUtils").cappedMillisecondsUntil(d("WATimeUtils").castMilliSecondsToUnixTime(a))<=0?!0:!1}g.getIsMessageExpired=a}),98);
__d("WebMpsPersistMessagesFromEb",["FBLogger","MpsLogger","MpsTypes","WebMpsReverbWrites","WebReverbDB","getErrorSafe"],(function(a,b,c,d,e,f,g){"use strict";var h;async function a(a){if(a.length===0||a.every(function(a){return a.topLevelProtobufs.size===0&&a.supplementalProtobufs.size===0&&a.tags.size===0}))return;try{await d("WebReverbDB").getWebReverbDB().runInTransaction(["message","supplemental","deleted","tags","dbMetadata"],"readwrite",function(b){var d=a.map(function(a){var d=a.supplementalProtobufs,e=a.tags,f=a.threadId;a=a.topLevelProtobufs;c("FBLogger")("mps").INFO(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Persisting EB messages thread: "," topLevelProtobufs: "," supplementalProtobufs: ",""])),f,Array.from(a.keys()).join(","),Array.from(d.keys()).join(","));return i(a,d,e,f,function(a){return a(b)})}).flat();return Promise.all(d)},"mps-persist-messages-from-eb")}catch(a){var b=c("getErrorSafe")(a);d("MpsLogger").MpsLogger().catching(b).mustfix("Runtime error performing persistMessagesFromEB");throw b}}function i(a,b,c,e,f){var g=[];a.forEach(function(a,b){g.push(d("WebMpsReverbWrites").upsertTopLevelToReverb(a,{actionType:d("MpsTypes").ActionType.UpsertTopLevel,debugFlags:["EB"],isLocalOnly:!1,isTransportErrorPlaceholder:!1,tags:(a=c.get(b))!=null?a:[],targetMessageId:b},f))});b.forEach(function(a,b){a.forEach(function(a,c){g.push(d("WebMpsReverbWrites").upsertSupplementalToReverb(a.messageId,a.payload,c,b,e,a.timestampMs,f))})});return g}g.persistMessagesFromEB=a}),98);
__d("WebMpsBatchLoadMessage",["MpsLogger","WAGetSafeQPLError","WebMpsGetDistinctMessages","WebMpsGetIsMessageExpired","WebMpsPersistMessagesFromEb","WebReverbDB","err","getErrorSafe"],(function(a,b,c,d,e,f,g){"use strict";var h=["pk","supplementalKey","threadId","topLevelMessageId"];async function i(a,b,e,f,g){try{g.metric.addPoint("load-message-from-reverb_start");var i=d("WebReverbDB").getWebReverbDB();i=await i.runInTransaction(["message","supplemental","tags"],"readonly",function(c){return Promise.all(b.map(function(b){var d=c.stores.message.readIndex("[threadId+messageId]",[a,b],{limit:1}),g=f?c.stores.tags.readIndexRange("[threadId+messageId+tag]",{only:[a,b]}):[],h=e?c.stores.supplemental.readIndexRange("[threadId+topLevelMessageId+supplementalKey]",{only:[a,b]}):[];return Promise.all([b,d,h,g])}))},"mps-load-message");g.metric.addPoint("load-message-from-reverb_end");var j=new Map();i.forEach(function(a){var b=a[0],c=a[1];c=c[0];var e=a[2];a=a[3];if(c==null)return null;if(d("WebMpsGetIsMessageExpired").getIsMessageExpired(c.expiryTimestampMs))return null;var f=new Map();e.forEach(function(a){a.pk;var b=a.supplementalKey;a.threadId;a.topLevelMessageId;a=babelHelpers.objectWithoutPropertiesLoose(a,h);f.set(b,a)});e=a.map(function(a){a=a.tag;return a});j.set(b,{reverbTopLevel:c,supplementalProtobufs:f,tags:e})});return j}catch(a){g.metric.addPoint("load-message-from-reverb_fail");d("MpsLogger").MpsLogger().catching(c("getErrorSafe")(a)).mustfix("Runtime error performing loadMessageFromReverb");return new Map()}}async function j(a,b,e,f,g){try{var h=e.isEbEnabled(),i=h===!0?"true":h===!1?"false":"unset";g.metric.addAnnotations({string:{ebEnabled:i}});if(h!==!0)return new Map();g.metric.addPoint("load-message-from-eb_start");i=e.messagePointQuery;h=await i({ctx:g,messageIds:b,threadId:a});if(h.success===!1)return new Map();e=f(h.value,a);g.metric.addPoint("load-message-from-eb_end");return new Map(e.map(function(a){return[a.toplevelProtobuf.messageId,a]}))}catch(a){g.metric.addPoint("load-message-from-eb_fail");i=c("getErrorSafe")(a);d("MpsLogger").MpsLogger().catching(i).mustfix("Runtime error performing loadFromEB");return new Map()}}async function a(a,b,e,f,g){var h=e.decryptedProtobufToFullMessage,k=e.eb;e=f.persistToReverb;var l=f.shouldFetchSupplementals,m=f.shouldFetchTags;f=f.strategy;try{g.metric.addPoint("load-message_start");var n=function(){return i(a,b,l,m,g)},o=function(){return j(a,b,k,h,g)},p,q;switch(f){case"local-first":p=await n();var r=p.size===b.length;r?q=new Map():q=await o();break;case"full-fetch":r=await Promise.all([n(),o()]);p=r[0];q=r[1];break;case"local-only":p=await n();q=new Map();break;case"remote-only":p=new Map();q=await o();break;default:f;throw c("err")("empty strategy")}r=b.map(function(a){var b=p.get(a);a=q.get(a);return d("WebMpsGetDistinctMessages").getDistinctMessages([b].filter(Boolean),[a].filter(Boolean))});e==="persist"&&void d("WebMpsPersistMessagesFromEb").persistMessagesFromEB(r.map(function(b){var c=b.supplementalMessagesToWriteToReverb,d=b.tagsToWriteToReverb;b=b.topLevelMessagesToWriteToReverb;return{supplementalProtobufs:c,tags:d,threadId:a,topLevelProtobufs:b}}));g.metric.addPoint("load-message_end");return r.map(function(a){return a.messages[0]})}catch(a){n=c("getErrorSafe")(a);g.metric.addPoint("load-message_fail",{string:{errorDescription:d("WAGetSafeQPLError").getSafeQPLErrorMessage(n)}});d("MpsLogger").MpsLogger().catching(n).mustfix("Runtime error performing loadMessage");throw n}}g.batchLoadMessage=a}),98);
__d("PackedMpsRange",[],(function(a,b,c,d,e,f){"use strict";function a(a){return a}f.packMpsRange=a}),66);
__d("WebMpsBatchLoadFromReverb",["MpsLogger","WebMpsGetIsMessageExpired","WebReverbDB","WebReverbSchema","WormRangeIterator","getErrorSafe"],(function(a,b,c,d,e,f,g){"use strict";var h=["pk","supplementalKey","threadId","topLevelMessageId"];async function i(a,b,c,e,f,g,i,j,k){var l=c[0],m=c[1],n=j?function(a){return a.isLocalOnlyMessage===!1}:function(a){return!0},o=function(a){return!d("WebMpsGetIsMessageExpired").getIsMessageExpired(a.expiryTimestampMs)},p=function(a){return n(a)&&o(a)},q="[threadId+timestampMs+messageId]";function r(){var c=a.stores.message.getIndexRangeIterator(q,e,{greaterThanOrEqual:[b],lessThanOrEqual:[b]},p),d=m==null?[b,l]:[b,l,m];return c.read(d,f)}async function s(c){var g="[threadId+tag+timestampMs]";c=await Promise.all(Array.from(c).map(function(c){return a.stores.tags.getIndexRangeIterator(g,e,{greaterThanOrEqual:[b],lessThanOrEqual:[b]}).read([b,c,l],f)}));c=d("WormRangeIterator").mergeRanges(c,g,d("WebReverbSchema").schema.tags,e,f);var h=await Promise.all(c.data.map(function(b){return a.stores.message.getByIndex("[threadId+messageId]",[b.threadId,b.messageId],{filter:p})})).then(function(a){return a.filter(Boolean)});c=d("WormRangeIterator").makeCursorInfoFromList(h,q,d("WebReverbSchema").schema.message,c.cursorInfo.hasNext,c.cursorInfo.hasPrevious);return{cursorInfo:c,data:h}}k!=="all"?c=await s(k):c=await r();j=c;s=j.cursorInfo;k=j.data;r=await Promise.all(k.map(async function(c){var d=g?await a.stores.supplemental.readIndexRange("[threadId+topLevelMessageId+supplementalKey]",{only:[b,c.messageId]}):[],e=new Map();d.forEach(function(a){a.pk;var b=a.supplementalKey;a.threadId;a.topLevelMessageId;a=babelHelpers.objectWithoutPropertiesLoose(a,h);e.set(b,a)});d=i?await a.stores.tags.readIndexRange("[threadId+messageId+tag]",{only:[b,c.messageId]}):[];d=d.map(function(a){a=a.tag;return a});return{reverbTopLevel:c,supplementalProtobufs:e,tags:d}}));return{cursorInfo:{endCursor:s.endCursor!=null?[s.endCursor[1],s.endCursor[2]]:null,hasNext:s.hasNext,hasPrevious:s.hasPrevious,startCursor:s.startCursor!=null?[s.startCursor[1],s.startCursor[2]]:null},messages:r,threadId:b}}async function a(a,b,e,f,g,h){try{g.metric.addPoint("reverb_fetch_start");var j=d("WebReverbDB").getWebReverbDB();j=new Map(await j.runInTransaction(["message","supplemental","tags"],"readonly",function(c){return Promise.all(a.map(function(a){return i(c,a.threadId,a.from,a.direction,a.numMessages,b,e,f,h).then(function(b){return[a,b]})}))},"mps-load-messages"));g.metric.addPoint("reverb_fetch_end");return j}catch(a){j=c("getErrorSafe")(a);d("MpsLogger").MpsLogger().catching(j).mustfix("Runtime error performing WebMpsBatchLoadFromReverb");g.metric.addPoint("reverb_fetch_end",{bool:{reverbFail:!0}});return new Map()}}g.batchLoadMessagesFromReverb=a}),98);
__d("WebMpsLoadMessagesFromEb",["MpsLogger","WAGetSafeQPLError","WAPromiseDelays","WAResultOrError","getErrorSafe","justknobx"],(function(a,b,c,d,e,f,g){"use strict";var h={endCursor:null,hasNext:!1,hasPrevious:!1,startCursor:null};async function i(a,b,e,f,g){function h(){f.metric.addPoint("eb_fetch_timeout");throw d("MpsLogger").MpsLogger().mustfixThrow("Timed out waiting for EB Fetch")}var i=a.reduce(function(a,b){return a+b.numMessages},0);i=Math.min(Math.max((i-20)/180,0),1);i=c("justknobx")._("3429")*(1+i*2);b=await d("WAPromiseDelays").withTimeout(b.messageRangeQuery({ctx:f,ranges:a,tagsFilter:g}),i,h);g=b.map(function(b,c){c=a[c];c=c.threadId;if(b.success===!1)return b;b=b.value;var f=b.cursorInfo;b=b.messages;b=e(b,c);return d("WAResultOrError").makeResult({cursorInfo:f,messages:b,threadId:c})});f.metric.addPoint("eb_fetch_end");return g}async function a(a,b,e,f){var g=b.decryptedProtobufToFullMessage;b=b.eb;try{var j=b.isEbEnabled(),k=j===!0?"true":j===!1?"false":"unset";e.metric.addAnnotations({string:{ebEnabled:k}});if(j!==!0)return c("justknobx")._("1920")?new Map(a.map(function(a){return[a,d("WAResultOrError").makeResult({cursorInfo:h,messages:[],threadId:a.threadId})]})):new Map();k=!1;e.metric.addPoint("load-messages-from-eb_start");var l=await i(a,b,g,e,f);j=new Map(a.map(function(a,b){b=l[b];b.success===!1&&(k=!0);return[a,b]}));k&&e.metric.addAnnotations({bool:{ebFetchFailed:!0}});e.metric.addPoint("load-messages-from-eb_end");return j}catch(a){b=c("getErrorSafe")(a);e.metric.addPoint("load-messages-from-eb_fail",{string:{ebFetchFailReason:d("WAGetSafeQPLError").getSafeQPLErrorMessage(a)}});d("MpsLogger").MpsLogger().catching(b).mustfix("Error fetching from EB");return new Map()}}g.loadMessagesFromEb=a}),98);
__d("WebMpsMergeMessageRangesFromDifferentSources",["WebMpsGetDistinctMessages","err","first","last"],(function(a,b,c,d,e,f,g){"use strict";var h=["debugFlags","expiryTimestampMs","isLocalOnlyMessage","isTransportErrorPlaceholder","pk"];function a(a,b,e,f,g){var i;i=d("WebMpsGetDistinctMessages").getDistinctMessages((i=b==null?void 0:b.messages)!=null?i:[],(i=a==null?void 0:a.messages)!=null?i:[]);var j=i.messages,k=i.supplementalMessagesToWriteToReverb,l=i.tagsToWriteToReverb;i=i.topLevelMessagesToWriteToReverb;if(b==null||a==null){var m=b!=null?babelHelpers["extends"]({},b,{messages:b.messages.map(function(a){var b=a.reverbTopLevel;a=a.supplementalProtobufs;b.debugFlags;var c=b.expiryTimestampMs;b.isLocalOnlyMessage;b.isTransportErrorPlaceholder;b.pk;b=babelHelpers.objectWithoutPropertiesLoose(b,h);return{expiryTimestampMs:c,supplementalProtobufs:a,tags:[],toplevelProtobuf:b}})}):a;if(m==null)throw c("err")("data-fetching-error");return{range:m,supplementalMessagesToWriteToReverb:k,tagsToWriteToReverb:l,topLevelMessagesToWriteToReverb:i}}m=a;a=[].concat(j).sort(function(a,b){return e==="asc"?a.toplevelProtobuf.timestampMs-b.toplevelProtobuf.timestampMs:b.toplevelProtobuf.timestampMs-a.toplevelProtobuf.timestampMs});j=a.slice(0,f);a=c("first")(j);f=c("last")(j);a=a!=null?[a.toplevelProtobuf.timestampMs,a.toplevelProtobuf.messageId]:void 0;f=f!=null?[f.toplevelProtobuf.timestampMs,f.toplevelProtobuf.messageId]:void 0;var n=f!=null?m.cursorInfo.hasNext||b.cursorInfo.hasNext:!1;m=a!=null?m.cursorInfo.hasPrevious||b.cursorInfo.hasPrevious:!1;return{range:{cursorInfo:{endCursor:f,hasNext:n,hasPrevious:m,startCursor:a},messages:j,threadId:g},supplementalMessagesToWriteToReverb:k,tagsToWriteToReverb:l,topLevelMessagesToWriteToReverb:i}}g.mergeMessageRangesFromDifferentSources=a}),98);
__d("WebMpsEbCache",["MpsTypes","WAJids","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,c,e,f,g){b=d("WAJids").validateChatJid(b);if(b==null)return[];a=a.getMetadataFromCache({chatJid:b,direction:c,numberOfMessages:e,referenceMessage:g,referenceTimestamp:f==null?null:d("WATimeUtils").castToMillisTime(f)});return a.success===!1?[]:a.value.map(function(a){var b=a.offlineThreadingId;a=a.sortOrderMs;return{offlineThreadingId:b,sortOrderMs:d("MpsTypes").toTimestamp(a)}})}function b(a,b){if(a==null)return"no-match";if(b.length===0)return"no-match";if(a.cursorInfo.hasNext!==!0)return"reverb-cursor-ended";var c=new Set(a.messages.map(function(a){return a.reverbTopLevel.messageId})),d=new Set(b.map(function(a){return a.offlineThreadingId}));if(c.size!==d.size)return"no-match";if(Array.from(c).every(function(a){return d.has(a)}))return"match";c=a.messages.map(function(a){return a.reverbTopLevel.timestampMs}).sort(function(a,b){return b-a});a=b.map(function(a){return a.sortOrderMs}).sort(function(a,b){return b-a});b=0;for(var e=0;e<c.length;e++){var f=c[e],g=a[b];if(f<g)return"no-match";if(f>g)continue;b++}return"reverb-newer"}g.loadEBMetadataCache=a;g.compareReverbVsMetadataCache=b}),98);
__d("WebMpsValidateReverbViaCacheAndFetchFromEb",["MpsLogger","WebMpsEbCache","WebMpsLoadMessagesFromEb"],(function(a,b,c,d,e,f,g){"use strict";async function a(a,b,c,e,f){var g=await b;if(f!=="all"){e.metric.addAnnotations({string:{ebMetadataCache:"skip"}});return{eb:await d("WebMpsLoadMessagesFromEb").loadMessagesFromEb(a,c,e,f),reverb:g}}b=a.filter(function(a){var b=a.direction,f=a.from,h=a.numMessages,i=a.threadId;i=d("WebMpsEbCache").loadEBMetadataCache(c.eb,i,b,h,f[0],f[1]);h=d("WebMpsEbCache").compareReverbVsMetadataCache(g.get(a),i);e.metric.addAnnotations({string:{ebMetadataCache:h}});d("MpsLogger").MpsLogger().debug("MPS Range query metadata comparison: ",h);if(h==="match")return!1;return b==="desc"&&h==="reverb-newer"?!1:!0});return b.length===0?{eb:new Map(),reverb:g}:{eb:await d("WebMpsLoadMessagesFromEb").loadMessagesFromEb(b,c,e,f),reverb:g}}g.validateReverbViaCacheAndFetchFromEb=a}),98);
__d("WebMpsBatchLoadMessages",["MpsLogger","PackedMpsRange","WAGetSafeQPLError","WebMpsBatchLoadFromReverb","WebMpsLoadMessagesFromEb","WebMpsMergeMessageRangesFromDifferentSources","WebMpsPersistMessagesFromEb","WebMpsValidateReverbViaCacheAndFetchFromEb","err","getErrorSafe"],(function(a,b,c,d,e,f,g){"use strict";async function a(a,b,e,f){var g=e.persistToReverb,h=e.shouldFetchSupplementals,i=e.shouldFetchTags,j=e.shouldIgnoreLocalOnly,k=e.strategy,l=e.tagsFilter,m=a.map(function(a){return d("PackedMpsRange").packMpsRange(a)});try{f.metric.addPoint("mps_fetch_start");e=function(){return d("WebMpsBatchLoadFromReverb").batchLoadMessagesFromReverb(m,h,i,j,f,l)};var n,o;switch(k){case"full-fetch":a=await d("WebMpsValidateReverbViaCacheAndFetchFromEb").validateReverbViaCacheAndFetchFromEb(m,e(),b,f,l);n=a.reverb;o=a.eb;break;case"local-only":n=await e();o=new Map();break;case"remote-only":o=await d("WebMpsLoadMessagesFromEb").loadMessagesFromEb(m,b,f,l);n=new Map();break;default:k;throw c("err")("empty strategy")}a=m.map(function(a){var b=a.direction,c=a.numMessages,e=a.threadId,f=n.get(a);a=(a=o.get(a))==null?void 0:a.value;if(f==null&&a==null)return;a=d("WebMpsMergeMessageRangesFromDifferentSources").mergeMessageRangesFromDifferentSources(a,f,b,c,e);f=a.range;b=a.supplementalMessagesToWriteToReverb;c=a.tagsToWriteToReverb;a=a.topLevelMessagesToWriteToReverb;return{range:f,supplementalMessagesToWriteToReverb:b,tagsToWriteToReverb:c,threadId:e,topLevelMessagesToWriteToReverb:a}}).filter(Boolean);g==="persist"&&void d("WebMpsPersistMessagesFromEb").persistMessagesFromEB(a.map(function(a){var b=a.supplementalMessagesToWriteToReverb,c=a.tagsToWriteToReverb,d=a.threadId;a=a.topLevelMessagesToWriteToReverb;return{supplementalProtobufs:b,tags:c,threadId:d,topLevelProtobufs:a}}));return a.map(function(a){a=a.range;return a})}catch(a){e=c("getErrorSafe")(a);d("MpsLogger").MpsLogger().catching(e).mustfix("Runtime error performing loadMessages");f.metric.addAnnotations({string:{errorDescription:d("WAGetSafeQPLError").getSafeQPLErrorMessage(e)}});throw e}}g.batchLoadMessages=a}),98);
__d("MAWMpsCleanersContants",["DateConsts"],(function(a,b,c,d,e,f,g){"use strict";a=30*d("DateConsts").MS_PER_DAY;b=6*d("DateConsts").MS_PER_HOUR;g.PURGE_DELETED_MESSAGES_WINDOW_IN_MS=a;g.REPORTING_WINDOW_IN_MS=b}),98);
__d("WebMpsInsertionCleaners",["MAWMpsCleanersContants","MpsDeletedCleaner","MpsEphemeralCleaner","MpsLogger","MpsTypes","WATimeUtils","err","getErrorSafe"],(function(a,b,c,d,e,f,g){"use strict";async function a(a){try{await Promise.all(a.map(h)),await Promise.all(a.map(j))}catch(b){a=c("getErrorSafe")(b);d("MpsLogger").MpsLogger().catching(a).mustfix("Failed to run side effects")}}function h(a){return a.directive.actionType===d("MpsTypes").ActionType.DeleteTopLevel||a.directive.actionType===d("MpsTypes").ActionType.DeleteSupplemental||a.directive.actionType===d("MpsTypes").ActionType.DeleteThread?i(a.message.timestampMs):a.directive.actionType===d("MpsTypes").ActionType.UpsertTopLevel||a.directive.actionType===d("MpsTypes").ActionType.UpsertSupplemental||a.directive.actionType===d("MpsTypes").ActionType.DeleteTopLevelWithPlaceholder||a.directive.actionType===d("MpsTypes").ActionType.Noop?Promise.resolve():a.directive.actionType===d("MpsTypes").ActionType.Unknown||a.directive.actionType===d("MpsTypes").ActionType.Preprocess?Promise.reject(c("err")("this should not happen")):function(){throw Error("Match: No case succesfully matched. Make exhaustive or add a wildcard case using '_'. Argument: "+a.directive.actionType)}()}function i(a){a=d("WATimeUtils").castToUnixTime(Math.ceil((a+d("MAWMpsCleanersContants").REPORTING_WINDOW_IN_MS)/1e3));d("MpsDeletedCleaner").addNewMpsDeletedTimestamp(a);return Promise.resolve()}function j(a){a=(a=a.directive)==null?void 0:a.expiryTimestampMs;if(a==null)return Promise.resolve();a=d("WATimeUtils").castToUnixTime(Math.ceil(a/1e3));d("MpsEphemeralCleaner").addNewMpsEphemeralTimestamp(a);return Promise.resolve()}g.scheduleCleaners=a}),98);
__d("WebMpsInsertionFlow",["MpsLogger","MpsTypes","WebMpsReverbWrites","WebReverbDB","err","justknobx","nullthrows"],(function(a,b,c,d,e,f,g){"use strict";async function a(a){if(c("justknobx")._("4336"))try{await d("WebReverbDB").getWebReverbDB().runInTransaction(["message","supplemental","deleted","tags","dbMetadata"],"readwrite",async function(b){for(var c of a)await i(c,function(a){return a(b)})},"mps-insertion-flow-shared");return new Map()}catch(a){d("MpsLogger").MpsLogger().catching(a).mustfix("Failed to persist messages")}return h(a)}async function h(a){var b=new Map(),c=async function(a){await i(a,function(a){return d("WebReverbDB").getWebReverbDB().runInTransaction(["message","supplemental","deleted","tags","dbMetadata"],"readwrite",function(b){return a(b)},"mps-insertion-flow-separate")}).catch(function(c){b.set(a.message.messageId,c)})};for(a of a)await c(a);return b}function i(a,b){switch(a.directive.actionType){case d("MpsTypes").ActionType.UpsertTopLevel:return j(a,b);case d("MpsTypes").ActionType.UpsertSupplemental:return k(a,b);case d("MpsTypes").ActionType.DeleteTopLevel:return l(a,b);case d("MpsTypes").ActionType.DeleteTopLevelWithPlaceholder:return m(a,b);case d("MpsTypes").ActionType.DeleteSupplemental:return n(a,b);case d("MpsTypes").ActionType.DeleteThread:return o(a,b);case d("MpsTypes").ActionType.Noop:return Promise.resolve();case d("MpsTypes").ActionType.Unknown:case d("MpsTypes").ActionType.Preprocess:return Promise.reject(c("err")("this should not happen"))}}async function j(a,b){var c=a.directive;a=a.message;await d("WebMpsReverbWrites").upsertTopLevelToReverb(a,c,b)}async function k(a,b){var e=a.directive;a=a.message;var f=c("nullthrows")(e.supplementalKey);await d("WebMpsReverbWrites").upsertSupplementalToReverb(a.messageId,a.payload,f,e.targetMessageId,a.threadId,a.timestampMs,b)}function l(a,b){var c=a.message,d=a.directive.targetMessageId,e=[c.threadId,d];return b(async function(a){var b=await a.stores.message.getByIndex("[threadId+messageId]",e),f=await a.stores.deleted.getByIndex("[threadId+deletedMessageId]",e);if(((f=f==null?void 0:f.deletionTimestampMs)!=null?f:0)>=c.timestampMs)return;f={deletedMessageId:d,deletionMessageId:c.messageId,deletionMessagePayload:c.payload,deletionTimestampMs:c.timestampMs,isLocalOnlyMessage:!1,payload:b==null?void 0:b.payload,threadId:c.threadId,timestampMs:b==null?void 0:b.timestampMs};await a.stores.deleted.bulkUpsert("[threadId+deletedMessageId]",[{item:f,selector:e}]);b&&await a.stores.message.bulkDelete([b.pk])})}function m(a,b){var c=a.directive;a=a.message;return d("WebMpsReverbWrites").upsertTopLevelToReverb(a,c,b)}function n(a,b){var d=a.message,e=c("nullthrows")(a.directive.supplementalKey),f=a.directive.targetMessageId,g=[d.threadId,f,e];return b(async function(b){var c=await b.stores.supplemental.getByIndex("[threadId+topLevelMessageId+supplementalKey]",g);if(c==null)return;var h=await b.stores.deleted.getByIndex("[threadId+topLevelMessageId+supplementalKey]",g,{filter:function(a){return a.deletionTimestampMs>=d.timestampMs}});if(h)return;h={deletedMessageId:c.messageId,deletionMessageId:d.messageId,deletionMessagePayload:d.payload,deletionTimestampMs:d.timestampMs,isLocalOnlyMessage:a.directive.isLocalOnly,payload:c.payload,supplementalKey:e,threadId:d.threadId,timestampMs:c.timestampMs,topLevelMessageId:f};await b.stores.deleted.bulkUpsert("[threadId+topLevelMessageId+supplementalKey]",[{item:h,selector:g}]);await b.stores.supplemental.bulkDelete([c.pk])})}function o(a,b){var c=a.message;return b(async function(a){var b=await a.stores.supplemental.readKeysByIndexRange("[threadId+topLevelMessageId+supplementalKey]",{only:[c.threadId]});await a.stores.supplemental.bulkDelete(b);b=await a.stores.message.readIndexRange("[threadId+messageId]",{only:[c.threadId]});await a.stores.message.bulkDelete(b.map(function(a){return a.pk}));var d=await a.stores.tags.readKeysByIndexRange("[threadId+messageId+tag]",{only:[c.threadId]});await a.stores.tags.bulkDelete(d);d=await a.stores.deleted.readKeysByIndexRange("[threadId+deletedMessageId]",{only:[c.threadId]});await a.stores.deleted.bulkDelete(d);await a.stores.deleted.bulkAdd(b.map(function(a){return{deletedMessageId:a.messageId,deletionMessageId:c.messageId,deletionMessagePayload:c.payload,deletionTimestampMs:c.timestampMs,isLocalOnlyMessage:a.isLocalOnlyMessage,payload:a.payload,threadId:a.threadId,timestampMs:a.timestampMs}}))})}g.persistNewMessages=a}),98);
__d("WebMpsLoadDeletedMessages",["MpsTypes","WebReverbDB"],(function(a,b,c,d,e,f,g){"use strict";var h=["pk","supplementalKey","threadId","topLevelMessageId"];async function a(a,b){var c=d("WebReverbDB").getWebReverbDB();c=await c.runInTransaction(["deleted","supplemental"],"readonly",async function(b){var c=await b.stores.deleted.readIndexRange("[threadId+timestampMs+deletedMessageId]",{lessThanOrEqual:[a.threadId,d("MpsTypes").toTimestamp(Number.MAX_SAFE_INTEGER)]},{limit:a.numMessages});return Promise.all(c.map(async function(c){var d=await b.stores.supplemental.readIndexRange("[threadId+topLevelMessageId+supplementalKey]",{only:[a.threadId,c.deletedMessageId]}),e=new Map();d.forEach(function(a){a.pk;var b=a.supplementalKey;a.threadId;a.topLevelMessageId;a=babelHelpers.objectWithoutPropertiesLoose(a,h);e.set(b,a)});return{deletedEntity:c,supplementalProtobufs:e}}))},"get-deleted-messages-for-spam-report");var e=c.map(function(c){if(c.deletedEntity.payload==null)return;var d=c.deletedEntity.payload;if(c.deletedEntity.timestampMs==null)return;var e=c.deletedEntity.timestampMs;return b([{otid:c.deletedEntity.deletedMessageId,supplementalProtobufs:new Map(c.supplementalProtobufs.entries().map(function(a){var b=a[0];a=a[1];return[b,{decryptedProtobuf:a.payload,protobufTimestampMS:a.timestampMs}]})),toplevelProtobuf:{decryptedProtobuf:d,protobufTimestampMS:e}}],a.threadId)[0]}).filter(Boolean);return{messages:e,tombstones:new Set(c.map(function(a){return a.deletedEntity.deletionMessageId}))}}g.loadDeletedMessages=a}),98);
__d("MpsLogProcessorErrors",["MpsLogger","WAGetSafeQPLError"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,c,e,f,g){d("MpsLogger").MpsLogger().catching(a).mustfix(b+" %s failed for message %s (source %s)",c,e,f);g.metric.addAnnotations({string:(b={},b[c.toLowerCase()+"Error"]=d("WAGetSafeQPLError").getSafeQPLErrorMessage(a),b)})}g.logProcessorError=a}),98);
__d("WebMpsPostprocess",["MpsLogProcessorErrors","MpsLogger"],(function(a,b,c,d,e,f,g){"use strict";async function a(a,b,c,e){var f=a,g=new Map();a=async function(a){var b=await a.process(f,c);b.size>0&&(b.forEach(function(b,f){g.set(f,b),d("MpsLogProcessorErrors").logProcessorError(b,"Postprocessor",a.name,f,e,c)}),f=f.filter(function(a){return!b.has(a.message.messageId)}))};for(b of b)await a(b);return{errors:g,msgs:f}}async function b(a,b,c){await Promise.all(b.map(async function(b){b=await b.process(a,c).catch(function(a){d("MpsLogger").MpsLogger().catching(a).mustfix("PostProcessor Runtime failure")});b!=null&&b.size>0&&b.forEach(function(a){d("MpsLogger").MpsLogger().catching(a).mustfix("PostProcessor fails")})}))}g.runCriticalPostprocessor=a;g.runNonCriticalPostprocessor=b}),98);
__d("WebMpsPreprocess",["MpsLogProcessorErrors"],(function(a,b,c,d,e,f,g){"use strict";async function a(a,b,c,e){var f=a,g=new Map();a=async function(a){var b=a.process!=null?a.process(f,c):await a.processAsync(f,c);f=b.payload;b.errors.forEach(function(b,f){g.set(f,b),d("MpsLogProcessorErrors").logProcessorError(b,"Preprocessor",a.name,f,e,c)})};for(b of b)await a(b);return{errors:g,msgs:f}}g.preprocess=a}),98);
__d("WebMpsPurgeDeletedPayload",["MAWMpsCleanersContants","MpsTypes","WATimeUtils","WebReverbDB"],(function(a,b,c,d,e,f,g){"use strict";function a(a){return d("WebReverbDB").getWebReverbDB().runInTransaction(["deleted","supplemental","tags","message"],"readwrite",async function(b){var c=d("MpsTypes").toTimestamp(d("WATimeUtils").unixTimeMs()-d("MAWMpsCleanersContants").REPORTING_WINDOW_IN_MS);c=await b.stores.deleted.readIndexRange("deletionTimestampMs",{lessThanOrEqual:[c]});c=c.filter(function(a){return a.payload!=null});a.metric.addAnnotations({int:{num_deletions:c.length}});await b.stores.deleted.bulkPut(c.map(function(a){return babelHelpers.extends({},a,{payload:null,timestampMs:null})}));return c.length},"web-mps-purge-deletions")}function b(){try{return d("WebReverbDB").getWebReverbDB().runInTransaction(["deleted"],"readonly",async function(a){var b=d("MpsTypes").toTimestamp(d("WATimeUtils").unixTimeMs()-d("MAWMpsCleanersContants").REPORTING_WINDOW_IN_MS);a=await a.stores.deleted.readIndexRange("deletionTimestampMs",{greaterThan:[b]},{order:"asc"});b=a.filter(function(a){return a.payload!=null});if(b.length===0||b[0].deletionTimestampMs==null)return;return d("WATimeUtils").castMilliSecondsToUnixTime(b[0].deletionTimestampMs+d("MAWMpsCleanersContants").REPORTING_WINDOW_IN_MS)},"web-mps-next-deletion-timestamp-ms")}catch(a){throw a}}g.purgeDeletedPayload=a;g.getNextDeletionTimestampMs=b}),98);
__d("WebMpsPurgeDeletions",["MAWMpsCleanersContants","MpsTypes","WATimeUtils","WebReverbDB"],(function(a,b,c,d,e,f,g){"use strict";function a(a){return d("WebReverbDB").getWebReverbDB().runInTransaction(["deleted","supplemental","tags","message"],"readwrite",async function(b){var c=d("MpsTypes").toTimestamp(d("WATimeUtils").unixTimeMs()-d("MAWMpsCleanersContants").PURGE_DELETED_MESSAGES_WINDOW_IN_MS);c=await b.stores.deleted.readIndexRange("deletionTimestampMs",{lessThanOrEqual:[c]});var e=c.map(function(a){return[a.threadId,a.deletedMessageId]});a.metric.addAnnotations({int:{num_deletions:c.length}});var f=Promise.all(e.map(function(a){return b.stores.supplemental.readKeysByIndexRange("[threadId+topLevelMessageId+supplementalKey]",{only:a})})).then(function(a){return a.flat()}).then(function(a){return b.stores.supplemental.bulkDelete(a)});e=Promise.all(e.map(function(a){return b.stores.tags.readKeysByIndexRange("[threadId+messageId+tag]",{only:a})})).then(function(a){return a.flat()}).then(function(a){return b.stores.tags.bulkDelete(a)});var g=b.stores.deleted.bulkDelete(c.map(function(a){return a.pk}));await Promise.all([f,e,g]);return c.length},"web-mps-purge-deletions")}g.purgeDeletions=a}),98);
__d("WebMpsScheduler",["WorkerScheduler","justknobx"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(){if(h==null){var a;h=d("WorkerScheduler").makeScheduler("MPS",{concurrency:(a=c("justknobx"))._("4338"),defaultSamplingRate:a._("4540"),maxTaskLimit:a._("4338"),maxThrottleMs:a._("4339"),timeoutMs:a._("4337")})}return h}g.mpsScheduler=a}),98);
__d("memoizeWithArgsLFUCache",["LFUCache"],(function(a,b,c,d,e,f,g){function a(a,b,d,e){var f;function g(){f||(f=new(c("LFUCache"))(d));return f}function h(){f=null}e&&e(h);e=function(){var c=g(),d=b.apply(void 0,arguments);c.has(d)||c.set(d,a.apply(void 0,arguments));var e=c.get(d);return e};return e}g["default"]=a}),98);
__d("mergeMaps",[],(function(a,b,c,d,e,f){"use strict";function a(){var a=new Map();for(var b=arguments.length,c=new Array(b),d=0;d<b;d++)c[d]=arguments[d];for(var e=0;e<c.length;e++){var f=c[e].keys(),g;while(!(g=f.next()).done)a.set(g.value,c[e].get(g.value))}return a}f["default"]=a}),66);
__d("schedulePeriodicTask",[],(function(a,b,c,d,e,f){"use strict";function a(a,b){var c=async function(){try{await a()}finally{globalThis.setTimeout(c,b)}};globalThis.setTimeout(c,0)}f.schedulePeriodicTask=a}),66);
__d("WebMps",["DateConsts","MpsDeletedCleaner","MpsEphemeralCleaner","MpsLogger","MpsReverbDbDump","MpsReverbInit","MpsTypes","WAPromiseQueue","WAResultOrError","WATimeUtils","WAWaitForUserUnblocked","WebMpsBatchLoadMessage","WebMpsBatchLoadMessages","WebMpsInsertionCleaners","WebMpsInsertionFlow","WebMpsLoadDeletedMessages","WebMpsPostprocess","WebMpsPreprocess","WebMpsPurgeDeletedPayload","WebMpsPurgeDeletions","WebMpsPurgeExpiredMessages","WebMpsScheduler","WorkerScheduler","err","getErrorSafe","justknobx","memoizeWithArgsLFUCache","mergeMaps","nullthrows","schedulePeriodicTask"],(function(a,b,c,d,e,f,g){"use strict";var h=["debug"],i=["debug"],j;async function a(a){var b=a.db,e=a.dependencies;a=a.getMpsExtensionConfiguration;if(j!=null)throw c("err")("MPS already initialised");await d("MpsReverbInit").initReverb(b);b=new k(a(),e);j=b;return b}var k=function(){function a(a,b){var e=this;this.$2=[];this.$5=new(d("WAPromiseQueue").PromiseQueue)();this.batchLoadMessage=function(a){var b=a.config,f=a.debug,g=a.messageIds,h=a.threadId;return d("WebMpsScheduler").mpsScheduler().runTask({annotations:{string:{purpose:f.purpose,strategy:(a=b==null?void 0:b.strategy)!=null?a:"full-fetch"}},customFlags:{runtimeReliability:!0},eventSamplingRate:c("justknobx")._("4538"),fn:function(a){var c;return d("WebMpsBatchLoadMessage").batchLoadMessage(h,g,e.$1,{persistToReverb:(c=b==null?void 0:b.persistToReverb)!=null?c:"persist",shouldFetchSupplementals:(c=b==null?void 0:b.shouldFetchSupplementals)!=null?c:!0,shouldFetchTags:(c=b==null?void 0:b.shouldFetchTags)!=null?c:!0,strategy:(c=b==null?void 0:b.strategy)!=null?c:"full-fetch"},a)},name:"batch-load-message",priority:d("WorkerScheduler").BLOCKING_PRIORITY}).then(function(a){return d("WAResultOrError").makeResult(a)}).catch(function(a){a=c("getErrorSafe")(a);return d("WAResultOrError").DEPRECATED_makeError("runtime-error",a)})};this.$8=c("memoizeWithArgsLFUCache")(function(a){var b=a.config,f=a.debug,g=a.messageId,h=a.threadId;return d("WebMpsScheduler").mpsScheduler().runTask({annotations:{string:{purpose:f.purpose,strategy:(a=b==null?void 0:b.strategy)!=null?a:"full-fetch"}},customFlags:{runtimeReliability:!0},eventSamplingRate:c("justknobx")._("4536"),fn:function(a){var c;return d("WebMpsBatchLoadMessage").batchLoadMessage(h,[g],e.$1,{persistToReverb:(c=b==null?void 0:b.persistToReverb)!=null?c:"persist",shouldFetchSupplementals:(c=b==null?void 0:b.shouldFetchSupplementals)!=null?c:!0,shouldFetchTags:(c=b==null?void 0:b.shouldFetchTags)!=null?c:!0,strategy:(c=b==null?void 0:b.strategy)!=null?c:"full-fetch"},a).then(function(a){a.length>1&&d("MpsLogger").MpsLogger().mustfix("loadMessage returned more than one message");return a.at(0)})},name:"load-message",priority:d("WorkerScheduler").BLOCKING_PRIORITY})},function(a){a.debug;a=babelHelpers.objectWithoutPropertiesLoose(a,h);return JSON.stringify(babelHelpers.extends({},a,{ebEnabled:e.$1.eb.isEbEnabled()}))},1,function(a){e.$2.push(a)});this.loadMessage=function(a){return e.$8(a).then(function(a){return d("WAResultOrError").makeResult(a)}).catch(function(a){e.$6();a=c("getErrorSafe")(a);return d("WAResultOrError").DEPRECATED_makeError("runtime-error",a)})};this.$9=function(a){var b=a.config,f=a.debug,g=a.ranges;return d("WebMpsScheduler").mpsScheduler().runTask({annotations:{string:{purpose:f.purpose,strategy:(a=b==null?void 0:b.strategy)!=null?a:"full-fetch"}},customFlags:{runtimeReliability:!0},eventSamplingRate:c("justknobx")._("4538"),fn:function(a){var c;return d("WebMpsBatchLoadMessages").batchLoadMessages(g.map(function(a){var b=a.direction,c=a.from,e=a.numMessages;a=a.threadId;return{direction:b,from:[d("MpsTypes").toTimestamp(d("WATimeUtils").miAdjustTimestamp(c[0])),c[1]],numMessages:e,threadId:a}}),e.$1,{persistToReverb:(c=b==null?void 0:b.persistToReverb)!=null?c:"persist",shouldFetchSupplementals:(c=b==null?void 0:b.shouldFetchSupplementals)!=null?c:!0,shouldFetchTags:(c=b==null?void 0:b.shouldFetchTags)!=null?c:!0,shouldIgnoreLocalOnly:(c=b==null?void 0:b.shouldIgnoreLocalOnly)!=null?c:!1,strategy:(c=b==null?void 0:b.strategy)!=null?c:"full-fetch",tagsFilter:(c=b==null?void 0:b.tagsFilter)!=null?c:"all"},a)},name:"thread-range-query",priority:d("WorkerScheduler").BLOCKING_PRIORITY})};this.batchLoadMessages=function(a){return e.$9(a).then(function(a){return d("WAResultOrError").makeResult(a)}).catch(function(a){a=c("getErrorSafe")(a);return d("WAResultOrError").DEPRECATED_makeError("runtime-error",a)})};this.$10=c("memoizeWithArgsLFUCache")(function(a){var b=a.config,f=a.debug,g=a.direction,h=a.from,i=a.numMessages,j=a.threadId;return d("WebMpsScheduler").mpsScheduler().runTask({annotations:{string:{purpose:f.purpose,strategy:(a=b==null?void 0:b.strategy)!=null?a:"full-fetch"}},customFlags:{runtimeReliability:!0},eventSamplingRate:c("justknobx")._("4538"),fn:function(a){var f;return d("WebMpsBatchLoadMessages").batchLoadMessages([{direction:g,from:[d("MpsTypes").toTimestamp(d("WATimeUtils").miAdjustTimestamp(h[0])),h[1]],numMessages:i,threadId:j}],e.$1,{persistToReverb:(f=b==null?void 0:b.persistToReverb)!=null?f:"persist",shouldFetchSupplementals:(f=b==null?void 0:b.shouldFetchSupplementals)!=null?f:!0,shouldFetchTags:(f=b==null?void 0:b.shouldFetchTags)!=null?f:!0,shouldIgnoreLocalOnly:(f=b==null?void 0:b.shouldIgnoreLocalOnly)!=null?f:!1,strategy:(f=b==null?void 0:b.strategy)!=null?f:"full-fetch",tagsFilter:(f=b==null?void 0:b.tagsFilter)!=null?f:"all"},a).then(function(a){a.length>1&&d("MpsLogger").MpsLogger().mustfix("loadMessages returned more than one range");a=a.at(0);if(a==null)throw c("err")("loadMessages returned no result. Likely this is the result of both reverb and EB queries failing");return a})},name:"load-messages",priority:d("WorkerScheduler").BLOCKING_PRIORITY})},function(a){a.debug;a=babelHelpers.objectWithoutPropertiesLoose(a,i);return JSON.stringify(babelHelpers.extends({},a,{ebEnabled:e.$1.eb.isEbEnabled()}))},10/60,function(a){e.$2.push(a)});this.loadMessages=function(a){return e.$10(a).then(function(a){return d("WAResultOrError").makeResult(a)}).catch(function(a){e.$6();a=c("getErrorSafe")(a);return d("WAResultOrError").DEPRECATED_makeError("runtime-error",a)})};this.extensionConfiguration=a;this.$1=b;this.$3(function(a){return b.generateDeletionMessage(a)});this.$4(function(a){return b.generateDeletionMessage(a)})}var b=a.prototype;b.saveNewMessages=function(a,b){var e=this,f=d("WebMpsScheduler").mpsScheduler().task({annotations:{string:{source:b.source}},customFlags:{runtimeReliability:!0},eventSamplingRate:c("justknobx")._("4535"),fn:async function(f){e.$6();f.metric.addPoint("preprocess_start");var g=await d("WebMpsPreprocess").preprocess(a,e.extensionConfiguration.preprocessors,f,b.source),h=g.errors;g=g.msgs;f.metric.addPoint("preprocess_end");g=g.map(function(a){return babelHelpers.extends({},a,{directive:c("nullthrows")(a.directive,"Preprocessed messages must have a directive")})});c("justknobx")._("4033")&&(f.metric.addPoint("schedule_cleaners_start"),await d("WebMpsInsertionCleaners").scheduleCleaners(g),f.metric.addPoint("schedule_cleaners_end"));f.metric.addPoint("persist_start");var i=await d("WebMpsInsertionFlow").persistNewMessages(g);f.metric.addPoint("persist_end");f.metric.addPoint("postprocess_start");g=await e.$7(g,f,b.source);f.metric.addPoint("postprocess_end");return c("mergeMaps")(h,i,g)},name:"save-new-messages",priority:d("WorkerScheduler").BLOCKING_PRIORITY});return this.$5.enqueue(function(){return f.run()})};b.$7=async function(a,b,e){var f,g;try{a=await d("WebMpsPostprocess").runCriticalPostprocessor(a,this.extensionConfiguration.postProcessors.critical,b,e);f=a.errors;g=a.msgs}catch(a){e=c("getErrorSafe")(a);d("MpsLogger").MpsLogger().catching(e).mustfix("Message postprocessor failed with runtime error");throw e}d("WebMpsPostprocess").runNonCriticalPostprocessor(g,this.extensionConfiguration.postProcessors.nonCritical,b).catch(function(a){a=c("getErrorSafe")(a);d("MpsLogger").MpsLogger().catching(a).mustfix("Non-critical postprocessor failed with runtime error")});return f};b.purgeDeletions=async function(){try{await d("WAWaitForUserUnblocked").waitForUserUnblocked();return d("WebMpsScheduler").mpsScheduler().runTask({fn:d("WebMpsPurgeDeletions").purgeDeletions,name:"purge-deletions",priority:d("WorkerScheduler").BACKGROUND_PRIORITY})}catch(a){d("MpsLogger").MpsLogger().catching(c("getErrorSafe")(a)).mustfix("failed running purgeDeletions");return 0}};b.purgeDeletedPayload=async function(){try{await d("WAWaitForUserUnblocked").waitForUserUnblocked();return d("WebMpsScheduler").mpsScheduler().runTask({fn:d("WebMpsPurgeDeletedPayload").purgeDeletedPayload,name:"purge-deleted-payload",priority:d("WorkerScheduler").BACKGROUND_PRIORITY})}catch(a){d("MpsLogger").MpsLogger().catching(c("getErrorSafe")(a)).mustfix("failed running purgeDeletedPayload");return 0}};b.getNextDeletionTimestampMs=async function(){try{await d("WAWaitForUserUnblocked").waitForUserUnblocked();return d("WebMpsScheduler").mpsScheduler().runTask({fn:d("WebMpsPurgeDeletedPayload").getNextDeletionTimestampMs,name:"get-next-deletion-timestamp-ms",priority:d("WorkerScheduler").BACKGROUND_PRIORITY})}catch(a){d("MpsLogger").MpsLogger().catching(c("getErrorSafe")(a)).mustfix("failed running getNextDeletionTimestampMs")}};b.purgeExpiredMessages=async function(a){try{await d("WAWaitForUserUnblocked").waitForUserUnblocked();return d("WebMpsScheduler").mpsScheduler().runTask({eventSamplingRate:c("justknobx")._("4539"),fn:function(b){return d("WebMpsPurgeExpiredMessages").purgeExpiredMessages(a,b)},name:"purge-expired-messages",priority:d("WorkerScheduler").BACKGROUND_PRIORITY})}catch(a){d("MpsLogger").MpsLogger().catching(c("getErrorSafe")(a)).mustfix("failed running purgeExpiredMessages");return 0}};b.getNextExpiryTimestampMs=async function(){try{await d("WAWaitForUserUnblocked").waitForUserUnblocked();return d("WebMpsScheduler").mpsScheduler().runTask({eventSamplingRate:c("justknobx")._("4539"),fn:d("WebMpsPurgeExpiredMessages").getNextExpiryTimestampMs,name:"get-next-expire-timestamp-ms",priority:d("WorkerScheduler").BACKGROUND_PRIORITY})}catch(a){d("MpsLogger").MpsLogger().catching(c("getErrorSafe")(a)).mustfix("failed running getNextExpiryTimestampMs")}};b.debugDbDump=function(){return d("MpsReverbDbDump").debugGetReverbDbDump()};b.spamReportLoadMessages=function(a){var b=this;return d("WebMpsScheduler").mpsScheduler().runTask({fn:async function(){var c=await Promise.all([b.$10({config:{persistToReverb:"no-persist",shouldFetchSupplementals:!0,shouldFetchTags:!1,shouldIgnoreLocalOnly:!1,strategy:"local-only",tagsFilter:"all"},debug:{purpose:"get-latest-msgs-for-spam-report"},direction:"desc",from:[d("MpsTypes").toTimestamp(Number.MAX_SAFE_INTEGER),null],numMessages:a.numMessages,threadId:a.threadId}),d("WebMpsLoadDeletedMessages").loadDeletedMessages(a,b.$1.decryptedProtobufToFullMessage)]),e=c[0],f=c[1];c=e.messages.filter(function(a){return!f.tombstones.has(a.toplevelProtobuf.messageId)});return[].concat(c,f.messages).toSorted(function(a,b){return b.toplevelProtobuf.timestampMs-a.toplevelProtobuf.timestampMs}).slice(0,a.numMessages)},name:"get-latest-msgs-for-spam-report"})};b.$6=function(){this.$2.forEach(function(a){return a()})};b.$3=function(a){var b=this;d("schedulePeriodicTask").schedulePeriodicTask(function(){return b.purgeDeletions()},d("DateConsts").MS_PER_MIN*20);c("justknobx")._("4033")||d("schedulePeriodicTask").schedulePeriodicTask(function(){return b.purgeExpiredMessages(a)},d("DateConsts").MS_PER_MIN*10)};b.$4=function(a){var b=this;c("justknobx")._("4033")&&(d("MpsEphemeralCleaner").startMpsEphemeralCleaner({getNextTs:function(){return b.getNextExpiryTimestampMs()},purgeEnabled:function(){return!0},removeExpired:function(){return b.purgeExpiredMessages(a)}}),d("MpsDeletedCleaner").startMpsDeletedCleaner({getNextTs:function(){return b.getNextDeletionTimestampMs()},purgeEnabled:function(){return!0},removeExpired:function(){return b.purgeDeletedPayload()}}))};return a}();function b(){if(j==null)throw c("err")("MPS not initialised");return j}function e(){j=void 0}g.makeMps=a;g.mps=b;g.resetMps_TEST_ONLY=e}),98);
__d("WebMpsPurgeExpiredMessages",["MpsTypes","WATimeUtils","WebMps","WebReverbDB"],(function(a,b,c,d,e,f,g){"use strict";var h=["debugFlags","expiryTimestampMs","isLocalOnlyMessage","isTransportErrorPlaceholder","pk","timestampMs"];async function a(a,b){var c=d("MpsTypes").toTimestamp(d("WATimeUtils").unixTimeMs()),e=await d("WebReverbDB").getWebReverbDB().runInTransaction(["message","deleted"],"readonly",async function(a){a=await a.stores.message.readIndexRange("expiryTimestampMs",{lessThanOrEqual:[c]});b.metric.addAnnotations({int:{num_expired_messages:a.length}});return a},"web-mps-purge-deletions");if(e.length===0)return 0;var f=e.map(function(b){b.debugFlags;b.expiryTimestampMs;b.isLocalOnlyMessage;b.isTransportErrorPlaceholder;b.pk;b.timestampMs;b=babelHelpers.objectWithoutPropertiesLoose(b,h);return{directive:null,insertionSource:d("MpsTypes").InsertionSource.Send,message:a(babelHelpers.extends({},b,{timestampMs:c}))}});await d("WebMps").mps().saveNewMessages(f,{source:"purge-expired-messages"});return e.length}function b(){try{return d("WebReverbDB").getWebReverbDB().runInTransaction(["message"],"readonly",async function(a){var b=d("MpsTypes").toTimestamp(d("WATimeUtils").unixTimeMs());a=await a.stores.message.readIndexRange("expiryTimestampMs",{greaterThan:[b]},{limit:1,order:"asc"});if(a.length===0||a[0].expiryTimestampMs==null)return;return d("WATimeUtils").castMilliSecondsToUnixTime(a[0].expiryTimestampMs)},"web-mps-next-expiry-timestamp-ms")}catch(a){throw a}}g.purgeExpiredMessages=a;g.getNextExpiryTimestampMs=b}),98);
__d("MAWBridgeEventTransmitter",["EBAPI","EBLogger","LSIntEnum","LSMEBTaskCreationSource","MAWBridge","MAWBridgeTrace","MAWBridgeTypesCreators","MAWBridgeUpload","MAWIndexedDb","MAWJobDefinitions","MAWUploadThreadTxns","MpsTypes","WAJids","WALogger","WATimeUtils","WebMps"],(function(a,b,c,d,e,f,g){"use strict";var h,i;function a(a,b,e,f){d("WALogger").LOG(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Issuing point query for message: ",""])),a);if(c("EBAPI").isEBEnabled()===!1)return;void d("WebMps").mps().loadMessage({config:{shouldFetchSupplementals:!0,shouldFetchTags:!1,strategy:"full-fetch"},debug:{purpose:"issuePointQueryOutsideTxn"},messageId:d("MpsTypes").toMessageId(a),threadId:d("MpsTypes").toThreadId(f)}).then(function(a){a=a.value;if(a==null)return;void d("MAWBridge").getBridge().sendAndReceive("event","uiUpdate",{events:[{tag:"RestoreNativeOp",value:{chatJid:f,decryptedMessagesProtobufs:[d("MAWJobDefinitions").mpsMessageToEncryptedBackupsMessage(a)],hasMoreAfter:!1,hasMoreBefore:!1,isPointQuery:!0,taskSource:(i||(i=d("LSIntEnum"))).ofNumber(e!=null?e:c("LSMEBTaskCreationSource").UNKNOWN),threadId:b}}]})["catch"](function(a){return d("EBLogger").EBLogger().tags(["eventTransmitter","mps"]).catching(a).warn("failure while executing UI update")})})}function b(a,b){d("MAWIndexedDb").afterTransaction({tag:"DeleteMessagesOfThread",value:d("MAWBridgeUpload").createBridgeDeleteMessagesOfThread(d("WAJids").threadIdForChatJid(a.jid),d("MAWUploadThreadTxns").getFolderTypeAsText(a.folder),"AdvancedCrypto",b!=null?b:d("WATimeUtils").castToMillisTime(1),null,2)})}function e(a,b,c){d("MAWBridge").getBridge().fireAndForget("event","uiUpdate",{events:[{tag:"StartTrace",value:d("MAWBridgeTrace").createBridgeStartTraceData(a,b,c)}]})}function f(a,b,c){d("MAWBridge").getBridge().fireAndForget("event","uiUpdate",{events:[{tag:"ThreadUpdated",value:d("MAWBridgeTypesCreators").createBridgeUpdatedThread({cannotReplyReason:a,folder:b,threadJid:c})}]})}g.issuePointQueryOutsideTxn=a;g.deleteMessagesOfThreadAfterTxn=b;g.startTraceOutsideTxn=e;g.updateThreadOutsideTxn=f}),98);
__d("MAWQuotedMsgUtils",["WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";function h(a){return a.content.type==="NoteReply"?a.content.msgContent==null?a:babelHelpers["extends"]({},a,{content:babelHelpers["extends"]({},a.content,{msgContent:void 0})}):a}function a(a){return a.content.expirationTs==null||a.content.expirationTs>d("WATimeUtils").unixTime()?a:h(a)}g.dbQuotedMsgWithoutExpirableContent=h;g.dbQuotedMsgWithoutExpiredContent=a}),98);
__d("MAWGetMsgQuoteTxn",["LSMEBTaskCreationSource","MAWBridgeEventTransmitter","MAWBridgeMsg","MAWDbMsgTxns","MAWDexieTable","MAWIndexedDb","MAWMsgType","MAWQuotedMsgUtils","MAWTransactionMode","WAJids","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";var h=function(a){return a==null||a===d("WAJids").AUTHOR_SYSTEM?null:d("WAJids").authorAsUserJid(a)};function i(a,b,e,f){var g=b.quote;b=(g==null?void 0:g.content)||{};var i=b.author;b=b.externalId;if(i==null)return d("MAWDexieTable").dexieResolve(null);i=d("WAJids").isAuthorMe(i)?d("WAJids").AUTHOR_ME:h(i);if(g==null||i==null||b==null)return d("MAWDexieTable").dexieResolve(null);var j={author:i,chat:e,externalId:b};if(g.content.type==="NoteReply")return d("MAWDexieTable").dexieResolve({quote:d("MAWQuotedMsgUtils").dbQuotedMsgWithoutExpiredContent(g),quoteExternalId:g.content.externalId});var k=f!=null&&f==="ebrestore"?c("LSMEBTaskCreationSource").EB_POINT_QUERY_RESTORE_PROTOBUF:c("LSMEBTaskCreationSource").EB_POINT_QUERY_IN_ACT;return d("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(a,j).then(function(b){d("MAWBridgeEventTransmitter").issuePointQueryOutsideTxn(j.externalId,d("WAJids").threadIdForChatJid(j.chat),k,j.chat);if(b==null||!d("MAWMsgType").isQuotedMsgType(b.type))return{quote:g,quoteExternalId:g.content.externalId};d("MAWIndexedDb").afterTransaction({tag:"NewMsg",value:d("MAWBridgeMsg").createBridgeMsg(b,null,!0)});var a=b.author,c=b.externalId,e=b.mediaId,f=b.msgContent,h=b.msgId,i=b.plaintextHash,l=b.specialTextSize,m=b.ts,n=b.type,o=b.xmaMessageType;a={author:a,externalId:c,mediaId:e,msgContent:f,msgId:h,plaintextHash:i,specialTextSize:l,ts:m,type:n,xmaMessageType:o};b.messageExpirationTs!=null&&b.messageExpirationTs<d("WATimeUtils").unixTime()&&(a=babelHelpers["extends"]({},a,{mediaId:void 0,msgContent:void 0,type:d("MAWMsgType").MSG_TYPE.EXPIRED_EPHEMERAL}));return{quote:babelHelpers["extends"]({},g,{content:a}),quoteExternalId:b.externalId}})}function a(a,b,c){return i(a,b,c).then(function(a){return babelHelpers["extends"]({},b,{quote:a==null?void 0:a.quote,quoteExpirationTs:a==null?void 0:a.quote.content.expirationTs,quoteExternalId:a==null?void 0:a.quoteExternalId})})}function j(a,b){return a.messages.where("quoteExternalId").anyOf(b).toArray()}b=d("MAWIndexedDb").makeMsgrTransactor({messages:d("MAWTransactionMode").READONLY},"maybeBatchGetMsgsByQuoteExternalId",function(a){return function(){for(var b=arguments.length,c=new Array(b),d=0;d<b;d++)c[d]=arguments[d];return j.apply(void 0,[a].concat(c))}});g.getMsgQuoteInfo=i;g.enhanceMsgWithQuoteInfo=a;g.maybeBatchGetMsgsByQuoteExternalId=j;g.maybeBatchGetMsgsByQuoteExternalIdWithTransaction=b}),98);
__d("MAWThreadEventConst",[],(function(a,b,c,d,e,f){"use strict";a="placeholderConvertSubscription";f.PLACEHOLDER_CONVERT_SUBSCRIPTION=a}),66);
__d("MAWUpdateQuotedMsgTxns",["MAWAuthor","MAWBridgeMsg","MAWDbXMATxns","MAWDexieTable","MAWIndexedDb","MAWLoadReplyMediaTxns","MAWMsgType","WAJids"],(function(a,b,c,d,e,f,g){"use strict";var h=function(a,b,c,e,f,g,h){var i=d("MAWAuthor").getAuthorUserJid(e);return a.messages.where("quoteExternalId").equals(c).toArray().then(function(c){if(c.length===0)return;var e=c;(h==null||!h)&&(e=c.filter(function(a){var c=a.quote;a=a.threadJid;return d("MAWAuthor").getAuthorUserJid(c==null?void 0:c.content.author)===i&&a===b}));var j=e.map(function(a){var b;b=Object.assign({},(b=a.quote)==null?void 0:b.content,f.content);b=babelHelpers["extends"]({},a.quote,f,{content:b});b.content.msgId==null&&g!=null&&(b.content.msgId=g);return babelHelpers["extends"]({},a,{quote:b})});return a.messages.bulkPut(j).then(function(){return j})})},i=function(a,b,c,e,f){f===void 0&&(f=d("MAWMsgType").MSG_TYPE.UNAVAILABLE);f={content:{mediaId:void 0,msgContent:void 0,type:f}};return h(a,b,c,e,f).then(function(a){if(a==null)return;a.forEach(function(a){d("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:d("MAWBridgeMsg").createBridgeMsg(a)})})})};b=function(a,b,c){c===void 0&&(c=d("MAWMsgType").MSG_TYPE.UNAVAILABLE);var e=b.author,f=b.chat,g=b.externalId;return a.threads.get({jid:f}).then(function(b){if(b==null)return;return i(a,b.jid,g,e,c)})};var j=function(a,b,c,e){var f=c.author,g=c.externalId,i=c.mediaId,j=c.msgContent,k=c.msgId,l=c.plaintextHash,m=c.ts,n=c.type;if(d("WAJids").isAuthorSystem(f))return d("MAWDexieTable").dexieResolve();var o={author:f,chat:b,externalId:g};if(!d("MAWMsgType").isQuotedMsgType(n))return d("MAWDexieTable").dexieResolve();var p=d("MAWDexieTable").dexieResolve(null);c.type===d("MAWMsgType").MSG_TYPE.XMA&&(p=d("MAWDbXMATxns").maybeGetXMAPayloadFromProtocolMsgId(a,o).then(function(a){return a.success===!1?d("MAWDexieTable").dexieResolve(null):d("MAWDexieTable").dexieResolve(a.value)}));return p.then(function(c){var d,o,p,q;d={author:f,externalId:g,mediaId:(d=c==null||(o=c.defaultPreview)==null?void 0:o.mediaId)!=null?d:i,msgContent:j,plaintextHash:(d=c==null||(p=c.defaultPreview)==null?void 0:p.plaintextHash)!=null?d:l,ts:m,type:n,xmaMessageType:c==null||(q=c.xma)==null?void 0:q.targetType};return h(a,b,g,f,{content:d},k,e)})};function a(a,b,c){return d("MAWDexieTable").dexieAll([j(a,c,b),d("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(a,b)]).then(function(c){var e=c[0];c=c[1];if(e!=null)return d("MAWDexieTable").dexieResolve(k(b,c)).then(function(){d("MAWDexieTable").dexieAll(e.map(function(b){return d("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(a,b).then(function(a){k(b,a);return b})}))});else return d("MAWDexieTable").dexieResolve([])})}function k(a,b){d("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:d("MAWBridgeMsg").createBridgeMsg(a,b)})}g.disassociateQuotedMsg=i;g.disassociateQuotedMessageByProtocolMsgId=b;g.associateQuotedMessage=j;g.associateAllReplies=a;g.issueReplyMsgUpdate=k}),98);
__d("MAWCreateE2EEMetadataThreadFromThreadActivityUpdate",["FBLogger","MAWAuthoritativeThreadsCache","MAWDbThreadTxns","MAWDexieTable","MAWFolderTypes","MAWIndexedDb"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){var c=b.bumpTimestampMs,e=b.chatJid;b=b.source;var f=h(b);return d("MAWAuthoritativeThreadsCache").AuthoritativeThreadsCache.has(e)||f==="invalid_source"?d("MAWDexieTable").dexieResolve():d("MAWDbThreadTxns").getThread(a,e).then(function(a){var b;a=a.value;if((a==null?void 0:a.authoritativeThreadKey)!=null){d("MAWAuthoritativeThreadsCache").AuthoritativeThreadsCache.add(a.jid);return}d("MAWIndexedDb").afterTransaction({tag:"CreateE2EEMetadataThreadV2",value:{bumpTimestampMs:c,creationSource:f,folderId:(b=a==null?void 0:a.folder)!=null?b:d("MAWFolderTypes").INBOX,jid:e,optimisticThreadKey:a==null?void 0:a.optimisticThreadKey}})})}function h(a){switch(a){case"outgoing_msg":return"outgoing_message";case"incoming_msg":return"incoming_message";case"inserted_admin_msg":case"eb_restore":case"deleted_msg":return"invalid_source";default:a;throw c("FBLogger")("messenger_web").mustfixThrow("Unknown thread update source")}}g.maybeCallCreateE2EEMetadataThreadHandler=a}),98);
__d("MAWThreadLatestTimestampCache",["I64","MAWGetBumpTimestampMs"],(function(a,b,c,d,e,f,g){"use strict";var h;a=function(){function a(){this.$1=new Map()}var b=a.prototype;b.isLatestTs=function(a,b){a=this.$1.get(a);b=d("MAWGetBumpTimestampMs").getBumpTimestampMs(b);return a==null||(h||(h=d("I64"))).ge(b,a)};b.isNewerThanLatestTs=function(a,b){a=this.$1.get(a);b=d("MAWGetBumpTimestampMs").getBumpTimestampMs(b);return a==null||(h||(h=d("I64"))).gt(b,a)};b.monotonicIncrease=function(a,b){b=d("MAWGetBumpTimestampMs").getBumpTimestampMs(b);var c=this.$1.get(a);(c==null||(h||(h=d("I64"))).gt(b,c))&&this.$1.set(a,b)};b.get=function(a){return this.$1.get(a)};b.set=function(a,b){b=d("MAWGetBumpTimestampMs").getBumpTimestampMs(b);this.$1.set(a,b)};b.clear=function(){this.$1.clear()};return a}();b=new a();g.ThreadLatestTimestampCache=a;g.ThreadLastActivityTsCache=b}),98);
__d("MAWUpdateThreadActivity",["FBLogger","MAWCreateE2EEMetadataThreadFromThreadActivityUpdate","MAWDexieTable","MAWGetBumpTimestampMs","MAWGetThreadUpdateType","MAWIndexedDb","MAWMpsGating","MAWThreadLatestTimestampCache","MAWThreadNewestMsgOrReactionUtils","MAWTransactionMode","MAWUpdateThreadListItemUtils","WAJids"],(function(a,b,c,d,e,f,g){"use strict";b=d("MAWIndexedDb").makeMsgrTransactor({threads:(a=d("MAWTransactionMode")).READONLY},"updateThreadActivityFromInsertion",function(a){return function(b,c,d){return h(a,b,c,d)}});function h(a,b,e,f){d("MAWMpsGating").isMpsThreadsConsistencyEnabled()&&c("FBLogger")("wmi").mustfix("Thread consistency uses MAW DB mechanism instead of new one");if(!j(e,b,f))return d("MAWDexieTable").dexieResolve();d("MAWThreadLatestTimestampCache").ThreadLastActivityTsCache.monotonicIncrease(e,b);var g={bumpTimestampMs:d("MAWGetBumpTimestampMs").getBumpTimestampMs(b),chatJid:e,source:f};return d("MAWCreateE2EEMetadataThreadFromThreadActivityUpdate").maybeCallCreateE2EEMetadataThreadHandler(a,g).then(function(){d("MAWIndexedDb").afterTransaction({tag:"UpdateThreadActivity",value:{bumpTimestampMs:g.bumpTimestampMs,chatJid:e,source:g.source}})})}e=d("MAWIndexedDb").makeMsgrTransactor({messages:a.READONLY,reactions:a.READONLY,threads:a.READONLY},"updateThreadActivityFromDeletion",function(a){return function(b,c){return i(a,b,c)}});function i(a,b,e){if(!j(e,b,"deleted_msg"))return d("MAWDexieTable").dexieResolve();d("MAWMpsGating").isMpsThreadsConsistencyEnabled()&&c("FBLogger")("wmi").mustfix("Thread consistency uses MAW DB mechanism instead of new one");return d("MAWThreadNewestMsgOrReactionUtils").getNewestMsgOrReactionForBump(a,e).then(function(a){if(a==null)return;d("MAWThreadLatestTimestampCache").ThreadLastActivityTsCache.set(e,a);d("MAWIndexedDb").afterTransaction({tag:"UpdateThreadActivity",value:{bumpTimestampMs:d("MAWGetBumpTimestampMs").getBumpTimestampMs(a),chatJid:e,source:"deleted_msg"}})})}function j(a,b,e){if(!d("MAWGetThreadUpdateType").isThreadUpdateTypeEligibleForBump(b)||d("MAWUpdateThreadListItemUtils").isSpamMessage(b)||d("MAWUpdateThreadListItemUtils").isOptimisticMessage(b))return!1;switch(e){case"outgoing_msg":return!0;case"incoming_msg":return d("MAWThreadLatestTimestampCache").ThreadLastActivityTsCache.isNewerThanLatestTs(a,b)&&(b.author!==d("WAJids").AUTHOR_ME||d("MAWUpdateThreadListItemUtils").isRTCXMAMessage(b));case"eb_restore":return!1;case"inserted_admin_msg":return!1;case"deleted_msg":return d("MAWThreadLatestTimestampCache").ThreadLastActivityTsCache.isLatestTs(a,b);default:e;throw c("FBLogger")("messenger_web").mustfixThrow("Unknown thread update source")}}g.updateThreadActivityFromInsertion=b;g.updateThreadActivityFromInsertionTxn=h;g.updateThreadActivityFromDeletion=e;g.updateThreadActivityFromDeletionTxn=i}),98);
__d("MAWUseProtocolMsgIdForMsgId",[],(function(a,b,c,d,e,f){"use strict";function a(){return!0}f.shouldUseProtocolMsgIdForMsgId=a}),66);
__d("MAWBridgeParticipants",["MAWBridgeParticipantsUpdatedHandler","WAJids","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";function h(a){var b=a.deliveredWatermarkTs,c=a.threadJid,e=a.type;a=a.userJid;return babelHelpers["extends"]({deliveredWatermarkTs:b||d("WATimeUtils").castToUnixTime(0),fbid:d("WAJids").extractUserId(a)},d("MAWBridgeParticipantsUpdatedHandler").mawToLsParticipantTypeConversion(e),{lastReadActionTs:d("WATimeUtils").castToUnixTime(0),readWatermarkTs:d("WATimeUtils").castToUnixTime(0),threadJid:c})}function a(a){return{participants:a.map(function(a){return h(a)})}}g.createBridgeParticipant=h;g.createBridgeParticipants=a}),98);
__d("MAWDbParticipantTxns",["MAWBridgeParticipants","MAWBridgeTypesCreators","MAWCurrentUser","MAWDbParticipant","MAWDexieTable","MAWIndexedDb","MAWODSProxy","MAWUserJidWrapper","MWFBLogger","WAJids","WAOdsEnums","WAResultOrError","WATimeUtils","emptyFunction"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j;function k(a,b,c,d){d===void 0&&(d=!0);return n(a,c.map(function(a){return babelHelpers["extends"]({},a,{chatJid:b})}),d)}function l(a,b){d("WAJids").switchOnMsgrChatJidType(a.threadJid,{group:c("emptyFunction"),user:function(c){a.userJid!==c&&a.userJid!==d("MAWUserJidWrapper").getMyUserJid()&&d("MWFBLogger").MWLogger().tags(["db","txn"]).mustfix("Attempting to insert participant to a mismatched one-on-one thread at %s",b)}})}function m(a){var b=a.addressable,c=a.chatJid,e=a.type;a=a.userJid;return{addressable:b,deliveredWatermarkTs:d("WATimeUtils").castToUnixTime(0),id:d("MAWDbParticipant").craftParticipantId(c,a),lastReadWatermarkTs:d("WATimeUtils").castToUnixTime(0),threadJid:c,type:e!=null?e:"participant",userJid:a}}function n(a,b,c){c===void 0&&(c=!0);if(b.length===0)return d("MAWDexieTable").dexieResolve([]);var e=b.map(function(a){return m(a)});e.forEach(function(a){return l(a,"bulkAddParticipantsInThreads")});return a.participants.bulkPut(e).then(function(){c&&d("MAWIndexedDb").afterTransaction({tag:"ParticipantsUpdated",value:d("MAWBridgeParticipants").createBridgeParticipants(e)});return e})}function o(a,b,c,e){e===void 0&&(e=!0);var f=new Set([b,d("MAWUserJidWrapper").getMyUserJid()]);b=c.filter(function(a){a=a.userJid;return!f.has(a)}).map(function(a){var b=a.threadJid;a=a.userJid;return[b,a]});b.length>0&&d("MAWODSProxy").odsBumpEntityKey({amount:1,entity:d("WAOdsEnums").Entity.MAW_ONE_TO_ONE_THREAD_PARTICIPANT_CLEANUP,key:d("MAWCurrentUser").isEmployee()?"employee":"public"});return q(a,b,e)}function p(a,b,c,e){e===void 0&&(e=!0);var f=Array.from(new Set([b,d("MAWUserJidWrapper").getMyUserJid()])),g=new Set(c.map(function(a){return a.userJid})),h=f.filter(function(a){return!g.has(a)});h=h.map(function(a){return{type:"participant",userJid:a}});return k(a,b,h,e).then(function(a){var b=f.reduce(function(b,d){var e=a.find(function(a){return a.userJid===d}),f=c.find(function(a){return a.userJid===d});e!=null&&f==null?b.push(e):f!=null&&b.push(f);return b},[]);return b})}function a(a,b,c){c===void 0&&(c=!0);return u(a,b).then(function(d){return o(a,b,d,c).then(function(e){return p(a,b,d,c)})})}function b(a,b){b.forEach(function(a){return l(a,"bulkUpdateParticipants")});return a.participants.bulkPut(b).then(function(){b.length>0&&d("MAWIndexedDb").afterTransaction({tag:"ParticipantsUpdated",value:d("MAWBridgeParticipants").createBridgeParticipants(b)});return b})}function e(a,b,c){if(c.length===0)return d("MAWDexieTable").dexieResolve();c=c.map(function(a){return[b,a]});return q(a,c)}function f(a,b,c){if(b.length===0)return d("MAWDexieTable").dexieResolve();b=b.map(function(a){return[a,c]});return q(a,b)}function q(a,b,c){c===void 0&&(c=!0);return a.participants.where(["threadJid","userJid"]).anyOf(b).toArray().then(function(b){return a.participants.bulkDelete(b.map(function(a){return a.id})).then(function(){c&&b.forEach(function(a){var b=a.threadJid;a=a.userJid;return d("MAWIndexedDb").afterTransaction({tag:"ParticipantRemoved",value:{threadJid:b,userId:d("WAJids").extractUserId(a)}})})})})}function r(a,b){return a.participants.where("threadJid").equals(b)["delete"]()}function s(a,b,c,d,e){return t(a,[{deliveredWatermarkTs:c,lastReadActionTs:e,lastReadWatermarkTs:d,participantKey:b}]).then(function(a){return a[0]})}function t(a,b,c){if(b.length===0)return d("MAWDexieTable").dexieResolve([]);var e=new Map(),f=[];b.forEach(function(a){f.push(a.participantKey),e.set(JSON.stringify(a.participantKey),a)});return a.participants.where(["threadJid","userJid"]).anyOf(f).toArray().then(function(b){b.length!==f.length&&(c!=null&&c.DEBUG(h||(h=babelHelpers.taggedTemplateLiteralLoose(["bulkUpdateParticipantTimestamps: missing participants "," vs ",""])),b.length,f.length));var g=[],k=[];b.forEach(function(a){var b=e.get(JSON.stringify([a.threadJid,a.userJid]));if(b==null){c!=null&&c.DEBUG(i||(i=babelHelpers.taggedTemplateLiteralLoose(["bulkUpdateParticipantTimestamps: missing tsData for participant ",", ",""])),a.threadJid,a.userJid);return}var d=b.deliveredWatermarkTs,f=b.lastReadActionTs;b=b.lastReadWatermarkTs;var h=a.deliveredWatermarkTs,l=a.lastReadWatermarkTs,m=a.lastReadActionTs,n=d>h,o=b>l,p=m==null||f>m;c!=null&&c.DEBUG(j||(j=babelHelpers.taggedTemplateLiteralLoose(["bulkUpdateParticipantTimestamps: participant ",", "," deliveredWatermarkTs: ",", lastReadWatermarkTs: ",", lastReadActionTs: ",""])),a.threadJid,a.userJid,d,b,f);if(!n&&!o&&!p){k.push(a);return}g.push(babelHelpers["extends"]({},a,{deliveredWatermarkTs:n?d:h,lastReadActionTs:p?f:m,lastReadWatermarkTs:o?b:l}))});g.forEach(function(a){return l(a,"bulkUpdateParticipantTimestamps")});return a.participants.bulkPut(g).then(function(){g.forEach(function(a){d("MAWIndexedDb").afterTransaction({tag:"ReceivedReceipt",value:d("MAWBridgeTypesCreators").createBridgeReceivedReceipt(a.threadJid,d("WAJids").extractUserId(a.userJid),a.deliveredWatermarkTs)})});return[].concat(g,k)})})}function u(a,b){return a.participants.where("threadJid").equals(b).toArray()}function v(a,b){return a.participants.where("threadJid").anyOf(b).toArray()}function w(a,b){return u(a,b).then(function(a){return a.filter(function(a){return a.type==="invitedParticipant"})})}function x(a,b,c){return a.participants.where(["threadJid","userJid"]).equals([b,c]).first().then(function(a){return a==null?d("WAResultOrError").makeError("missing"):d("WAResultOrError").makeResult(a)})}function y(a,b){return a.participants.where(["threadJid","userJid"]).anyOf(b).toArray().then(function(a){var c=new Map(a.map(function(a){return[JSON.stringify([a.threadJid,a.userJid]),a]}));return b.map(function(a){return c.get(JSON.stringify(a))})})}g.bulkAddParticipants=k;g.logIfIllegalParticipant=l;g.bulkAddParticipantsInThreads=n;g.deleteIncorrectParticipantsInOneToOneThread=o;g.addMissingParticipantsInOneToOneThread=p;g.bulkRemoveIncorrectAndInsertMissingParticipantsInOneToOneThread=a;g.bulkUpdateParticipants=b;g.bulkDeleteParticipantsInThread=e;g.bulkDeleteParticipantAcrossThreads=f;g.bulkDeleteParticipants=q;g.deleteAllParticipantsForThread=r;g.updateParticipantTimestamps=s;g.bulkUpdateParticipantTimestamps=t;g.getParticipantsInThread=u;g.getParticipantsInThreads=v;g.getInvitedParticipantsInThread=w;g.getParticipant=x;g.bulkGetParticipants=y}),98);
__d("MAWWriteMsgSideEffectTxns",["MAWDbMsg","MAWDbParticipantTxns","MAWDexieTable"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){var c=d("MAWDbMsg").getCanonicalTsFromMsg(b),e=b.author;return e!=="@me"&&e!=="@system"?d("MAWDbParticipantTxns").updateParticipantTimestamps(a,[b.threadJid,e],c,c,c):d("MAWDexieTable").dexieResolve()}g.updateParticipantTimestampsForMsg=a}),98);
__d("MAWWriteMsgTxns",["FBLogger","MAWAfterWriteMsgUtil","MAWBridgeMsg","MAWBuildIncomingMsgs","MAWDbEditMsgHistoryTxns","MAWDbMsg","MAWDbMsgTxns","MAWDbPendingStanzaTxns","MAWDbReactionsTxns","MAWDbThread","MAWDbThreadTxns","MAWDbUnrenderedMsgTxns","MAWDeleteForMeMsgContentCleaner","MAWDeleteThreadUtil","MAWDexieTable","MAWEphemeralMsgTxns","MAWExpiredQuoteCleaner","MAWFTSTxns","MAWFolderTypes","MAWGetMsgQuoteTxn","MAWGetOrCreateThreadTxns","MAWIndexedDb","MAWJidUtils","MAWLoadReplyMediaTxns","MAWLocalizationType","MAWLocalizationUtils","MAWMessageSortOrderUtils","MAWMpsGating","MAWMsgType","MAWThreadEventConst","MAWTimeUtils","MAWUpdateQuotedMsgTxns","MAWUpdateThreadActivity","MAWUseProtocolMsgIdForMsgId","MAWWriteMsgSideEffectTxns","MAWWriteRevokeMessageTxns","ODS","WAJids","WALogger","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";var h=["rowId"],i,j,k;function l(a,b,e,f){var g=e.ts;g=[d("WATimeUtils").castUnixTimeToMillisTime(g),e.type===d("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_ADMIN];var h=g[0],i=g[1];return d("MAWGetOrCreateThreadTxns").getExistingThread(a,b.jid).then(function(b){if(b==null)throw c("FBLogger")("messenger_web").mustfixThrow("at this point there's always a thread - checking for updates");var g=d("MAWDbMsgTxns").getThreadOldestMessageBySortOrder(a,b.jid),j=d("MAWDbMsgTxns").getThreadNewestMessageBySortOrder(a,b.jid);return d("MAWDexieTable").dexieAll([g,j]).then(function(a){var c,g,j,k=a[0];a=a[1];var l=d("MAWUseProtocolMsgIdForMsgId").shouldUseProtocolMsgIdForMsgId()?null:a==null?1:d("MAWDbMsg").getInChatMsgIdFromMsgId(a.msgId)+1;c=d("WATimeUtils").castToMillisTime((c=a==null?void 0:a.sortOrderMs)!=null?c:0);c=h>c&&!i?h:c;g=(g=d("MAWTimeUtils").ensureValidMillisTime(b.lastReadMsgTs))!=null?g:0;j=d("WATimeUtils").castToMillisTime((j=a==null?void 0:a.sortOrderMs)!=null?j:0);g=g<j;j=e.author===d("WAJids").AUTHOR_ME||e.type===d("MAWMsgType").MSG_TYPE.ADMIN&&d("MAWLocalizationUtils").isParticipantChangeAdminMsg(e.msgContent.adminType)&&!g;g=babelHelpers["extends"]({},e,{msgId:l!=null?d("MAWDbMsg").craftMsgIdV2(b.chatId,l,e):d("MAWJidUtils").formatProtocolMsgIdFromMsg(e)});l=d("MAWDbMsgTxns").calculateOldestMsg(k,a,g,f);a=l.oldestMsg;return{isOldestMsgUpdated:k!=null&&a!==k.msgId,msgId:g.msgId,prevOldestMsg:k,updatedSnippet:void 0,updatedThread:babelHelpers["extends"]({},b,{lastReadMsg:j?g.msgId:b.lastReadMsg,lastReadMsgTs:j?c:b.lastReadMsgTs,newestMsgTs:c,oldestMsg:a,snippetMsg:b.snippetMsg,snippetMsgTs:b.snippetMsgTs,threadOrder:d("MAWDbThread").craftThreadOrder(c,b.jid)})}})})}function a(a,b,c,e){return a.messages.where(["threadJid","sortOrderMs"]).equals([c.jid,e]).filter(function(a){return a.type!==d("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_ADMIN&&a.type!==d("MAWMsgType").MSG_TYPE.EPHEMERAL_SCREENSHOT_ACTION?!1:a.type===b.type&&a.msgContent.adminType===b.msgContent.adminType}).first().then(function(d){return d!=null?d:n(a,b,c)})}function b(a,b,c,e){return a.messages.where(["threadJid","sortOrderMs"]).equals([c.jid,e]).filter(function(a){return a.type===d("MAWMsgType").MSG_TYPE.ADMIN&&a.msgContent.adminType===b.msgContent.adminType}).first().then(function(e){if(e!=null){(k||(k=d("ODS"))).bumpEntityKey(600,"maw_write_msg_txns_deduped_admin_message",b.msgContent.adminType);return e}return n(a,b,c)})}function e(a,b,c){return a.messages.where("threadJid").equals(c.jid).filter(function(a){return a.type===d("MAWMsgType").MSG_TYPE.ADMIN&&(a.msgContent.adminType===d("MAWLocalizationType").LOCALIZATION_TYPE.TWO_USERS_CONNECTED||a.msgContent.adminType===d("MAWLocalizationType").LOCALIZATION_TYPE.TWO_USERS_CONNECTED_ONE_MSPLIT)}).first().then(function(e){if(e!=null){(k||(k=d("ODS"))).bumpEntityKey(600,"maw_write_msg_txns_deduped_admin_message",b.msgContent.adminType);return e}return n(a,b,c)})}function m(a,b){return a.messages.add(b).then(function(a){return babelHelpers["extends"]({},b,{rowId:a})})}function n(a,b,c,e){e===void 0&&(e={});e=e;var f=e.isFirstMsg,g=f===void 0?!1:f;f=e.isOutgoing;var h=f===void 0?!1:f,j=e.openMessageOtid,k=e.openMessageParticipantCount,n=e.optimisticMsg,o=e.participantCount,p=e.quotedReplyAttachmentMeta;f=e.shouldUpdateUi;var q=f===void 0?!0:f;f=e.sortOrderMs;return l(a,c,b,f).then(function(c){c.isOldestMsgUpdated;var e=c.msgId;c.prevOldestMsg;var f=c.updatedThread;c=babelHelpers["extends"]({},b,{msgId:e,sortOrderMs:d("MAWMessageSortOrderUtils").generateAuthoritativeMessageSortOrder(b)});return d("MAWDexieTable").dexieAll([m(a,c),a.threads.put(f),d("MAWFTSTxns").maybePutMessageToBacklog(a,c.externalId)]).then(function(b){var c=b[0];b[1];h&&d("WALogger").LOG(i||(i=babelHelpers.taggedTemplateLiteralLoose(["writeMsgAfterTransaction - sortOrderMs: ",""])),c.sortOrderMs);q&&d("MAWAfterWriteMsgUtil").writeMsgAfterTransaction({dbMsg:c,isFirstMsg:g,openMessageOtid:j,openMessageParticipantCount:k,optimisticMsg:n,participantCount:o,quotedReplyAttachmentMeta:p,updatedThread:f});b=c.type===d("MAWMsgType").MSG_TYPE.ADMIN&&!d("MAWMpsGating").isMpsThreadsConsistencyEnabled()?d("MAWUpdateThreadActivity").updateThreadActivityFromInsertionTxn(a,c,c.threadJid,"inserted_admin_msg"):d("MAWDexieTable").dexieResolve();return b.then(function(){return c})})})}function o(a,b,e){return d("MAWGetOrCreateThreadTxns").getExistingThread(a,e.jid).then(function(f){if(f==null)throw c("FBLogger")("messenger_web").mustfixThrow("at this point there's always a thread - checking for updates");return(d("MAWUseProtocolMsgIdForMsgId").shouldUseProtocolMsgIdForMsgId()?d("MAWDexieTable").dexieResolve(null):d("MAWDbUnrenderedMsgTxns").getNextUnrenderedMsgIdNumberForThread(a,f)).then(function(c){var g=babelHelpers["extends"]({},b,{msgId:c!=null?d("MAWDbMsg").craftUnrenderedMsgId(f.chatId,c):d("MAWJidUtils").formatProtocolMsgIdFromExternalId(e.jid,b.externalId)});return d("MAWDexieTable").dexieAll([a.unrenderedMessages.add(g),a.threads.put(f)]).then(function(a){var b=a[0];a[1];return babelHelpers["extends"]({},g,{rowId:b})})})})}function f(a,b,c){return d("MAWDexieTable").dexieAll([p(a,b,c),d("MAWDbEditMsgHistoryTxns").getEditHistoryByOriginalMsgExternalIdAndThreadJid(a,[[b.externalId,c.jid]]).then(function(a){return{editMsgHistories:a,originalEditMsgHistory:a.find(function(a){return a.editExternalId===b.externalId})}})]).then(function(a){var b=a[0];a=a[1];var c=a.editMsgHistories;a=a.originalEditMsgHistory;return babelHelpers["extends"]({},b,{editMsgHistories:c,existingEditMsgHistory:a!=null?a:null})})}function p(a,b,c){c=[b.externalId,c.jid,b.author];var e=c[0],f=c[1];c=c[2];return d("MAWDexieTable").dexieAll([d("MAWDbMsgTxns").maybeGetMsgByExternalId(a,e,f,c),d("MAWDbPendingStanzaTxns").maybeGetPendingRevokedStanza(a,e,c,f),d("MAWDbPendingStanzaTxns").maybeGetPendingDeletedStanza(a,e,c,f),d("MAWDbMsgTxns").checkIfMsgIsDeletedForMeOrRevoked(a,e,f,c),d("MAWDbPendingStanzaTxns").maybeGetDeleteThreadFromPendingStanza(a,f).then(function(a){return d("MAWDeleteThreadUtil").isMsgDeletedViaDeleteThread(b.ts,a)})]).then(function(a){var b=a[0],c=a[1],d=a[2],e=a[3];a=a[4];return{existingMsg:b!=null?b:null,isDeletedWithThread:a,isDeleteForMeOrRevoked:e,pendingDeleteForMeStanza:d!=null?d:null,pendingRevokedStanza:c!=null?c:null}})}function q(a,b,c,e,f){e===void 0&&(e=!0);return d("MAWDbPendingStanzaTxns").maybeGetPendingRevokedStanza(a,b.externalId,b.author,c.jid).then(function(g){if(g!=null)return t(a,b,c,g,!0);g=b.author;d("WALogger").DEV(j||(j=babelHelpers.taggedTemplateLiteralLoose(["handle"," Msg: Message from ",", chat ",""])),b.type,g,c.jid);var h=babelHelpers["extends"]({},babelHelpers["extends"]({},b,{threadJid:c.jid}));c.folder===d("MAWFolderTypes").FOLDER_ID.OTHER&&(h.altIndex=h.altIndex===d("MAWDbMsg").FUTUREPROOF_ALT_INDEX?d("MAWDbMsg").FUTUREPROOF_SPAM_ALT_INDEX:d("MAWDbMsg").SPAM_ALT_INDEX);return d("MAWGetMsgQuoteTxn").getMsgQuoteInfo(a,h,c.jid,f).then(function(b){b!=null&&(h=babelHelpers["extends"]({},h,{quote:b==null?void 0:b.quote,quoteExpirationTs:b==null?void 0:b.quote.content.expirationTs,quoteExternalId:b==null?void 0:b.quoteExternalId}));b=h.quoteExpirationTs;b!=null&&b>d("WATimeUtils").unixTime()&&d("MAWExpiredQuoteCleaner").addNewExpiredQuoteCleanerTimestamp(b);return d("MAWDexieTable").dexieAll([d("MAWUpdateQuotedMsgTxns").associateQuotedMessage(a,c.jid,h),d("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(a,h),d("MAWLoadReplyMediaTxns").getReplyMediaForMsg(a,h)]).then(function(b){var f=b[0],g=b[1],i=b[2];return n(a,h,c,{quotedReplyAttachmentMeta:g,shouldUpdateUi:e}).then(function(b){return d("MAWDexieTable").dexieAll([d("MAWWriteMsgSideEffectTxns").updateParticipantTimestampsForMsg(a,h),d("MAWEphemeralMsgTxns").markEphemeralMessageAsSent(a,b,e)]).then(function(a){a=a[1];f!=null&&(e&&f.forEach(function(a){d("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:d("MAWBridgeMsg").createBridgeMsg(a,i)})}));return a||b})})})})})}function r(a,b,c,e,f,g){var i=babelHelpers["extends"]({},babelHelpers["extends"]({},b,{msgId:c.msgId,protocolMsgId:c.protocolMsgId,rowId:c.rowId,serverTs:c.serverTs,sortOrderMs:c.sortOrderMs,threadJid:e.jid,ts:c.ts}));return d("MAWDexieTable").dexieAll([d("MAWUpdateQuotedMsgTxns").associateQuotedMessage(a,e.jid,i),d("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(a,i),d("MAWLoadReplyMediaTxns").getReplyMediaForMsg(a,i),d("MAWGetMsgQuoteTxn").getMsgQuoteInfo(a,i,e.jid,g),d("MAWDbMsgTxns").getThreadNewestMessageId(a,e.jid)]).then(function(g){var j=g[0],k=g[1],l=g[2],m=g[3],n=g[4];i=babelHelpers["extends"]({},i,{quote:m==null?void 0:m.quote,quoteExternalId:m==null?void 0:m.quoteExternalId});return((g=c.editCount)!=null?g:0)>0&&f!=null&&b.type===d("MAWMsgType").MSG_TYPE.TEXT?d("MAWDbEditMsgHistoryTxns").updateEditMsgHistoryWithNewIncomingMsg(a,f,b).then(function(){return c}):a.messages.put(i).then(function(){return d("MAWDbThreadTxns").needsRetroactiveReadReceiptInThread(a,i)}).then(function(b){if(b){i.altIndex=d("MAWDbMsg").craftToBeReadAltIndex(e.chatId);return a.messages.put(i)}}).then(function(){d("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:d("MAWBridgeMsg").createBridgeMsg(i,l)});d("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:d("MAWBridgeMsg").createBridgeMsg(i,k)});d("MAWIndexedDb").afterTransactionThreadEvent({chatJid:e.jid,msgId:i.msgId},d("MAWThreadEventConst").PLACEHOLDER_CONVERT_SUBSCRIPTION);j!=null&&j.forEach(function(a){d("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:d("MAWBridgeMsg").createBridgeMsg(a,l)})});if(i.msgId===n){var b=i;b.rowId;b=babelHelpers.objectWithoutPropertiesLoose(b,h);d("MAWWriteMsgSideEffectTxns").updateParticipantTimestampsForMsg(a,b)}return i})})}function s(a,b,c,e){var f=d("MAWBuildIncomingMsgs").buildUnstoredDeleteForMeMsg(b,c);return d("MAWDexieTable").dexieAll([d("MAWDbReactionsTxns").deleteReactionsByUniqueMsgIdentifiers(a,[{author:f.author,chatJid:f.threadJid,externalId:f.externalId}]),o(a,f,c),a.pendingStanzas["delete"](e.rowId),d("MAWFTSTxns").maybePutMessageToPurgeBacklog(a,b.externalId)]).then(function(a){a[0];a=a[1];d("MAWDeleteForMeMsgContentCleaner").addNewDeleteForMeMsgContentCleanerTimestamp(f.messageDeleteForMeTs);return babelHelpers["extends"]({},f,{msgId:a.msgId,rowId:a.rowId})})}function t(a,b,e,f,g){g===void 0;g=d("MAWDbPendingStanzaTxns").getRevokedContent(f);if(g==null)throw c("FBLogger")("messenger_web").mustfixThrow("missing revoked content");b=d("MAWBuildIncomingMsgs").buildUnstoredRevokedMsg(b,e,g);return d("MAWDexieTable").dexieAll([n(a,b,e),a.pendingStanzas["delete"](f.rowId)]).then(function(b){var c=b[0];return d("MAWWriteRevokeMessageTxns").markIncomingMessageRevoked(a,c,e).then(function(){return c})})}g.writeDedupedEphemeralSettingAdminMessage=a;g.writeDedupedAdminMessage=b;g.writeDedupedUsersConnectedAdminMessage=e;g.writeMsg=n;g.writeUnrenderedMsg=o;g.prepareTextMsgWriteData=f;g.prepareMsgWriteData=p;g.writeNewIncomingMsg=q;g.writeCiphertextUpdate=r;g.handleDeleteForMeMessage=s;g.handleOutOfOrderRevokedMessage=t}),98);
__d("MAWDbDeletedMessages",["$InternalEnum"],(function(a,b,c,d,e,f){"use strict";a=b("$InternalEnum")({ChatDelete:"chat_delete",Revoke:"revoke"});f.DbDeletedMsgReasonEnum=a}),66);
__d("MAWMediaManagerDeferred",["promiseDone","requireDeferred"],(function(a,b,c,d,e,f,g){"use strict";var h=c("requireDeferred")("MAWMediaManager").__setRef("MAWMediaManagerDeferred");function a(a){c("promiseDone")(h.load().then(function(b){b.getMawMediaManager().dequeueDownload(a)}))}g.dequeueDownload=a}),98);
__d("MAWUnsendMsgContentCleaner",["FBLogger","MAWMsgCleaner","WALogger"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j=null;function a(a){j==null&&(j=new(d("MAWMsgCleaner").MsgCleaner)(a,d("MAWMsgCleaner").CLEANER_TYPE.UNSEND))}function b(a){if(j==null){var b="Trying to add new UnsendMsgContentCleanerTimestamp before the cleaner is initialized!";d("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["",""])),b);throw c("FBLogger")("messenger_web").mustfixThrow(b)}else d("WALogger").DEV(i||(i=babelHelpers.taggedTemplateLiteralLoose(["UnsendMsgContentCleaner: Adding timestamps (",")"])),a),j.update(a)}function e(){return j}function f(){j=null}g.startUnsendMsgContentCleaner=a;g.addNewUnsendMsgContentCleanerTimestamp=b;g.getUnsendMsgContentCleaner_FOR_TESTING_ONLY=e;g.resetUnsendMsgContentCleaner_FOR_TESTING_ONLY=f}),98);
__d("MAWWriteDeleteMessageTxns",["MAWAckLevel","MAWDbMsg","MAWDbMsgTxns","MAWDbPendingStanza","MAWDbReactionsTxns","MAWDbThreadTxns","MAWDbXMATxns","MAWDeleteForMeMsgContentCleaner","MAWDexieTable","MAWFTSTxns","MAWIndexedDb","MAWMediaManagerDeferred","MAWMpsGating","MAWMsgType","MAWPendingStanzaCleaner","MAWThreadSnippetBuildTxns","MAWUpdateQuotedMsgTxns","MAWUpdateThreadActivity","MAWXMAUtils","WAResultOrError","WATimeUtils","emptyFunction"],(function(a,b,c,d,e,f,g){"use strict";var h=6*d("WATimeUtils").HOUR_SECONDS,i=30*d("WATimeUtils").DAY_SECONDS;function a(a,b){var c=b.protocolMsgId,e=c.author;b=c.chat;var f=c.externalId;return d("MAWDexieTable").dexieAll([d("MAWDbThreadTxns").getThread(a,b),a.unrenderedMessages.get({externalId:f}),d("MAWFTSTxns").maybePutMessageToPurgeBacklog(a,f)]).then(function(b){var g=b[0];b=b[1];if(!g.success)return d("WAResultOrError").makeError("missing_thread");return b!=null&&b.threadJid===g.value.jid&&b.author===e?d("WAResultOrError").makeError("duplicate_delete_for_me"):d("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(a,c).then(function(b){if(b==null){var h={ack:d("MAWAckLevel").ACK.received,author:e,externalId:f,threadJid:g.value.jid,type:d("MAWMsgType").MSG_TYPE.DELETE_FOR_ME},k=d("WATimeUtils").castToUnixTime(d("WATimeUtils").unixTime()+i);h={deleteTs:k,externalIdWithType:f+"_"+d("MAWDbPendingStanza").PENDING_DELETE_FOR_ME,pendingContent:{content:h,type:d("MAWDbPendingStanza").PENDING_TYPE.DELETE_FOR_ME}};return a.pendingStanzas.add(h).then(function(){d("MAWPendingStanzaCleaner").addNewPendingStanzaCleanerTimestamp(k);return d("WAResultOrError").makeResult()})}return d("MAWDexieTable").dexieResolve(j(a,b,e,c.chat,g.value)).then(function(){return d("WAResultOrError").makeResult()})})})}function j(a,b,e,f,g){var i,j=d("MAWDexieTable").dexieResolve();d("MAWXMAUtils").isXMAStoryReply((i=b.quote)==null?void 0:i.content.xmaMessageType)&&(j=k(a,b));var m={ack:b.ack,author:e,externalId:b.externalId,mediaId:b.mediaId,messageDeleteForMeTs:d("WATimeUtils").castToUnixTime(d("WATimeUtils").unixTime()+h),msgContent:(i=d("MAWDbMsg").getMsgContent(b))==null?void 0:i.content,msgId:b.msgId,quote:b.quote,reportingMeta:b.reportingMeta,serverTs:void 0,threadJid:f,ts:b.ts,type:d("MAWMsgType").MSG_TYPE.DELETE_FOR_ME,xmaMessageType:b.xmaMessageType};i=d("MAWDexieTable").dexieAll([l(a,b.author,b.externalId,b.threadJid),d("MAWDbMsgTxns").deleteDbMsg(a,b.rowId),j]).then(function(){if(d("MAWDbMsg").isMediaMsg(b)){var e=b.mediaId,f=b.plaintextHash;e!=null&&(f!=null?(d("MAWMediaManagerDeferred").dequeueDownload(f),d("MAWIndexedDb").afterTransaction({tag:"MediaExpired",value:{mediaId:e,msgId:b.msgId,plaintextHash:f,threadJid:b.threadJid}})):d("MAWIndexedDb").afterTransaction({tag:"MediaExpired",value:{mediaId:e,msgId:b.msgId,threadJid:b.threadJid}}))}return d("MAWDexieTable").dexieAll([d("MAWThreadSnippetBuildTxns").refreshThreadSnippet(a,g),d("MAWMpsGating").isMpsThreadsConsistencyEnabled()?d("MAWDexieTable").dexieResolve():d("MAWUpdateThreadActivity").updateThreadActivityFromDeletionTxn(a,b,b.threadJid)]).then(c("emptyFunction"))});return i.then(function(){return d("MAWDexieTable").dexieAll([a.unrenderedMessages.add(m),d("MAWDbReactionsTxns").deleteReactionsByUniqueMsgIdentifiers(a,[{author:e,chatJid:b.threadJid,externalId:b.externalId}]),d("MAWUpdateQuotedMsgTxns").disassociateQuotedMsg(a,b.threadJid,b.externalId,b.author,d("MAWMsgType").MSG_TYPE.REVOKED)]).then(function(){return d("MAWDbMsgTxns").maybeUpdateThreadMsgsForDeleteForMe(a,g.jid,b.msgId,b.sortOrderMs).then(function(){d("MAWDeleteForMeMsgContentCleaner").addNewDeleteForMeMsgContentCleanerTimestamp(m.messageDeleteForMeTs);return d("WAResultOrError").makeResult()})})})}function k(a,b){return d("MAWDbXMATxns").maybeGetXMAFromAssociatedMsgId(a,b.msgId).then(function(b){return d("MAWDbMsgTxns").maybeGetMsg(a,b==null?void 0:b.msgId).then(function(b){if(b!=null)return d("MAWDbMsgTxns").deleteDbMsg(a,b.rowId)})})}function l(a,b,c,e){return a.messages.where("quoteExternalId").equals(c).filter(function(a){var c;return a.type===d("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE&&((c=a.quote)==null?void 0:c.content.author)===b&&a.threadJid===e}).toArray().then(function(b){if(b.length===0)return d("MAWDexieTable").dexieResolve([]);var c=b.map(function(a){return a.rowId});return d("MAWDbMsgTxns").bulkDeleteDbMsg(a,c).then(function(){return b})})}g.REVOKE_CONTENT_EXPIRATION_IN_SEC=h;g.handleDeleteForMe=a;g.deleteXMAStoryReplyMsg=k;g.deleteBumpMsgs=l}),98);
__d("MAWWriteRevokeMessageTxns",["FBLogger","LSMEBTaskCreationSource","MAWAckLevel","MAWBridgeEventTransmitter","MAWBridgeMsg","MAWBridgeTypesCreators","MAWDbDeletedMessages","MAWDbMsg","MAWDbMsgTxns","MAWDbPendingStanza","MAWDbProtocolMsgIdMiddleware","MAWDbReactionsTxns","MAWDexieTable","MAWEphemeralUtil","MAWFTSTxns","MAWIndexedDb","MAWJidUtils","MAWMediaManagerDeferred","MAWMsgType","MAWODSProxy","MAWPendingStanzaCleaner","MAWThreadSnippetBuildTxns","MAWUnsendMsgContentCleaner","MAWUpdateQuotedMsgTxns","MAWWriteDeleteMessageTxns","MAWWriteMsgTxns","MAWXMAUtils","WAJids","WAOdsEnums","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";var h=6*d("WATimeUtils").HOUR_SECONDS,i=30*d("WATimeUtils").DAY_SECONDS;function a(a,b,e,f,g,h){if(h!=null&&f==null){h=babelHelpers["extends"]({},b,{originalTs:d("WATimeUtils").castMilliSecondsToUnixTime(h),threadJid:e.jid,unsendMsgContentDeleteTs:(h=b.serverTs)!=null?h:b.ts});return d("MAWWriteMsgTxns").writeMsg(a,h,e).then(function(a){return a.type==="Revoked"?a:null})}var k=d("WATimeUtils").castToUnixTime(d("WATimeUtils").unixTime()+i),l=b.author,n=b.externalId,o=b.revokedExternalId,p=g!=null?m(a,g):d("MAWDexieTable").dexieResolve();return d("MAWDexieTable").dexieAll([f==null?d("MAWDbMsgTxns").maybeGetMsgByExternalId(a,b.revokedExternalId,e.jid,b.author):d("MAWDexieTable").dexieResolve(f),d("MAWFTSTxns").maybePutMessageToPurgeBacklog(a,n)]).then(function(g){var h=g[0];(f==null||h!=null)&&c("FBLogger")("messenger_web").warn("Revoked message missing originalMsg incorrectly");if(h==null){g={deleteTs:k,externalIdWithType:o+"_"+d("MAWDbPendingStanza").PENDING_REVOKED,pendingContent:{content:{ack:d("MAWAckLevel").ACK.received,altIndex:void 0,author:l,externalId:n,revokedExternalId:o,threadJid:e.jid,ts:b.ts,type:"Revoked"},type:d("MAWDbPendingStanza").PENDING_TYPE.REVOKED}};return d("MAWDexieTable").dexieAll([a.pendingStanzas.add(g),p]).then(function(b){b[0];b=b[1];d("MAWPendingStanzaCleaner").addNewPendingStanzaCleanerTimestamp(k);d("MAWBridgeEventTransmitter").issuePointQueryOutsideTxn(o,d("WAJids").threadIdForChatJid(e.jid),c("LSMEBTaskCreationSource").POINT_QUERY_FROM_EB,e.jid);b===!0&&d("MAWThreadSnippetBuildTxns").refreshThreadSnippet(a,e)})}return p.then(function(){return j(a,h,e,b.externalId,b.revokedExternalId,b.serverTs,b.ts,!1)})})}function j(a,b,c,e,f,g,i,j){var k=babelHelpers["extends"]({},b,{altIndex:void 0,externalId:e,msgContent:d("MAWDbMsg").getMsgContent(b),originalTs:(e=b.serverTs)!=null?e:b.ts,revokedExternalId:f,serverTs:g,threadJid:c.jid,ts:i,type:"Revoked",unsendMsgContentDeleteTs:d("WATimeUtils").castToUnixTime(d("WATimeUtils").unixTime()+h)});d("MAWDbProtocolMsgIdMiddleware").appendProtocolMsgId(k);return j?d("MAWDexieTable").dexieResolve(k):l(a,b,k,c).then(function(){return k})}function k(a,b){return(b.type===d("MAWMsgType").MSG_TYPE.XMA?a.xma.where("externalId").equals(b.externalId).toArray().then(function(a){return a.some(function(a){return a.associatedMessageId!=null})}):a.xma.where("associatedMessageId").equals(b.msgId).toArray().then(function(a){return a.length>0})).then(function(a){a&&d("MAWODSProxy").odsBumpEntityKey({entity:d("WAOdsEnums").Entity.MAW_XMA_WITH_ASSOCIATED_MSG,key:"revoking_xma_with_associated_msg"});return d("MAWDexieTable").dexieResolve()})}function l(a,b,c,e){var f,g=d("MAWXMAUtils").isXMAStoryReply((f=b.quote)==null?void 0:f.content.xmaMessageType)?d("MAWWriteDeleteMessageTxns").deleteXMAStoryReplyMsg(a,b):d("MAWDexieTable").dexieResolve();f=d("MAWJidUtils").toProtocolMsgId(b);var h=f!=null?a.deletedMessages.add(babelHelpers["extends"]({},f,{reason:d("MAWDbDeletedMessages").DbDeletedMsgReasonEnum.Revoke})):d("MAWDexieTable").dexieResolve();return d("MAWWriteDeleteMessageTxns").deleteBumpMsgs(a,b.author,b.externalId,b.threadJid).then(function(){return d("MAWDexieTable").dexieAll([a.messages.put(c),d("MAWDbReactionsTxns").deleteReactionsByUniqueMsgIdentifiers(a,[{author:c.author,chatJid:c.threadJid,externalId:c.revokedExternalId}]),d("MAWUpdateQuotedMsgTxns").disassociateQuotedMsg(a,c.threadJid,c.revokedExternalId,c.author,d("MAWMsgType").MSG_TYPE.REVOKED),g,h,d("MAWFTSTxns").maybePutMessageToPurgeBacklog(a,b.externalId),k(a,b)]).then(function(){d("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:d("MAWBridgeMsg").createBridgeMsg(c)});if(b!=null&&d("MAWDbMsg").isMediaMsg(b)){var f=b.mediaId,g=b.plaintextHash;f!=null&&(g!=null?(d("MAWMediaManagerDeferred").dequeueDownload(g),d("MAWIndexedDb").afterTransaction({tag:"MediaExpired",value:{mediaId:f,msgId:b.msgId,plaintextHash:g,threadJid:b.threadJid}})):d("MAWIndexedDb").afterTransaction({tag:"MediaExpired",value:{mediaId:f,msgId:b.msgId,threadJid:b.threadJid}}))}d("MAWEphemeralUtil").maybeClearEphemeralMsgCountdown(b);return d("MAWThreadSnippetBuildTxns").refreshThreadSnippet(a,e)})})}function b(a,b,e){if(b.type!==d("MAWMsgType").MSG_TYPE.REVOKED)throw c("FBLogger")("messenger_web").mustfixThrow("Cant mark unrevoked message revoked");var f=d("MAWJidUtils").maybeToProtocolMsgId(b.author,b.threadJid,b.revokedExternalId),g=f!=null?a.deletedMessages.add(babelHelpers["extends"]({},f,{reason:d("MAWDbDeletedMessages").DbDeletedMsgReasonEnum.Revoke})):d("MAWDexieTable").dexieResolve();return d("MAWWriteDeleteMessageTxns").deleteBumpMsgs(a,b.author,b.revokedExternalId,b.threadJid).then(function(c){c.length>0&&d("MAWIndexedDb").afterTransaction({tag:"DeleteMessages",value:d("MAWBridgeTypesCreators").createBridgeDeleteMessages(b.threadJid,c)});return d("MAWDexieTable").dexieAll([d("MAWDbReactionsTxns").deleteReactionsByUniqueMsgIdentifiers(a,[{author:b.author,chatJid:b.threadJid,externalId:b.revokedExternalId}]),d("MAWThreadSnippetBuildTxns").refreshThreadSnippet(a,e),g]).then(function(){d("MAWUnsendMsgContentCleaner").addNewUnsendMsgContentCleanerTimestamp(b.unsendMsgContentDeleteTs),d("MAWIndexedDb").afterTransaction({tag:"NewMsg",value:d("MAWBridgeMsg").createBridgeMsg(b)})})})}function m(a,b){return b.type===d("MAWMsgType").MSG_TYPE.CIPHERTEXT?a.messages["delete"](b.rowId).then(function(){d("MAWIndexedDb").afterTransaction({tag:"DeleteMessages",value:d("MAWBridgeTypesCreators").createBridgeDeleteMessages(b.threadJid,[b])});return!0}):d("MAWDexieTable").dexieResolve(!1)}g.REVOKE_CONTENT_EXPIRATION_IN_SEC=h;g.writeIncomingRevokeMsg=a;g.revokeUnstoredMsg=j;g.markExistingMsgRevoked=l;g.markIncomingMessageRevoked=b}),98);
__d("MAWCastToMsgrServerMediaType",["EncryptedBackupsUploadEntity","MAWDbMedia","WALogger"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j;function a(a,b){b===void 0&&(b=!1);if(b&&a==="image")return"xma";switch(a){case"image":case"video":case"gif":case"sticker":return a;case"document":return"file";case"ptt":return"audio";case"xma-image":return"xma";case"preview":return"preview";default:d("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["invalid mediaType: "," for castToMsgrServerMediaType method"])),a);return null}}function b(a,b){b===void 0&&(b=!1);if(b&&a===d("MAWDbMedia").MEDIA_TYPE.IMAGE)return"xma";switch(a){case"Image":return"image";case"Video":return"video";case"Gif":return"gif";case"Sticker":return"sticker";case"DocumentFile":return"file";case"Ptt":return"audio";default:d("WALogger").ERROR(i||(i=babelHelpers.taggedTemplateLiteralLoose(["invalid client mediaType: "," for castClientMediaTypeToServerMediaType method"])),a);return null}}function c(a){switch(a){case d("EncryptedBackupsUploadEntity").AttachmentContextMediaType.IMAGE:return"image";case d("EncryptedBackupsUploadEntity").AttachmentContextMediaType.VIDEO:return"video";case d("EncryptedBackupsUploadEntity").AttachmentContextMediaType.GIF:return"gif";case d("EncryptedBackupsUploadEntity").AttachmentContextMediaType.STICKER:return"sticker";case d("EncryptedBackupsUploadEntity").AttachmentContextMediaType.DOCUMENT:return"file";case d("EncryptedBackupsUploadEntity").AttachmentContextMediaType.PTT:return"audio";case d("EncryptedBackupsUploadEntity").AttachmentContextMediaType.XMA:return"xma";case d("EncryptedBackupsUploadEntity").AttachmentContextMediaType.MESSENGER_PREVIEW:return"preview";default:d("WALogger").ERROR(j||(j=babelHelpers.taggedTemplateLiteralLoose(["invalid attachment mediaType: "," for castMediaAttachmentTypeToServerMediaType method"])),a);return null}}g.castToMsgrServerMediaType=a;g.castClientMediaTypeToServerMediaType=b;g.castMediaAttachmentTypeToServerMediaType=c}),98);
__d("WADbDeviceRegistration",["gkx"],(function(a,b,c,d,e,f,g){"use strict";a=25;b=6;d=b;e="https://reg-e2ee.facebook.com";f=c("gkx")("13108")?"https://reg-e2ee.messenger.com":e;c="https://v.whatsapp.net";var h="https://reg-e2ee.instagram.com",i="/v2/fb_icdc_fetch",j="/v2/fb_register_v2",k="Device has already been registered to WA servers",l="Device registration finished successfully",m="Device registration retries failed "+b+" times. No longer attempting registration.",n="Device registration response was null",o="Current user id is zero",p="CryptoAuthToken is empty",q="CryptoAuthToken is expired",r={failed:"failed",finished:"finished"};g.MAX_USERS_FOR_NOTIFY_DEVICE_CHANGE=a;g.MAX_DEVICE_REGISTRATION_RETRIES=b;g.MAX_ROTATE_CRYPTO_AUTH_TOKEN_RETRIES=d;g.REG_FB_DOMAIN=e;g.REG_MSGR_DOMAIN=f;g.REG_WA_DOMAIN=c;g.REG_IGD_DOMAIN=h;g.ICDC_ENDPOINT=i;g.REGISTRATION_ENDPOINT=j;g.DEVICE_ALREADY_REGISTERED=k;g.DEVICE_SUCCESSFULLY_REGISTERED=l;g.FAILED_REGISTRATION_RETRIES=m;g.NULL_RESPONSE_FROM_SERVER=n;g.DEVICE_REGISTER_ERROR_ZERO_AS_USER_ID=o;g.DEVICE_REGISTER_ERROR_EMPTY_CAT_TOKEN=p;g.DEVICE_REGISTER_ERROR_EXPIRED_CAT_TOKEN=q;g.RegistrationStatesEnum=r}),98);
__d("WorkerUtils",[],(function(a,b,c,d,e,f){"use strict";function b(){try{return"WorkerGlobalScope"in a&&a instanceof a.WorkerGlobalScope}catch(a){return!1}}function c(){try{return"SharedWorkerGlobalScope"in a&&a instanceof a.SharedWorkerGlobalScope}catch(a){return!1}}f.isWorkerContext=b;f.isSharedWorkerContext=c}),66);
__d("getOrchestratorVersion",["qex"],(function(a,b,c,d,e,f,g){"use strict";function a(){var a;return(a=c("qex")._("263"))!=null?a:"default"}g["default"]=a}),98);
__d("MAWMainWebWorkerConfig",["MAWGK","MAWParseXMAFBConfig","WADbDeviceRegistration","WorkerUtils","getOrchestratorVersion","gkx","justknobx","qex"],(function(a,b,c,d,e,f,g){"use strict";var h,i=1;a={S508658PreventOldSessionLookupAndPromote:function(){return!0},armadilloWebProcessFutureproof:function(){return c("MAWGK").armadillo_web_process_futureproof},getSignalFutureMessagesMax:function(){return c("justknobx")._("847")},icdcAlertTriggerFailureCounter:function(){return c("justknobx")._("1970")},icdcCooldownIntervalInMinutes:function(){return c("justknobx")._("1971")},icdcIntervalInMinutes:function(){return c("justknobx")._("1972")},isDocumentReceiveEnabled:function(){return!c("gkx")("23924")},isFrankingDropOnInvalid:function(){return c("gkx")("23973")},isFrankingDropOnMissing:function(){return c("gkx")("23974")},isICDCErrorEnabled:function(){return c("gkx")("23975")},isMetaAiInvocationMessageRenderEnabled:function(){return c("gkx")("12661")},isPollsEnabled:function(){return c("qex")._("3169")===!0},isProgressiveJpegSendEnabled:function(){return c("justknobx")._("2412")},isSharedWorkerContext:function(){return(h||(h=d("WorkerUtils"))).isSharedWorkerContext()},isStickerEnabled:function(){return!0},isStickerReceiverFetchEnabled:function(){return c("justknobx")._("3677")},jpegThumbnailTargetByteSizeKB:function(){return c("justknobx")._("2338")},maxPrekeysToUpload:function(){return 200},maxUsersForNotifyDeviceChange:function(){return d("WADbDeviceRegistration").MAX_USERS_FOR_NOTIFY_DEVICE_CHANGE},newClockSkewCalculation:function(){return c("gkx")("18494")},offlineQueueStuckTimeoutMs:function(){return c("justknobx")._("3264")},orchestratorVersion:function(){return c("getOrchestratorVersion")()},pjpegPreviewAvoidLastScan:function(){return!0},sessionDropIfTooOld:function(){return c("justknobx")._("2240")},skipProcessingGroupInvite:function(){return c("justknobx")._("3899")},waDanglingQueue:function(){return!0}};b={productTypeForEBAttachments:"msgr",shouldFallbackToPreviewForFailedProgressiveJpeg:function(){return c("gkx")("2909")},supportedTypesVersion:function(){return c("MAWGK").armadillo_web_process_futureproof?i+1:i},supportedXMATargetTypes:function(){return d("MAWParseXMAFBConfig").FB_FULLY_SUPPORTED_TARGET_TYPES}};g.waConfig=a;g.mawConfig=b}),98);
__d("MAWConfig",["MAWMainWebWorkerConfig"],(function(a,b,c,d,e,f,g){"use strict";var h=d("MAWMainWebWorkerConfig").mawConfig;function a(){return h}function b(a){h=a}g.getConfig=a;g.setConfig=b}),98);
__d("MAWJobsIndexedDb",["FBLogger","MAWCurrentUser","MAWErrorObject","MAWIndexedDbMetadata","MAWQplProxy","MAWTransactionMode","Promise","WAExceededStorageQuota","WALogger","WAWorkerGlobalScope","emptyFunction","promiseDone","qex","qpl"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j=null,k=null,l="jobs";function m(){return c("qex")._("940")}function n(){if(j==null)throw c("FBLogger")("messenger_web").mustfixThrow("JobDB IndexDB should've been initialized");return j}function o(){if(k==null)throw c("FBLogger")("messenger_web").mustfixThrow("JobDB IndexDB should've been initialized");return k.then(function(){return n()})}function a(){return j!=null}var p=[function(a){a=a.target.result;a=a.createObjectStore(l,{autoIncrement:!0,keyPath:"jobId"});a.createIndex("uniqKey","uniqKey")},c("emptyFunction"),c("emptyFunction")];function e(a){k=null;j=null;return q(a).then(function(){return j.version})}function q(a){if(k!=null)return k;if(j!=null)return(i||(i=b("Promise"))).resolve();var e=d("MAWCurrentUser").getID(),f=d("MAWIndexedDbMetadata").jobsDbName(e),g=(e=a!=null?a:m())!=null?e:p.length,l=c("qpl")._(25310776,"6155");k=new(i||(i=b("Promise")))(function(a,b){var c=indexedDB.open(f,g);c.onupgradeneeded=function(a){for(var b=0;b<p.length;b++){var c=p[b],d=b+1;r(a,d)&&c(a)}};c.onsuccess=function(b){var c=b.target.result;c.onversionchange=function(){var a;d("MAWQplProxy").sendQplPointThroughBridge(l,"database_jobs_db_versionchange");d("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["[JobsDb initialization] upgradeneeded is triggered in another worker. This should not happen."])));c.close();(a=d("WAWorkerGlobalScope").workerGlobalScope.location)==null||a.reload==null||a.reload()};j=c;d("MAWQplProxy").sendQplPointThroughBridge(l,"database_jobs_db_ready");a()};c.onerror=function(){d("MAWQplProxy").sendQplPointThroughBridge(l,"database_jobs_db_failed"),b(c.error)}});return k}function r(a,b){var c=a.newVersion;a=a.oldVersion;return a<b&&c>=b}function s(a){return a===d("MAWTransactionMode").READWRITE?"readwrite":"readonly"}function f(a,b,e,f){var g=s(b);return function(b){return function(){for(var h=arguments.length,i=new Array(h),l=0;l<h;l++)i[l]=arguments[l];var m=f!=null?d("MAWQplProxy").startQplUserFlow(f):null,n=function(f){return o().then(function(c){var e=function(b){b=c.transaction(a,b!=null?s(b):g,{durability:"relaxed"});d("WAExceededStorageQuota").listenToQuotaExceededError(b);return b.objectStore(a)};return b.apply(void 0,[e].concat(i))}).then(function(a){m==null||m.endSuccess();return a})["catch"](function(b){m==null||m.endFail("job_transaction_fail");b=d("MAWErrorObject").getErrorObject(b);if((b==null?void 0:b.name)==="InvalidStateError"&&f===1){k=null;j=null;c("promiseDone")(q());return n(f-1)}if(b instanceof Error)throw c("FBLogger")("maw_db").catching(b).mustfixThrow("%s:%s - Error performing transaction in jobDB transactor v2",e,a);throw c("FBLogger")("maw_db").mustfixThrow("%s:%s - Error performing transaction in jobDB transactor v2",e,a)})};return n(1)}}}g.getJobsDbVersion=m;g.getJobDB=n;g.isJobDBInitted=a;g.dbMigrations=p;g.makeJobsDbIgnoringPreviousCreations=e;g.makeJobsDb=q;g.makeJobsTransactor=f}),98);
__d("MAWJobPersistenceAccessorsApi",["MAWJobActionsV2","MAWJobsIndexedDb","MAWTransactionMode"],(function(a,b,c,d,e,f,g){"use strict";function a(){var a,b,c;return{deletePersistedJob:(a=d("MAWJobsIndexedDb")).makeJobsTransactor("jobs",(b=d("MAWTransactionMode")).READWRITE,"deletePersistedJob")((c=d("MAWJobActionsV2")).deletePersistedJob),loadAllJobs:a.makeJobsTransactor("jobs",b.READONLY,"loadAllJobs")(c.readAllPersistedJobs),maybeCreateJob:a.makeJobsTransactor("jobs",b.READWRITE,"maybeCreateJob")(c.maybeCreateJob),readPersistedJob:a.makeJobsTransactor("jobs",b.READONLY,"readPersistedJob")(c.readPersistedJob),updatePersistedJob:a.makeJobsTransactor("jobs",b.READWRITE,"updatePersistedJob")(c.updatePersistedJob)}}g.getJobPersistenceAccessors=a}),98);
__d("WAJobRequirement",["Promise","WALogger"],(function(a,b,c,d,e,f,g){"use strict";var h,i;c=function(){function a(a){var c=this;this.$1=(i||(i=b("Promise"))).resolve();this.$2=!0;this.$3=null;this.$4=function(){var a=c.$3;if(a!=null){c.$3=null;return(i||(i=b("Promise"))).all(a).then(c.$4)}c.$2=!0};this.name=a}var c=a.prototype;c.addBlocker=function(a){var c=this;a=a["catch"](function(a){d("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["JobRequirement[","] blocker errored ",""])),c.name,a).sendLogs("job-blocker-rejected")});if(this.$2)this.$2=!1,this.$1=(i||(i=b("Promise"))).all([this.$1,a]).then(this.$4);else{var e=this.$3;e!=null?e.push(a):this.$3=[a]}};c.waitUntilSatisfied=function(){return this.$1};c.isSatisfied=function(){return this.$2};c.isSatisfiable=function(){return!0};return a}();e=function(a){function c(c){c=a.call(this,c)||this;a.prototype.addBlocker.call(c,new(i||(i=b("Promise")))(function(){}));return c}babelHelpers.inheritsLoose(c,a);var d=c.prototype;d.addBlocker=function(){};d.isSatisfiable=function(){return!1};return c}(c);function a(a,c){var d=a.filter(function(a){return!a.isSatisfiable()});if(d.length>0){var e=d.map(function(a){return a.name});return function(a){c==null||c("unsatisfiable",e,a);return d[0].waitUntilSatisfied()}}var f=a.map(function(){return(i||(i=b("Promise"))).resolve()}),g=(i||(i=b("Promise"))).resolve(),h=null,j=function(){if(f.every(function(b,c){return b===a[c].waitUntilSatisfied()})){h=null;return}var c=[],d=a.map(function(a){var b=a.waitUntilSatisfied();a.isSatisfied()||(c.push(a.name),void b.then(function(){var b=c.indexOf(a.name);c.splice(b,1)}));return b});f=d;h=c;return(i||(i=b("Promise"))).all(d).then(j)};return function(a){if(h==null){var b=j();b!=null&&(g=g.then(function(){return b}))}c==null||c(h==null?"satisfied":"unsatisfied",h,a);return g}}g.JobRequirement=c;g.UnsatisfiableJobRequirement=e;g.joinRequirements=a}),98);
__d("WAJobPriorityBucket",["WAJobOrchestratorTypes","WALogger"],(function(a,b,c,d,e,f,g){"use strict";var h,i;a=function(){function a(a){this.tasks=[];this.pendingTasks=[];this.lastJobStartedTimestampMs=null;this.jobMaxConcurrency=(a=a.jobMaxConcurrencyMap)!=null?a:{}}var b=a.prototype;b.updateConfig=function(a){this.jobMaxConcurrency=(a=a.jobMaxConcurrencyMap)!=null?a:{}};b.getStats=function(){return[].concat(this.tasks,this.pendingTasks).reduce(function(a,b){var c;c=(c=a[b.jobName])!=null?c:0;a[b.jobName]=c+1;return a},{})};b.next=function(){var a=this;if(this.tasks.length===0)return null;var b=this.pendingTasks.reduce(function(a,b){var c;c=(c=a.get(b.jobName))!=null?c:0;a.set(b.jobName,c+1);return a},new Map()),c=this.tasks.filter(function(c){var e;return((e=b.get(c.jobName))!=null?e:0)<((e=a.jobMaxConcurrency[c.jobName])!=null?e:d("WAJobOrchestratorTypes").DEFAULT_CONCURRENCY)});return c.length>0?[c[0]]:null};b.add=function(a,b,c,d){c={jobId:c,jobInfo:b,jobName:a,run:d};this.tasks.push(c);return c};b.markJobTaskPending=function(a){this.pendingTasks.includes(function(b){return b.jobId===a.jobId})&&d("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Assertion failed::markJobTaskPending found jobId: "," in pending tasks"])),a.jobId).sendLogs("JobOrchestrator::markJobTaskPending"),this.lastJobStartedTimestampMs=Date.now(),this.pendingTasks.push(a),this.tasks=this.tasks.filter(function(b){return b.jobId!==a.jobId})};b.markJobTaskDone=function(a){this.pendingTasks=this.pendingTasks.filter(function(b){return b.jobId!==a}),this.tasks.includes(function(b){return b.jobId===a})&&d("WALogger").ERROR(i||(i=babelHelpers.taggedTemplateLiteralLoose(["Assertion failed::markJobTaskDone found jobId: "," in scheduled tasks"])),a).sendLogs("JobOrchestrator::markJobTaskDone")};b.count=function(){return this.tasks.length};b.pendingCount=function(){return this.pendingTasks.length};b.clearWaitingTasks=function(){this.tasks=[]};b.clear=function(){this.tasks=[],this.pendingTasks=[]};b.getLastJobStartedTimestamp=function(){return this.lastJobStartedTimestampMs};return a}();b=function(a){function b(){return a.apply(this,arguments)||this}babelHelpers.inheritsLoose(b,a);var c=b.prototype;c.next=function(){var a=this,b,c;if(this.tasks.length===0)return null;var d=this.pendingTasks.reduce(function(a,b){var c;c=(c=a.get(b.jobName))!=null?c:0;a.set(b.jobName,c+1);return a},new Map()),e=this.tasks.filter(function(b){var c;return((c=d.get(b.jobName))!=null?c:0)<((c=a.jobMaxConcurrency[b.jobName])!=null?c:1)});if(e.length===0)return null;b=(b=this.jobMaxConcurrency[e[0].jobName])!=null?b:1;c=(c=d.get(e[0].jobName))!=null?c:0;if(b>1&&c<b){var f=e.filter(function(a){return a.jobName===e[0].jobName});b=Math.min(f.length,b-c);return f.slice(0,b)}return[e[0]]};return b}(a);g.BaseJobBucket=a;g.LowJobBucket=b}),98);
__d("WAMetrics",["Promise","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(){var a=d("WATimeUtils").performanceAbsoluteNow();return new(h||(h=b("Promise")))(function(b){setTimeout(function(){b(d("WATimeUtils").performanceAbsoluteNow()-a)},0)})}g.getEventLoopDelay=a}),98);
__d("WAConcurrentBucketJobQueue",["WABase64","WACryptoDependencies","WACustomError","WAJobOrchestratorTypes","WAJobPriorityBucket","WALogger","WAMetrics","WANullthrows","WAPromiseTimeout","err"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j=30,k=new Map([[d("WAJobOrchestratorTypes").JOB_PRIORITY.HIGH,5],[d("WAJobOrchestratorTypes").JOB_PRIORITY.LOW,1]]);function l(a){a=new Uint8Array(a);d("WACryptoDependencies").getCrypto().getRandomValues(a);return d("WABase64").encodeB64(a)}a=function(){function a(){this.$1=!1,this.$2=0,this.$3=0,this.$4=0,this.$5=new Map(),this.$6=new Map(),this.$7=new Map(),this.$9=0}var b=a.prototype;b.init=function(a,b){var e,f,g;if(this.$1)throw c("err")("WAConcurrentBucketJobQueue has already initialized");this.$4=(e=a==null?void 0:a.bestEffortWaitTimeoutSec)!=null?e:j;this.$2=a.maxConcurrency;this.$3=a.maxConcurrency;this.$8=b;this.$7=this.$11(a==null?void 0:a.jobPrioritiesQuota);this.$6=new Map(this.$7);this.$5=new Map();this.$9=Date.now();b=new(d("WAJobPriorityBucket").BaseJobBucket)({jobMaxConcurrencyMap:(e=a.maxConcurrencyPerJob)!=null?e:{}});e=new(d("WAJobPriorityBucket").LowJobBucket)({jobMaxConcurrencyMap:(e=a.maxConcurrencyPerJob)!=null?e:{}});f=new(d("WAJobPriorityBucket").LowJobBucket)({jobMaxConcurrencyMap:(f=a.maxConcurrencyPerJob)!=null?f:{}});g=new(d("WAJobPriorityBucket").BaseJobBucket)({jobMaxConcurrencyMap:(g=a.maxConcurrencyPerJob)!=null?g:{}});a=new(d("WAJobPriorityBucket").BaseJobBucket)({jobMaxConcurrencyMap:(a=a.maxConcurrencyPerJob)!=null?a:{}});this.$5.set(d("WAJobOrchestratorTypes").JOB_PRIORITY.UI_ACTION,b);this.$5.set(d("WAJobOrchestratorTypes").JOB_PRIORITY.HIGH,b);this.$5.set(d("WAJobOrchestratorTypes").JOB_PRIORITY.OFFLINE,g);this.$5.set(d("WAJobOrchestratorTypes").JOB_PRIORITY.HISTORY_SYNC,a);this.$5.set(d("WAJobOrchestratorTypes").JOB_PRIORITY.LOW,e);this.$5.set(d("WAJobOrchestratorTypes").JOB_PRIORITY.BEST_EFFORT,f);this.$1=!0};b.updateConfig=function(a){this.$3+=a.maxConcurrency-this.$2,this.$2=a.maxConcurrency,this.$5.forEach(function(b){return b.updateConfig({jobMaxConcurrencyMap:(b=a.maxConcurrencyPerJob)!=null?b:{}})}),this.$7=this.$11(a==null?void 0:a.jobPrioritiesQuota),d("WALogger").LOG(h||(h=babelHelpers.taggedTemplateLiteralLoose(["[job-orchestator]: updated WAConcurrentBucketJobQueue config"])))};b.isInitialized=function(){return this.$1};b.clearQueue=function(){if(!this.$1)throw c("err")("WAConcurrentBucketJobQueue not initialized");this.$5.forEach(function(a){return a.clear()})};b.clearQueueByPriority=function(a){if(!this.$1)throw c("err")("WAConcurrentBucketJobQueue not initialized");(a=this.$5.get(a))==null||a.clearWaitingTasks()};b.getIntStats=function(){var a=this,b=function(b){var c;b=a.$5.get(b);return((c=b==null?void 0:b.count())!=null?c:0)+((c=b==null?void 0:b.pendingCount())!=null?c:0)};return{highPriorityBucketSize:b(d("WAJobOrchestratorTypes").JOB_PRIORITY.HIGH),lowPriorityBucketSize:b(d("WAJobOrchestratorTypes").JOB_PRIORITY.LOW),bestEffortPriorityBucketSize:b(d("WAJobOrchestratorTypes").JOB_PRIORITY.BEST_EFFORT)}};b.getStringStats=function(){var a=this,b=function(b){var c=(b=(b=a.$5.get(b))==null?void 0:b.getStats())!=null?b:{};b=Object.keys(c).reduce(function(a,b){var d=a[0];a=a[1];var e=c[b];return e>d?[e,b]:[d,a]},[0,null]);b=b[1];return b};return{highPriorityMaxJob:b(d("WAJobOrchestratorTypes").JOB_PRIORITY.HIGH),lowPriorityMaxJob:b(d("WAJobOrchestratorTypes").JOB_PRIORITY.LOW),bestEffortPriorityMaxJob:b(d("WAJobOrchestratorTypes").JOB_PRIORITY.BEST_EFFORT)}};b.enqueue=function(a,b,e,f){var g,h=this;if(!this.$1)return Promise.reject(c("err")("WAConcurrentBucketJobQueue not initialized"));var i,j,k=new Promise(function(a,b){i=a,j=b}),m=babelHelpers.extends({priority:d("WAJobOrchestratorTypes").DEFAULT_JOB_PRIORITY},e),n=this.getJobBucketByType(m.priority);if(!n)return Promise.reject(c("err")("WAConcurrentBucketJobQueue no bucket for job with name "+a+" was found."));void d("WAMetrics").getEventLoopDelay().then(function(a){f!=null&&f.isActive()&&(f==null||f.addPoint("measure_event_loop_delay",{int:{eventLoopDelay:a}}))});f==null||f.addPoint("scheduling_job",{string:babelHelpers.extends({},this.getStringStats(),{priority:m.priority}),int:babelHelpers.extends({},this.getIntStats(),{maxTimeoutMs:(g=e==null?void 0:e.maxTimeoutMs)!=null?g:0})});var o=m.priority+"-"+a+"-"+((g=e==null?void 0:e.jobId)!=null?g:l(8));g=n.add(a,m,o,async function(){try{h.$8.logJobStarted(o);var a=await h.$12(b(),e==null?void 0:e.maxTimeoutMs);h.$8.logJobCompleted(o);i(a)}catch(a){a instanceof d("WACustomError").TimeoutError?h.$8.logJobTimeout(o):h.$8.logJobError(o),j(a)}});this.$8.logJobCreated({jobId:o,jobName:a,jobPriority:m.priority,pendingJobsCount:n.count()});e&&e.priority===d("WAJobOrchestratorTypes").JOB_PRIORITY.UI_ACTION&&void this.$13(g);this.$14();return k};b.getAvailableThreadsCount=function(){return this.$3};b.getJobQuotaConfig=function(){return this.$7};b.getRemainingJobCountMap=function(){return this.$6};b.getJobBucketByType=function(a){return this.$5.get(a)};b.getSnapshot=function(a){a=this.getJobBucketByType(a);return!a?null:a.getStats()};b.$11=function(a){var b;!a?b=new Map(k):b=new Map(a);b.set(d("WAJobOrchestratorTypes").JOB_PRIORITY.BEST_EFFORT,0);return b};b.$15=function(a){return(a=this.$6.get(a))!=null?a:0};b.$16=function(){this.$6=new Map(this.$7)};b.$17=function(a){var b=this;a===void 0&&(a=!0);var c=0,e=null,f=0;this.$5.forEach(function(a,d){c+=a==null?void 0:a.count();f+=b.$15(d);if(e!=null)return;a.count()>0&&b.$15(d)>0&&(e=a)});var g=e==null||f===0;g&&this.$16();if(this.$18(c,g))return this.getJobBucketByType(d("WAJobOrchestratorTypes").JOB_PRIORITY.BEST_EFFORT);return e==null&&a?this.$17(!1):e};b.$18=function(a,b){var c=this;function e(a,b){var c=Date.now();return a>c?!1:c-a<b*1e3}function f(a,b){a=Math.ceil(a-Date.now())+b*1e3;return a>0?a:0}var g=this.getJobBucketByType(d("WAJobOrchestratorTypes").JOB_PRIORITY.BEST_EFFORT);a=a-((a=g==null?void 0:g.count())!=null?a:0);var h=g==null?void 0:g.getLastJobStartedTimestamp();if((g==null?void 0:g.count())===0)return!1;if(h==null&&e(this.$9,this.$4)){if(this.$10==null){g=f(this.$9,this.$4);this.$10=setTimeout(function(){c.$14(),c.$10=null},g)}return!1}return a>0&&h!=null&&e(h,this.$4)?!1:b};b.$19=function(a){a=this.$20(a);return c("WANullthrows")(this.$5.get(a))};b.$20=function(a){var b=a.split("-")[0];b=d("WAJobOrchestratorTypes").JOB_PRIORITY.cast(b);if(!b)throw c("err")("ConcurrentBucketQueue cannot extract known job priority type from id: "+a);return b};b.$21=function(a){a=this.$20(a);this.$15(a)>0?this.$6.set(a,this.$15(a)-1):this.$6.set(a,0)};b.$14=function(){var a=this;while(this.$3>0){var b=this.$17();b=b==null?void 0:b.next();if(b==null)break;b.forEach(function(b){a.$21(b.jobId),void a.$13(b)})}};b.$12=function(a,b){return b!==void 0?d("WAPromiseTimeout").promiseTimeout(a,b):a};b.$13=async function(a){var b=this,c=this.$19(a.jobId);this.$3--;c.markJobTaskPending(a);var e=a.run,f=a.jobId,g=a.jobName;try{await this.$12(e(),((e=a.jobInfo)==null?void 0:e.maxTimeoutMs)===void 0?d("WAJobOrchestratorTypes").DEFAULT_JOB_TIMEOUT_MS:void 0)}catch(a){if(a instanceof d("WACustomError").TimeoutError)this.$8.logJobTimeout(f),d("WALogger").LOG(i||(i=babelHelpers.taggedTemplateLiteralLoose(["[job-orchestator]: "," exceeding the timeout, release the thread."])),g);else throw a}finally{this.$3++,c.markJobTaskDone(f),this.$3>0&&setTimeout(function(){return b.$14()},0)}};return a}();g.WAConcurrentBucketJobQueue=a}),98);
__d("WAConcurrentPreemptiveJobQueue",["WACustomError","WAJobOrchestratorTypes","WALogger","WAPromiseTimeout","WARandomHex","err"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k;a=function(){function a(){this.$1=!1,this.$2=0,this.$3=0,this.$4={},this.$5=[],this.$6=[]}var b=a.prototype;b.init=function(a,b){if(this.$1)throw c("err")("ConcurrentPreemptiveJobQueue has already initialized");this.$2=a.maxConcurrency;this.$3=a.maxConcurrency;this.$4=(a=a.maxConcurrencyPerJob)!=null?a:{};this.$7=b;this.$1=!0};b.updateConfig=function(a){this.$3+=a.maxConcurrency-this.$2;this.$2=a.maxConcurrency;this.$4=(a=a.maxConcurrencyPerJob)!=null?a:{};d("WALogger").LOG(h||(h=babelHelpers.taggedTemplateLiteralLoose(["[job-orchestator]: updated ConcurrentPreemptiveJobQueue config"])))};b.isInitialized=function(){return this.$1};b.clearQueueByPriority=function(a){if(!this.$1)throw c("err")("ConcurrentPreemptiveJobQueue not initialized");this.$5=this.$5.filter(function(b){return((b=b.jobInfo)==null?void 0:b.priority)!==a})};b.clearQueue=function(){if(!this.$1)throw c("err")("ConcurrentPreemptiveJobQueue not initialized");this.$5=[];this.$6=[]};b.enqueue=function(a,b,e){var f,g=this;if(!this.$1)return Promise.reject(c("err")("ConcurrentPreemptiveJobQueue not initialized"));var h,i,j=new Promise(function(a,b){h=a,i=b}),k=babelHelpers.extends({priority:d("WAJobOrchestratorTypes").DEFAULT_JOB_PRIORITY},e),l=(f=e==null?void 0:e.jobId)!=null?f:d("WARandomHex").randomHex(8).substr(0,64);f=this.$8(a,k,l,async function(){try{g.$7.logJobStarted(l);var a=await g.$9(b(),e==null?void 0:e.maxTimeoutMs);g.$7.logJobCompleted(l);h(a)}catch(a){a instanceof d("WACustomError").TimeoutError?g.$7.logJobTimeout(l):g.$7.logJobError(l),i(a)}});e&&e.priority===d("WAJobOrchestratorTypes").JOB_PRIORITY.UI_ACTION&&this.$10(f);this.$11();return j};b.getAvailableThreadsCount=function(){return this.$3};b.getJobMaxConcurrency=function(){return this.$4};b.getSnapshot=function(a){};b.$11=function(){while(this.$3>0){var a=this.$12();if(a==null)break;this.$10(a)}};b.$9=function(a,b){return b!==void 0?d("WAPromiseTimeout").promiseTimeout(a,b):a};b.$10=async function(a){var b=this;this.$3--;this.$13(a);var c=a.run,e=a.jobId,f=a.jobName;try{await this.$9(c(),((c=a.jobInfo)==null?void 0:c.maxTimeoutMs)===void 0?d("WAJobOrchestratorTypes").DEFAULT_JOB_TIMEOUT_MS:void 0)}catch(a){if(a instanceof d("WACustomError").TimeoutError)this.$7.logJobTimeout(e),d("WALogger").LOG(i||(i=babelHelpers.taggedTemplateLiteralLoose(["[job-orchestator]: "," exceeding the timeout, release the thread."])),f);else throw a}finally{this.$3++,this.$14(e),setTimeout(function(){return b.$11()},0)}};b.$8=function(a,b,c,d){d={jobId:c,jobInfo:b,jobName:a,run:d};this.$7.logJobCreated({jobId:c,jobName:a,jobPriority:b.priority,pendingJobsCount:this.$5.length});this.$5.push(d);return d};b.$13=function(a){this.$6.includes(function(b){return b.jobId===a.jobId})&&d("WALogger").ERROR(j||(j=babelHelpers.taggedTemplateLiteralLoose(["Assertion failed::markJobTaskPending found jobId: "," in pending tasks"])),a.jobId).sendLogs("JobOrchestrator::markJobTaskPending"),this.$6.push(a),this.$5=this.$5.filter(function(b){return b.jobId!==a.jobId})};b.$14=function(a){this.$6=this.$6.filter(function(b){return b.jobId!==a}),this.$5.includes(function(b){return b.jobId===a})&&d("WALogger").ERROR(k||(k=babelHelpers.taggedTemplateLiteralLoose(["Assertion failed::markJobTaskDone found jobId: "," in scheduled tasks"])),a).sendLogs("JobOrchestrator::markJobTaskDone")};b.$12=function(){var a=this;if(this.$5.length===0)return null;var b=this.$6.reduce(function(a,b){var c;c=(c=a.get(b.jobName))!=null?c:0;a.set(b.jobName,c+1);return a},new Map()),c=this.$5.filter(function(c){var d;return((d=b.get(c.jobName))!=null?d:0)<((d=a.$4[c.jobName])!=null?d:1)});return c[0]};return a}();g.WAConcurrentPreemptiveJobQueue=a}),98);
__d("WADefaultJobNoQueue",["WAJobOrchestratorTypes","WARandomHex","err"],(function(a,b,c,d,e,f,g){"use strict";a=function(){function a(){this.$2=!1}var b=a.prototype;b.init=function(a,b){if(this.$2)throw c("err")("DefaultNoQueue has already initialized");this.$1=b;this.$2=!0};b.updateConfig=function(a){};b.isInitialized=function(){return this.$2};b.clearQueue=function(){};b.clearQueueByPriority=function(a){};b.getSnapshot=function(){throw c("err")("getSnapshot is not implemented for DefaultNoQueue")};b.enqueue=async function(a,b,c){var e;e=(e=c==null?void 0:c.jobId)!=null?e:d("WARandomHex").randomHex(8).substr(0,64);this.$1.logJobCreated({jobId:e,jobName:a,jobPriority:(a=c==null?void 0:c.priority)!=null?a:d("WAJobOrchestratorTypes").JOB_PRIORITY.LOW,pendingJobsCount:0});try{this.$1.logJobStarted(e);c=await b();this.$1.logJobCompleted(e);return c}catch(a){this.$1.logJobError(e);throw a}};return a}();g.WADefaultJobNoQueue=a}),98);
__d("WAOrchestratorJobStatsLogger",["WAGlobals","WAPREList","WAPREMetrics"],(function(a,b,c,d,e,f,g){"use strict";var h=function(){function a(a,b,c){this.jobName=a,this.pendingJobsCount=c,this.jobPriority=b}var b=a.prototype;b.logJobAdded=function(){this.webcJobAddedT=Date.now(),this.eventFlow=d("WAPREMetrics").startMetric(d("WAPREList").PRE_METRIC.WA_JOBS_ORCHESTRATOR,{string:{name:this.jobName,jobPriority:this.jobPriority,orchestratorVersion:d("WAGlobals").getConfig().orchestratorVersion()},"int":{pendingJobsCount:this.pendingJobsCount,addedAt:this.webcJobAddedT}})};b.logJobStarted=function(){this.webcJobStartedT=Date.now(),this.eventFlow.addPoint("start_job",{"int":{startedAt:this.webcJobStartedT}})};b.logJobCompleted=function(a){this.webcJobCompletedT=Date.now();this.jobResultType=a;var b={"int":{pendingJobsCount:this.pendingJobsCount,completedAt:this.webcJobCompletedT}};a==="completed"?this.eventFlow.endSuccess(b):this.eventFlow.endFail(a,b)};return a}();a=function(){function a(){this.$1=new Map()}var b=a.prototype;b.logJobCreated=function(a){var b=a.jobName,c=a.jobId,d=a.jobPriority;a=a.pendingJobsCount;b=new h(b,d,a);b.logJobAdded();this.$1.set(c,b)};b.logJobStarted=function(a){a=this.$1.get(a);a==null||a.logJobStarted()};b.logJobCompleted=function(a){this.$2(a,"completed")};b.logJobError=function(a){this.$2(a,"error")};b.logJobTimeout=function(a){this.$2(a,"timeout")};b.logJobAborted=function(a){this.$2(a,"aborted")};b.$2=function(a,b){var c=this.$1.get(a);c==null||c.logJobCompleted(b);this.$1["delete"](a)};return a}();g.JobInfoEvent=h;g.JobStatsLogger=a}),98);
__d("WAOrchestrator",["WAConcurrentBucketJobQueue","WAConcurrentPreemptiveJobQueue","WADefaultJobNoQueue","WAGlobals","WAJobOrchestratorTypes","WAOrchestratorJobStatsLogger"],(function(a,b,c,d,e,f,g){"use strict";function a(){var a={maxConcurrency:1},b="default",c={},e=a,f=new(d("WAOrchestratorJobStatsLogger").JobStatsLogger)();return function(g,j){var k;g===void 0&&(g=!1);g=g?b:d("WAGlobals").getConfig().orchestratorVersion();k=(k=i())!=null?k:a;var l;j==null||j.addPoint("get_orchestrator",{string:{orchestrator:g},"int":{maxConcurrency:k.maxConcurrency,highPriorityQuota:(j=(j=k.jobPrioritiesQuota)==null?void 0:j.get(d("WAJobOrchestratorTypes").JOB_PRIORITY.HIGH))!=null?j:0,lowPriorityQuota:(j=(j=k.jobPrioritiesQuota)==null?void 0:j.get(d("WAJobOrchestratorTypes").JOB_PRIORITY.LOW))!=null?j:0}});if(c[g]){h(e,k)&&(e=k,c[g].updateConfig(k));return c[g]}switch(g){case"preemptive":l=new(d("WAConcurrentPreemptiveJobQueue").WAConcurrentPreemptiveJobQueue)();break;case"bucket":l=new(d("WAConcurrentBucketJobQueue").WAConcurrentBucketJobQueue)();break;default:l=new(d("WADefaultJobNoQueue").WADefaultJobNoQueue)();break}l.init(k,f);c[g]=l;e=k;return l}}function h(a,b){var c;if(a.maxConcurrency!==b.maxConcurrency)return!0;if(((c=a.jobPrioritiesQuota)==null?void 0:c.size)!==((c=b.jobPrioritiesQuota)==null?void 0:c.size))return!0;return Object.keys((c=a.maxConcurrencyPerJob)!=null?c:{}).length!==Object.keys((c=b.maxConcurrencyPerJob)!=null?c:{}).length?!0:JSON.stringify(a)!==JSON.stringify(b)}function i(){var a={jobPrioritiesQuota:new Map([[d("WAJobOrchestratorTypes").JOB_PRIORITY.HIGH,5],[d("WAJobOrchestratorTypes").JOB_PRIORITY.LOW,1]]),maxConcurrency:5,maxConcurrencyPerJob:{}};return a}g.getInstanceDelegate=a}),98);
__d("WAPromiseBackoffs",["Promise","err"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a,b){if(a===0)return 0;var c=o(b.algo);for(var d=1;d<a;d++)c();return j(b,c())}function i(a){var b=a.relativeDelay,c=b===void 0?!1:b,d=null,e=o(a.algo);return function(){var b=d;if(b==null){d=c?Date.now():0;return 0}var f=j(a,e());if(c){var g=Date.now();b=g-b;b>0&&(f=Math.max(0,f-b));d=g}return f}}function d(a){var c=i(a);return function(a){return new(h||(h=b("Promise")))(function(b){var d=c();d>0?setTimeout(b,d,a):b(a)})}}function j(a,b){var c=a.max,d=a.min;a=a.jitter;a=a===void 0?.1:a;b=b;c!=null&&b>c&&(b=c);d!=null&&b<d&&(b=d);a!==0&&(b=Math.ceil(b*(1+a*Math.random())));return b}function k(a){var b=a.second-a.first,c=a.first-b;return function(){var a=b+c;c=b;b=a;return a}}function l(a){var b=a.base,c=b===void 0?2:b,d=a.first;return function(){var a=d;d*=c;return a}}function m(a){var b=a.delay;return function(){return b}}function n(a){var b=a.toMs;a=a.backoff;var c=o(a);return function(){return b(c())}}function o(a){switch(a.type){case"fibonacci":return k(a);case"exponential":return l(a);case"constant":return m(a);case"adjust":return n(a);default:a;throw c("err")("makeTimeFunc unrecognized backoff "+a.type)}}g.getDelay=a;g.createTimer=i;g.createPromiseTimer=d}),98);
__d("WAPersistedJobManager",["WAJobRequirement","WALogger","WAPromiseBackoffs","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K=1,L=function(){function a(a){this.feature=a}var b=a.prototype;b.toString=function(){return"RequiresPage: "+this.feature};return a}(),M=function(){function a(a){this.backoffOptions=a}var b=a.prototype;b.toString=function(){return"RetryOnBackoff"};return a}();a=function(a){function b(){return a.apply(this,arguments)||this}babelHelpers.inheritsLoose(b,a);var c=b.prototype;c.toString=function(){return"NonRetryableError"};return b}(babelHelpers.wrapNativeSuper(Error));var N=function(a){this.result=a},O="$unstarted",P="$finished";b=function(){function a(a){var b=this,c=a.isRestartAfterCrash,e=a.accessors,f=a.unfinishedJobEntries,g=new Map();f=f.then(function(a){var f=[],j=[];a.forEach(function(a){a.stepHardStartCountAfterTimeout>=5?f.push(a):j.push(a)});return Promise.all(f.map(function(a){d("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["",": stuck on the step ",", aborting the job"])),R(a),a.step).devConsole(Q(a)).sendLogs("job-stuck-"+a.type);return e.deletePersistedJob(a.jobId)})).then(function(){j.forEach(function(a){if(g.has(a.jobId))return;d("WALogger").LOG(i||(i=babelHelpers.taggedTemplateLiteralLoose(["",": restarting"])),Q(a));g.set(a.jobId,b.$1(a,c))})})});this.implementationLoaders=new Map();this.implementations=new Map();this.stepBlockers=new WeakMap();this.accessors=e;this.activeJobs=g;this.initialJobsPromise=f;this.listeners=a.listeners;this.deprecatedJobs=a.deprecatedJobs}var b=a.prototype;b.loadAndRunJobFromId=function(a){var b=this.activeJobs.get(a);if(b!=null)return b;b=this.$2(a);this.activeJobs.set(a,b);return b};b.$2=async function(a){var b=this.initialJobsPromise,c=this.accessors;await b;b=await c.readPersistedJob(a);if(!b){d("WALogger").DEV(j||(j=babelHelpers.taggedTemplateLiteralLoose(["No entry for job ",""])),a);d("WALogger").WARN(k||(k=babelHelpers.taggedTemplateLiteralLoose(["Persisted job missing for given ID"])));return null}return this.$1(b,!1)};b.$3=function(a){var b=this.implementations,c=this.implementationLoaders,d=b.get(a);if(d)return d;d=c.get(a);if(!d)return null;c=d();b.set(a,c);return c};b.$4=function(a,b){if(b==null||b.length===0)return Promise.resolve();var c=this.stepBlockers,e=c.get(b);e==null&&(e=d("WAJobRequirement").joinRequirements(b.map(function(a){return a()}),T),c.set(b,e));return e(a)};b.$5=function(a,b,c,e){var f=this;c===void 0&&(c=!1);var g=a.step,h=b.findIndex(function(a){return a.stepName===g}),i=b[h].info(a.current,a.original,U(a,c)),j=i.requirements,k=i.code;i=this.$4(a,j);e&&(i=i.then(e));return i.then(function(){d("WALogger").LOG(l||(l=babelHelpers.taggedTemplateLiteralLoose(["",": running step"])),S(a));return k(a.current,a.original,U(a,c))}).then(function(e){if(e instanceof N){d("WALogger").LOG(m||(m=babelHelpers.taggedTemplateLiteralLoose(["",": InterruptJob"])),S(a));return e.result}var g=h+1;if(g>=b.length)return e;g=b[g];a.step=g.stepName;a.current=e;a.stepHardStartCountAfterTimeout=0;a.stepFirstStartTime=d("WATimeUtils").unixTime();a.stepUnexpectedErrorCount=0;a.waitUntil=null;a.backedOffCount=0;return f.accessors.updatePersistedJob(a).then(function(){return f.$5(a,b,c)})})};b.$1=async function(a,b){var c=this,e=this.accessors,f=this.activeJobs,g=this.deprecatedJobs,h=this.listeners,i=h.onJobFinished;h=h.onJobStarted;var j=await this.$3(a.type);g=g[a.type];if(!j){if(!g){d("WALogger").ERROR(n||(n=babelHelpers.taggedTemplateLiteralLoose(["No implementation for ",". Maybe it should have been put to the deprecated list?"])),a.type).sendLogs("missing-job-implementation");await e.deletePersistedJob(a.jobId);return null}else if(g==="NOOP"){d("WALogger").WARN(o||(o=babelHelpers.taggedTemplateLiteralLoose(["No implementation for deprecated ",", job deleted"])),a.type);await e.deletePersistedJob(a.jobId);return null}j=await g()}var k=j;g&&d("WALogger").LOG(p||(p=babelHelpers.taggedTemplateLiteralLoose(["Running deprecated job ",""])),a.type);var l=(g=a.stepFirstStartTime)!=null?g:d("WATimeUtils").unixTime();a.stepFirstStartTime=l;a.stepUnexpectedErrorCount=a.stepUnexpectedErrorCount||0;a.backedOffCount=a.backedOffCount||0;if(a.step===P){g=a.waitUntil;var m=d("WATimeUtils").secondsUntil(l);g!=null&&d("WATimeUtils").isInFuture(g)&&m>0&&(d("WALogger").LOG(q||(q=babelHelpers.taggedTemplateLiteralLoose(["",": skew detected, adjusting accordingly"])),Q(a)),g=d("WATimeUtils").castToUnixTime(g-m),d("WATimeUtils").isInFuture(g)&&(a.stepFirstStartTime=d("WATimeUtils").castToUnixTime(l-m),a.waitUntil=g,await this.accessors.updatePersistedJob(a)));(g==null||!d("WATimeUtils").isInFuture(g))&&(d("WALogger").LOG(r||(r=babelHelpers.taggedTemplateLiteralLoose(["",": removing completed, expired job from db"])),Q(a)),await e.deletePersistedJob(a.jobId));f.delete(a.jobId);return a.current}m=a.step!==O?j.find(function(b){return b.stepName===a.step}):j[0];if(!m){d("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["No implementation for ",".",""])),a.type,a.step).sendLogs("missing-job-step");await e.deletePersistedJob(a.jobId);return null}a.step=m.stepName;var E=function(){var e=a.waitUntil,f=Promise.resolve();if(e!=null){var g=d("WATimeUtils").futureUnixTime(d("WATimeUtils").DAY_SECONDS);e>g?(d("WALogger").LOG(t||(t=babelHelpers.taggedTemplateLiteralLoose(["",": trim wait from "," to ",""])),S(a),e,g),a.waitUntil=g,f=c.accessors.updatePersistedJob(a).then(function(){return d("WATimeUtils").delayUntil(g)})):(d("WALogger").LOG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["",": delaying until ",""])),S(a),e),f=d("WATimeUtils").delayUntil(e))}return f.then(function(){var e=function(){a.waitUntil=null;d("WATimeUtils").happenedWithin(l,d("WATimeUtils").DAY_SECONDS)||a.stepHardStartCountAfterTimeout++;return c.accessors.updatePersistedJob(a)};return c.$5(a,k,b,e).catch(function(b){if(b instanceof L){d("WALogger").LOG(v||(v=babelHelpers.taggedTemplateLiteralLoose(["",": requires page"])),S(a));a.stepHardStartCountAfterTimeout>0&&(--a.stepHardStartCountAfterTimeout,c.accessors.updatePersistedJob(a));return new Promise(function(){})}else if(b instanceof M){d("WALogger").LOG(w||(w=babelHelpers.taggedTemplateLiteralLoose(["",": RetryOnBackoff"])),S(a));var e=d("WAPromiseBackoffs").getDelay(++a.backedOffCount,b.backoffOptions);a.waitUntil=d("WATimeUtils").futureUnixTime(Math.ceil(e/1e3));a.stepHardStartCountAfterTimeout>0&&--a.stepHardStartCountAfterTimeout;return c.accessors.updatePersistedJob(a).then(E)}else if(a.stepUnexpectedErrorCount<K){d("WALogger").WARN(x||(x=babelHelpers.taggedTemplateLiteralLoose(["",": Unhandled exception. Tried "," times"])),S(a),a.stepUnexpectedErrorCount);d("WALogger").WARN(y||(y=babelHelpers.taggedTemplateLiteralLoose(["",": Unhandled exception: ",""])),S(a),b);a.stepUnexpectedErrorCount++;return c.accessors.updatePersistedJob(a).then(E)}throw b})})},F=E();g=F.then(async function(b){d("WALogger").LOG(z||(z=babelHelpers.taggedTemplateLiteralLoose(["",": finished job"])),S(a));var g=null;try{g=i(a.jobId,a.type,a.original,b)}catch(b){d("WALogger").ERROR(A||(A=babelHelpers.taggedTemplateLiteralLoose(["onJobFinished for "," threw exception ",""])),a.type,b).sendLogs("onJobFinished-threw")}g!=null&&g>0?(a.waitUntil=d("WATimeUtils").futureUnixTime(Math.ceil(g/1e3)),a.step=P,a.current=b,a.stepFirstStartTime=d("WATimeUtils").unixTime(),await c.accessors.updatePersistedJob(a)):(await e.deletePersistedJob(a.jobId),f.delete(a.jobId))},async function(c){d("WALogger").ERROR(B||(B=babelHelpers.taggedTemplateLiteralLoose([""," failed with error ",""])),a.type,c).sendLogs("job-threw-exception-"+a.type);c=k.find(function(b){return b.stepName===a.step});if(!c)d("WALogger").ERROR(C||(C=babelHelpers.taggedTemplateLiteralLoose(["",": "," step not found"])),a.type,a.step);else{c=c.info(a.current,a.original,U(a,b));c.stopRetryIf!=null&&await c.stopRetryIf.onStopRetry(a.current,a.original,U(a,b))}await e.deletePersistedJob(a.jobId);f.delete(a.jobId)});try{h(a.jobId,a.type,a.original)}catch(b){d("WALogger").ERROR(D||(D=babelHelpers.taggedTemplateLiteralLoose(["onJobStarted for "," threw exception ",""])),a.type,b).sendLogs("onJobStarted-threw")}return g.then(function(){return F})};b.addPersistedJobImplementation=function(a,b){var c=this.implementationLoaders,e=this.deprecatedJobs;if(c.has(a)){d("WALogger").ERROR(E||(E=babelHelpers.taggedTemplateLiteralLoose(["addPersistedJobImplementation called twice for ",""])),a).sendLogs("repeat-job-loader");return}e&&e[a]&&d("WALogger").DEV(F||(F=babelHelpers.taggedTemplateLiteralLoose([""," has been loaded and is marked as deprecated"])),a);c.set(a,b)};b.fireAndForget=function(a){var b=this;this.accessors.maybeCreateJob(a).then(function(a){a=a.id;return b.loadAndRunJobFromId(a)})};b.waitUntilPersisted=function(a){var b=this;return this.accessors.maybeCreateJob(a).then(function(a){a=a.id;b.loadAndRunJobFromId(a)})};b.waitUntilCompleted=function(a){var b=this;return this.accessors.maybeCreateJob(a).then(function(a){a=a.id;return b.loadAndRunJobFromId(a)})};b.fireAndForgetNonPersisted=function(a){d("WALogger").LOG(G||(G=babelHelpers.taggedTemplateLiteralLoose(["fireAndForgetNonPersisted not implemented in PersistedJobManager"])))};b.waitUntilCompletedNonPersisted=function(a){return Promise.resolve(function(){return d("WALogger").LOG(H||(H=babelHelpers.taggedTemplateLiteralLoose(["waitUntilCompletedNonPersisted not implemented in PersistedJobManager"])))})};return a}();function Q(a){return"Job["+a.jobId+"] ("+a.type+")"}function R(a){return"[Job "+a.type+"] "}function S(a){return"Job["+a.jobId+"] ("+a.type+"."+a.step+")"}function T(a,b,c){a==="unsatisfiable"?d("WALogger").LOG(I||(I=babelHelpers.taggedTemplateLiteralLoose([""," halting because of ",""])),S(c),b):a==="unsatisfied"?d("WALogger").LOG(J||(J=babelHelpers.taggedTemplateLiteralLoose([""," waiting on ",""])),S(c),b):a}function U(a,b){b===void 0&&(b=!1);return{jobStartTime:a.startTime,afterCrash:b,interruptJob:V}}function V(a){return new N(a)}g.RequiresPage=L;g.RetryOnBackoff=M;g.NonRetryableError=a;g.InterruptJob=N;g.UNSTARTED_JOB=O;g.FINISHED_JOB=P;g.PersistedJobManager=b}),98);
__d("WaJobInMemoryAccessors",["Promise","WARandomHex","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(){var a=-1,c=new Map();return{deletePersistedJob:function(a){return(h||(h=b("Promise"))).resolve(c["delete"](a))},loadAllJobs:function(){return(h||(h=b("Promise"))).resolve(Array.from(c.values()))},maybeCreateJob:function(e){var f,g=JSON.stringify([e.type,(f=e.uniqKey)!=null?f:d("WARandomHex").randomHex(32)]),i={backedOffCount:0,current:e.args,original:e.args,startTime:d("WATimeUtils").unixTime(),step:"$unstarted",stepFirstStartTime:null,stepHardStartCountAfterTimeout:0,stepUnexpectedErrorCount:0,type:e.type,uniqKey:g,version:e.version,waitUntil:null,scheduleConfig:e.scheduleConfig};f=function(){var d=a--,e=babelHelpers["extends"]({},i,{jobId:d});c.set(d,e);return(h||(h=b("Promise"))).resolve({id:d,newlyCreated:!0})};if(e.uniqKey!=null){e=Array.from(c.values()).filter(function(a){return a.uniqKey===g});if(e.length===0)return f();var j=null;e.forEach(function(a){a.step!=="$finished"?j=a:c["delete"](a.jobId)});return j!=null?(h||(h=b("Promise"))).resolve({id:j.jobId,newlyCreated:!1}):f()}return f()},readPersistedJob:function(a){a=c.get(a);return(h||(h=b("Promise"))).resolve(a&&babelHelpers["extends"]({},a))},updatePersistedJob:function(a){return(h||(h=b("Promise"))).resolve(c.set(a.jobId,babelHelpers["extends"]({},a)))}}}g.getJobInMemoryAccessors=a}),98);
__d("WAPersistedJobManagerV2",["WAGlobals","WAJids","WAJobOrchestratorTypes","WAJobRequirement","WALogger","WAOrchestrator","WAPREList","WAPREMetrics","WAPersistedJobManager","WAPromiseBackoffs","WAResolvable","WATimeUtils","WaJobInMemoryAccessors","err"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M=1;function N(a){var b=a.code,c=a.annotations;c=c===void 0?{}:c;a=a.eventFlow;var d=a===void 0?O(c):a;return b(d).then(function(a){d.endSuccess();return a}).catch(function(a){d.endFail("error",{string:{error:""+a}});throw a})}function O(a){a===void 0&&(a={});return d("WAPREMetrics").startMetric(d("WAPREList").PRE_METRIC.WA_JOB_MANAGER,babelHelpers.extends({},a,{string:babelHelpers.extends({},(a=(a=a)==null?void 0:a.string)!=null?a:{},{userHash:d("WAGlobals").getDependencies().isEmployee()&&d("WAGlobals").getDependencies().isUseridAnnotationEnabled()?d("WAJids").extractUserId(d("WAGlobals").getMyUserJid()).slice(-5):null})}))}a=function(){function a(a){var b=this;this.$1=[];var c=a.isRestartAfterCrash,e=a.accessors,f=a.unfinishedJobEntries,g=a.ignoreForceNonPersistedJobList;this.getOrchestratorDelegate=d("WAOrchestrator").getInstanceDelegate();this.activeJobs=new Map();this.implementationLoaders=new Map();this.implementations=new Map();this.stepBlockers=new WeakMap();this.accessors=e;this.isRestartAfterCrash=c||!1;this.listeners=a.listeners;this.deprecatedJobs=a.deprecatedJobs;this.inMemoryAccessors=d("WaJobInMemoryAccessors").getJobInMemoryAccessors();this.offlineQueueMode=!0;this.$1=g;a.offlineQueueCompletePromise!=null?a.offlineQueueCompletePromise.finally(function(){b.offlineQueueMode=!1}):this.offlineQueueMode=!1;this.initialJobsPromise=f.then(function(a){var c=[],e=[];a.forEach(function(a){a.stepHardStartCountAfterTimeout>=5?c.push(a):e.push(a)});return Promise.all(c.map(function(a){d("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["",": stuck on the step ",", aborting the job"])),Q(a),a.step).devConsole(P(a)).sendLogs("job-stuck-"+a.type);return b.accessors.deletePersistedJob(a.jobId)})).then(function(){e.forEach(function(a){var c=b.$2(a.jobId);if(c.alreadyActive===!0){d("WALogger").ERROR(i||(i=babelHelpers.taggedTemplateLiteralLoose(["[JOB MANAGER] Restarting job with the same id"])));return}c.deferred.resolve(N({code:function(c){return b.$3(a,b.accessors,{eventFlow:c})},annotations:{string:{name:a.type},bool:{offlineQueueMode:b.offlineQueueMode}}}))})})})}var b=a.prototype;b.$4=async function(a,b,e){var f;e===void 0&&(e={});var g=this.$2(a);(f=e.eventFlow)==null||f.addPoint("start_load_and_run",{bool:{skipped:g.alreadyActive}});if(g.alreadyActive===!0)return g.deferred;f=await b.readPersistedJob(a);if(f==null){d("WALogger").ERROR(j||(j=babelHelpers.taggedTemplateLiteralLoose(["Persisted job missing for given ID"]))).sendLogs("missing-job-entry");throw c("err")("Persisted job missing for given ID "+a)}g.deferred.resolve(this.$3(f,b,e));return g.deferred.promise};b.$3=function(a,b,c){var e;c===void 0&&(c={});(e=c.eventFlow)==null||e.addPoint("enqueueing_job",{string:{name:a.type}});return this.getOrchestratorDelegate(((e=a.scheduleConfig)==null?void 0:e.priority)===d("WAJobOrchestratorTypes").JOB_PRIORITY.SKIP,c.eventFlow).enqueue(a.type,this.$5(a,b,c),a.scheduleConfig,c.eventFlow)};b.$6=function(a,b,c){var d=this;c===void 0&&(c={});return b.maybeCreateJob(a).then(function(a){var e;a=a.id;(e=c.eventFlow)==null||e.addPoint("job_persisted",{int:{jobId:a},bool:{nonPersisted:b===d.inMemoryAccessors}});return a})};b.$2=function(a){var b=this.activeJobs.get(a);if(b!=null)return{alreadyActive:!0,deferred:b};b=new(d("WAResolvable").Resolvable)();this.activeJobs.set(a,b.promise);return{alreadyActive:!1,deferred:b}};b.$5=function(a,b,c){var d=this;return function(){return d.$7(a,b,c)}};b.$8=function(a){var b=this.implementations,c=this.implementationLoaders,d=b.get(a);if(d)return d;d=c.get(a);if(!d)return null;c=d();b.set(a,c);return c};b.$9=function(a,b){if(b==null||b.length===0)return Promise.resolve();var c=this.stepBlockers,e=c.get(b);e==null&&(e=d("WAJobRequirement").joinRequirements(b.map(function(a){return a()}),S),c.set(b,e));return e(a)};b.$10=function(a,b,c,e,f){var g,h=this;f===void 0&&(f={});var i=a.step;(g=f.eventFlow)==null||g.addPoint("start_step");var j=b.findIndex(function(a){return a.stepName===i});g=b[j].info(a.current,a.original,T(a,this.isRestartAfterCrash));var m=g.requirements,n=g.code;g=this.$9(a,m);e&&(g=g.then(e));return g.then(function(){var b;d("WALogger").LOG(k||(k=babelHelpers.taggedTemplateLiteralLoose(["",": running step"])),R(a));(b=f.eventFlow)==null||b.addPoint("run_step");return n(a.current,a.original,T(a,h.isRestartAfterCrash,f.eventFlow))}).then(function(e){var g;(g=f.eventFlow)==null||g.addPoint("step_is_complete");if(e instanceof d("WAPersistedJobManager").InterruptJob){d("WALogger").LOG(l||(l=babelHelpers.taggedTemplateLiteralLoose(["",": InterruptJob"])),R(a));return e.result}g=j+1;if(g>=b.length)return e;g=b[g];a.step=g.stepName;a.current=e;a.stepHardStartCountAfterTimeout=0;a.stepFirstStartTime=d("WATimeUtils").unixTime();a.stepUnexpectedErrorCount=0;a.waitUntil=null;a.backedOffCount=0;return c.updatePersistedJob(a).then(function(){return h.$10(a,b,c,void 0,f)})})};b.$7=async function(a,b,c){var e,f=this;c===void 0&&(c={});var g=this.activeJobs,h=this.deprecatedJobs,i=this.listeners,j=i.onJobFinished;i=i.onJobStarted;(e=c.eventFlow)==null||e.addPoint("run_job");e=await this.$8(a.type);h=h[a.type];if(!e){if(!h){d("WALogger").ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["No implementation for ",". Maybe it should have been put to the deprecated list?"])),a.type).sendLogs("missing-job-implementation");await b.deletePersistedJob(a.jobId);return null}else if(h==="NOOP"){d("WALogger").WARN(n||(n=babelHelpers.taggedTemplateLiteralLoose(["No implementation for deprecated ",", job deleted"])),a.type);await b.deletePersistedJob(a.jobId);return null}e=await h()}var k=e;h&&d("WALogger").LOG(o||(o=babelHelpers.taggedTemplateLiteralLoose(["Running deprecated job ",""])),a.type);var l=(h=a.stepFirstStartTime)!=null?h:d("WATimeUtils").unixTime();a.stepFirstStartTime=l;a.stepUnexpectedErrorCount=a.stepUnexpectedErrorCount||0;a.backedOffCount=a.backedOffCount||0;if(a.step===d("WAPersistedJobManager").FINISHED_JOB){h=a.waitUntil;var C=d("WATimeUtils").secondsUntil(l);h!=null&&d("WATimeUtils").isInFuture(h)&&C>0&&(d("WALogger").LOG(p||(p=babelHelpers.taggedTemplateLiteralLoose(["",": skew detected, adjusting accordingly"])),P(a)),h=d("WATimeUtils").castToUnixTime(h-C),d("WATimeUtils").isInFuture(h)&&(a.stepFirstStartTime=d("WATimeUtils").castToUnixTime(l-C),a.waitUntil=h,await b.updatePersistedJob(a)));(h==null||!d("WATimeUtils").isInFuture(h))&&(d("WALogger").LOG(q||(q=babelHelpers.taggedTemplateLiteralLoose(["",": removing completed, expired job from db"])),P(a)),await b.deletePersistedJob(a.jobId));g.delete(a.jobId);return a.current}C=a.step!==d("WAPersistedJobManager").UNSTARTED_JOB?e.find(function(b){return b.stepName===a.step}):e[0];if(!C){d("WALogger").ERROR(r||(r=babelHelpers.taggedTemplateLiteralLoose(["No implementation for ",".",""])),a.type,a.step).sendLogs("missing-job-step");await b.deletePersistedJob(a.jobId);return null}a.step=C.stepName;var D=function(){var e=a.waitUntil,g=Promise.resolve();if(e!=null){var h=d("WATimeUtils").futureUnixTime(d("WATimeUtils").DAY_SECONDS);e>h?(d("WALogger").LOG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["",": trim wait from "," to ",""])),R(a),e,h),a.waitUntil=h,g=b.updatePersistedJob(a).then(function(){return d("WATimeUtils").delayUntil(h)})):(d("WALogger").LOG(t||(t=babelHelpers.taggedTemplateLiteralLoose(["",": delaying until ",""])),R(a),e),g=d("WATimeUtils").delayUntil(e))}return g.then(function(){var e=function(){a.waitUntil=null;d("WATimeUtils").happenedWithin(l,d("WATimeUtils").DAY_SECONDS)||a.stepHardStartCountAfterTimeout++;return b.updatePersistedJob(a)};return f.$10(a,k,b,e,c).catch(function(e){if(e instanceof d("WAPersistedJobManager").RetryOnBackoff){var f;d("WALogger").LOG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["",": RetryOnBackoff"])),R(a));(f=c.eventFlow)==null||f.addPoint("retry_on_backoff");f=d("WAPromiseBackoffs").getDelay(++a.backedOffCount,e.backoffOptions);a.waitUntil=d("WATimeUtils").futureUnixTime(Math.ceil(f/1e3));a.stepHardStartCountAfterTimeout>0&&--a.stepHardStartCountAfterTimeout;return b.updatePersistedJob(a).then(D)}else{if(!(e instanceof d("WAPersistedJobManager").NonRetryableError)&&a.stepUnexpectedErrorCount<M){(f=c.eventFlow)==null||f.addPoint("retry_on_unexpected_error");d("WALogger").WARN(v||(v=babelHelpers.taggedTemplateLiteralLoose(["",": Unhandled exception. Tried "," times"])),R(a),a.stepUnexpectedErrorCount);d("WALogger").WARN(w||(w=babelHelpers.taggedTemplateLiteralLoose(["",": Unhandled exception: ",""])),R(a),e);a.stepUnexpectedErrorCount++;return b.updatePersistedJob(a).then(D)}throw e}})})},E=D();h=E.then(async function(c){d("WALogger").LOG(x||(x=babelHelpers.taggedTemplateLiteralLoose(["",": finished job"])),R(a));var e=null;try{e=j(a.jobId,a.type,a.original,c)}catch(b){d("WALogger").ERROR(y||(y=babelHelpers.taggedTemplateLiteralLoose(["onJobFinished for "," threw exception ",""])),a.type,b).sendLogs("onJobFinished-threw")}e!=null&&e>0?(a.waitUntil=d("WATimeUtils").futureUnixTime(Math.ceil(e/1e3)),a.step=d("WAPersistedJobManager").FINISHED_JOB,a.current=c,a.stepFirstStartTime=d("WATimeUtils").unixTime(),await b.updatePersistedJob(a)):(await b.deletePersistedJob(a.jobId),g.delete(a.jobId))},async function(c){d("WALogger").ERROR(z||(z=babelHelpers.taggedTemplateLiteralLoose([""," failed with error ",""])),a.type,c).sendLogs("job-threw-exception-"+a.type);c=k.find(function(b){return b.stepName===a.step});if(!c)d("WALogger").ERROR(A||(A=babelHelpers.taggedTemplateLiteralLoose(["",": "," step not found"])),a.type,a.step);else{c=c.info(a.current,a.original,T(a,f.isRestartAfterCrash));c.stopRetryIf!=null&&await c.stopRetryIf.onStopRetry(a.current,a.original,T(a,f.isRestartAfterCrash))}await b.deletePersistedJob(a.jobId);g.delete(a.jobId)});try{i(a.jobId,a.type,a.original)}catch(b){d("WALogger").ERROR(B||(B=babelHelpers.taggedTemplateLiteralLoose(["onJobStarted for "," threw exception ",""])),a.type,b).sendLogs("onJobStarted-threw")}return h.then(function(){return E})};b.addPersistedJobImplementation=function(a,b){var c=this.implementationLoaders,e=this.deprecatedJobs;if(c.has(a)){d("WALogger").ERROR(C||(C=babelHelpers.taggedTemplateLiteralLoose(["addPersistedJobImplementation called twice for ",""])),a).sendLogs("repeat-job-loader");return}e&&e[a]&&d("WALogger").DEV(D||(D=babelHelpers.taggedTemplateLiteralLoose([""," has been loaded and is marked as deprecated"])),a);c.set(a,b)};b.fireAndForget=function(a){var b=this;if(this.$1.indexOf(a.type)===-1){d("WALogger").LOG(E||(E=babelHelpers.taggedTemplateLiteralLoose(["",": running in forced non-persisted mode"])),a.type);this.fireAndForgetNonPersisted(a);return}d("WALogger").LOG(F||(F=babelHelpers.taggedTemplateLiteralLoose(["",": running in persisted mode"])),a.type);N({code:async function(c){var d={eventFlow:c};await b.initialJobsPromise;c.addPoint("initial_jobs_promise_fulfilled");return b.$6(a,b.accessors,d).then(function(a){return b.$4(a,b.accessors,d)})},annotations:{string:{name:a.type},bool:{offlineQueueMode:this.offlineQueueMode}}})};b.waitUntilPersisted=async function(a){var b=this;if(this.$1.indexOf(a.type)===-1){d("WALogger").LOG(G||(G=babelHelpers.taggedTemplateLiteralLoose(["",": running in forced non-persisted mode"])),a.type);this.fireAndForgetNonPersisted(a);return Promise.resolve()}d("WALogger").LOG(H||(H=babelHelpers.taggedTemplateLiteralLoose(["",": running in persisted mode"])),a.type);var c=O({string:{name:a.type},bool:{offlineQueueMode:this.offlineQueueMode}});await this.initialJobsPromise;c.addPoint("initial_jobs_promise_fulfilled");return this.$6(a,this.accessors,{eventFlow:c}).then(function(a){N({code:function(c){c={eventFlow:c};return b.$4(a,b.accessors,c)},eventFlow:c})}).catch(function(a){c.endFail("error",{string:{error:""+a}});throw a})};b.waitUntilCompleted=function(a){var b=this;if(this.$1.indexOf(a.type)===-1){d("WALogger").LOG(I||(I=babelHelpers.taggedTemplateLiteralLoose(["",": running in forced non-persisted mode"])),a.type);return this.waitUntilCompletedNonPersisted(a)}d("WALogger").LOG(J||(J=babelHelpers.taggedTemplateLiteralLoose(["",": running in persisted mode"])),a.type);return N({code:async function(c){var d={eventFlow:c};await b.initialJobsPromise;c.addPoint("initial_jobs_promise_fulfilled");return b.$6(a,b.accessors,d).then(function(a){return b.$4(a,b.accessors,d)})},annotations:{string:{name:a.type},bool:{offlineQueueMode:this.offlineQueueMode}}})};b.fireAndForgetNonPersisted=function(a){var b=this;N({code:async function(c){var d={eventFlow:c};await b.initialJobsPromise;c.addPoint("initial_jobs_promise_fulfilled");return b.$6(a,b.inMemoryAccessors,d).then(function(a){return b.$4(a,b.inMemoryAccessors,d)})},annotations:{string:{name:a.type},bool:{offlineQueueMode:this.offlineQueueMode}}})};b.waitUntilCompletedNonPersisted=function(a){var b=this;return N({code:async function(c){var d={eventFlow:c};await b.initialJobsPromise;c.addPoint("initial_jobs_promise_fulfilled");return b.$6(a,b.inMemoryAccessors,d).then(function(a){return b.$4(a,b.inMemoryAccessors,d)})},annotations:{string:{name:a.type},bool:{offlineQueueMode:this.offlineQueueMode}}})};return a}();function P(a){return"Job["+a.jobId+"] ("+a.type+")"}function Q(a){return"[Job "+a.type+"] "}function R(a){return"Job["+a.jobId+"] ("+a.type+"."+a.step+")"}function S(a,b,c){a==="unsatisfiable"?d("WALogger").LOG(K||(K=babelHelpers.taggedTemplateLiteralLoose([""," halting because of ",""])),R(c),b):a==="unsatisfied"?d("WALogger").LOG(L||(L=babelHelpers.taggedTemplateLiteralLoose([""," waiting on ",""])),R(c),b):a}function T(a,b,c){b===void 0&&(b=!1);return{jobStartTime:a.startTime,afterCrash:b,interruptJob:U,eventFlow:c}}function U(a){return new(d("WAPersistedJobManager").InterruptJob)(a)}g.PersistedJobManager=a}),98);
__d("WAWaitForComms",["WACommsConnectionState","WAResolvable"],(function(a,b,c,d,e,f,g){"use strict";var h=new(d("WAResolvable").Resolvable)();function a(){return h.promise}function b(){d("WACommsConnectionState").WACommsConnectionState.set(!1),h.isSettled&&(h=new(d("WAResolvable").Resolvable)())}function c(){d("WACommsConnectionState").WACommsConnectionState.set(!0),h.resolve()}function e(){return!h.resolveWasCalled()}function f(a){return h.reject(a)}g.waitForComms=a;g.commsConnectionLost=b;g.unblockComms=c;g.isStillWaitingForComms=e;g.failComms=f}),98);
__d("MAWJobManager",["MAWBridge","MAWDefinePersistedJob","MAWJobPersistenceAccessorsApi","WAPersistedJobManagerV2","WAWaitForComms","WAWaitForUserUnblocked","emptyFunction"],(function(a,b,c,d,e,f,g){"use strict";var h=new(d("WAPersistedJobManagerV2").PersistedJobManager)({accessors:d("MAWJobPersistenceAccessorsApi").getJobPersistenceAccessors(),deprecatedJobs:{removeCurrentDevice:"NOOP"},ignoreForceNonPersistedJobList:["sendMsg","sendBumpMsg","sendReactionMsg","sendMediaMsg","sendWrittenMsg","downloadAndHandleMedia"],isRestartAfterCrash:!1,listeners:{onJobFinished:function(a,b,c,e){d("MAWBridge").getBridge().fireAndForget("event","onJobFinished",{id:a,originalArgs:c,result:e,type:b},!0);return null},onJobStarted:c("emptyFunction")},offlineQueueCompletePromise:d("WAWaitForUserUnblocked").waitForUserUnblocked(),unfinishedJobEntries:d("WAWaitForComms").waitForComms().then(function(){return d("MAWJobPersistenceAccessorsApi").getJobPersistenceAccessors().loadAllJobs()})});function a(){return d("MAWDefinePersistedJob").persistedJobsApi}function b(){return h}g.getPersistedJobsApi=a;g.getJobManager=b}),98);
__d("WAJobBuilder",["Promise","WAPersistedJobManager","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";var h,i=function(){function a(a){this.steps=a}var b=a.prototype;b.step=function(a,b){return this.$1(a,typeof b==="function"?{code:b}:b)};b.$1=function(b,c){var e=c.stopRetryIf,f=c.requirements;c=c.code;f=k(f,c,e);if(e){var g=e.timePassedSeconds;c=e.appCrashed;var h=e.onStopRetry;h=k(null,l(h),e);g!=null&&(f=j(function(a,b,c){a=c.jobStartTime;return d("WATimeUtils").happenedWithin(a,g)},f,h));c&&(f=j(function(a,b,c){a=c.afterCrash;return!a},f,h))}return new a([].concat(this.steps,[{stepName:b,info:f}]))};b.finalStep=function(a,b){var c=this.step(a,b);return{end:function(){return c.steps}}};return a}();function a(){return new i([])}function j(a,b,c){return function(d,e,f){return a(d,e,f)?b(d,e,f):c(d,e,f)}}function k(a,b,c){var d={requirements:a,code:b,stopRetryIf:c};return function(){return d}}function l(a){return function(c,e,f){return(h||(h=b("Promise"))).resolve(a(c,e,f)).then(function(a){return a instanceof d("WAPersistedJobManager").InterruptJob?a:new(d("WAPersistedJobManager").InterruptJob)(a)})}}g.JobBuilder=i;g.definePersistedJob=a}),98);
__d("MAWDefinePersistedJob",["MAWJobManager","Promise","WAJobBuilder"],(function(a,b,c,d,e,f,g){"use strict";var h;e={definePersistedJob:function(){return d("WAJobBuilder").definePersistedJob()}};function a(a){var c=d("MAWJobManager").getJobManager();Object.keys(a).forEach(function(d){var e=a[d];c.addPersistedJobImplementation(d,function(){return(h||(h=b("Promise"))).resolve(e)})})}function c(a){var b=d("MAWJobManager").getJobManager();Object.keys(a).forEach(function(c){var d=a[c];b.addPersistedJobImplementation(c,d)})}g.persistedJobsApi=e;g.setMsgrJobImplementations=a;g.setMsgrDeferredJobImplementations=c}),98);
__d("MAWMediaBackupTxns",["FBLogger","MAWDbMediaTxns","MAWDexieTable","WALogger"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l=1;function m(a,b,e,f,g,n){n===void 0&&(n=0);return f==null?d("MAWDexieTable").dexieResolve():d("MAWDbMediaTxns").maybeGetMediaBackupRowFromObjectId(a,f).then(function(o){if(o==null){var p={mediaId:b,msgId:e,objectId:f};g!=null&&(p=babelHelpers["extends"]({},p,{fbid:g}));return a.mediaBackup.add(p).then(function(a){return babelHelpers["extends"]({},p,{mediaBackupId:a})})["catch"](function(j){if(j.name==="ConstraintError"){if(n<l){d("WALogger").WARN(h||(h=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Failed to add mediaBackup entry. Will attempt a retry. Error: ",""])),j);return m(a,b,e,f,g,n+1)}throw c("FBLogger")("messenger_web").mustfixThrow("Failed to add mediaBackup entry. Original error: %s, %s",j.name,j.message)}d("WALogger").ERROR(i||(i=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Failed to add mediaBackup entry: ",""])),j);throw j})}else if(o.mediaId!==b||o.msgId!==e){d("WALogger").WARN(j||(j=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] mediaId or msgId cannot differ for an objectId in mediaBackup"])));return o}else{if(o.fbid==null&&g!=null){var q=babelHelpers["extends"]({},o,{fbid:g});return a.mediaBackup.put(q).then(function(a){return q})}else d("WALogger").WARN(k||(k=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] fbid already exists for objectId"])));return o}})}g.linkMediaBackup=m}),98);
__d("MAWUnsafeCoerce",[],(function(a,b,c,d,e,f){"use strict";function a(a){return a}f.unsafeCoerce=a}),66);
__d("PersistedQueuesSchema",["MAWWormOdsLogger","WAHex","Worm","WormEAR","WormIDbDriver"],(function(a,b,c,d,e,f,g){"use strict";b={autoIncrement:!0,indexes:{"[jid+priority+stanzaId]":{fields:["jid","priority","stanzaId"],unique:!1},priority:{fields:["priority"],unique:!1}},nonEncryptedFields:["priority","stanzaId"],primaryKey:"stanzaQueueId",secure:!0};c={autoIncrement:!0,indexes:{},nonEncryptedFields:["uploadStatus","uploadTsSec","backupActionType"],primaryKey:"queueId",secure:!0};e={autoIncrement:!0,indexes:{},primaryKey:"queueId",secure:!0};f={autoIncrement:!0,indexes:{},primaryKey:"queueId",secure:!0};var h={danglingQueue:e,ebSenderUploadQueueV3:f,ebUploadQueue:c,stanzaQueue:b};function a(a,b,c,e,f,g){b=d("WAHex").parseHex(b);var i="pqdb";b=new(d("WormEAR").WormEAR)(h,i,b);return new(d("Worm").WormDatabase)(new(d("WormIDbDriver").WormIDbDriver)(a,i,h,b,d("MAWWormOdsLogger").wormOdsWorkerLogger,{blockingErrorThreshold:c,onBlockingError:e,onTransactionError:f}),g)}g.makePersistedQueueSchema=a}),98);
__d("PersistedQueueDB",["FBLogger","PersistedQueuesSchema","WAResolvable","WormEAR","err","getErrorSafe","promiseDone"],(function(a,b,c,d,e,f,g){"use strict";var h,i=new(d("WAResolvable").Resolvable)();async function a(a){var b=a.blockingErrorThreshold,e=a.dbName,f=a.onBlockingError,g=a.qplEvent;a=a.strEncKey;try{e=d("PersistedQueuesSchema").makePersistedQueueSchema(e,a,b,f,function(a){if(a instanceof d("WormEAR").DecryptionError){var b=a;c("FBLogger")("messenger_web").mustfix("EAR decryption error in store: %s. Dropping corrupted entity",b.store);c("promiseDone")((a=(a=h)==null?void 0:a.runInTransaction([b.store],"readwrite",function(a){a=a.stores[b.store];return b.maybeHashedPk!=null?a.delete(b.maybeHashedPk):a.clear()},"delete-corrupted-entity"))!=null?a:Promise.resolve())}},g);h=e;await e.init();i.resolve(e);return e}catch(a){c("FBLogger")("messenger_web").catching(c("getErrorSafe")(a)).mustfix("Error performing PersistedQueue init");throw a}}function b(){if(h==null)throw c("err")("PersistedQueue is not initialized");return h}function e(){return i.promise}g.makePersistedQueues=a;g.getPersistedQueues=b;g.getDbPromise=e}),98);
__d("WAThrottle",[],(function(a,b,c,d,e,f){"use strict";function a(a,b){var c=0,d=null,e;function f(){var f=Date.now(),g=f-c;for(var h=arguments.length,i=new Array(h),j=0;j<h;j++)i[j]=arguments[j];e=i;g>=b?(clearTimeout(d),d=null,a.apply(void 0,i),c=Date.now()):d==null&&(d=setTimeout(function(){return a.apply(void 0,e)},b-g))}return f}f.throttle=a}),66);
__d("PersistedQueueApi",["PersistedQueueDB","WALogger","WAThrottle"],(function(a,b,c,d,e,f,g){"use strict";var h;b=1e3*60*60;var i=function(a,b){return"PersistedQueue:"+a+":"+b};function a(){return{ack:l,clear:m,delete:n,get:j,index:k,keys:p,read:o,write:q}}function j(a,b){return d("PersistedQueueDB").getPersistedQueues().runInTransaction([a],"readonly",function(c){c=c.stores[a];return c.get(b)},i(a,"get"))}function k(a,b){return{equals:function(c){return{read:function(e){return d("PersistedQueueDB").getPersistedQueues().runInTransaction([a],"readonly",function(d){return d.stores[a].readIndexRange(b,{only:c},e)},i(a,"index-equal"))}}},keys:function(){return d("PersistedQueueDB").getPersistedQueues().runInTransaction([a],"readonly",function(c){return c.stores[a].readIndexKeys(b)},"index-keys")},read:async function(c){var e=await d("PersistedQueueDB").getPersistedQueues().runInTransaction([a],"readonly",function(d){return d.stores[a].readIndex(b,void 0,c)},i(a,"index-read"));return e}}}function l(a,b){return n(a,b)}function m(a){return d("PersistedQueueDB").getPersistedQueues().runInTransaction([a],"readwrite",function(b){return b.stores[a].clear()},i(a,"clear"))}function n(a,b){return d("PersistedQueueDB").getPersistedQueues().runInTransaction([a],"readwrite",async function(c){c=c.stores[a];await c.bulkDelete(b);s(a)},i(a,"delete"))}function o(a,b){return d("PersistedQueueDB").getPersistedQueues().runInTransaction([a],"readonly",function(c){return c.stores[a].readAll(b)},i(a,"read"))}function p(a){return d("PersistedQueueDB").getPersistedQueues().runInTransaction([a],"readonly",function(b){return b.stores[a].readKeys()},i(a,"keys"))}function q(a,b){return d("PersistedQueueDB").getPersistedQueues().runInTransaction([a],"readwrite",function(c){return c.stores[a].bulkAdd(b)},i(a,"write"))}function r(a){return d("PersistedQueueDB").getPersistedQueues().runInTransaction([a],"readwrite",async function(b){b=b.stores[a];var c=await b.readAll({limit:1});c.length===0&&await b.clear()},i(a,"ClearIfEmpty"))}var s=d("WAThrottle").throttle(function(a){r(a).catch(function(b){d("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["[PersistedQueueV2] Error during PQ clear operation of ",": ",""])),a,b)})},b);g.persistedQueueApi=a;g.persistedQueueGet=j;g.persistedQueueIndex=k;g.persistedQueueAck=l;g.persistedQueueClear=m;g.persistedQueueDelete=n;g.persistedQueueRead=o;g.persistedQueueKeys=p;g.persistedQueueWrite=q;g.clearIfEmpty=r}),98);
__d("WAMsgIdToMessageKey",["WAGlobals","WAJids"],(function(a,b,c,d,e,f,g){"use strict";function a(a){var b=a.author,c=a.externalId;a=a.chat;var e=d("WAJids").isAuthorMe(b),f=d("WAJids").interpretAsGroupJid(a);b=e?d("WAGlobals").getMyUserJid():b;a=a;f=f!=null?b:void 0;return{fromMe:e,id:c,remoteJid:a,participant:f}}g.msgIdToMessageKey=a}),98);
__d("WAAsConsumerApplication",["WAAssertUnreachable","WAConsumerApplication.pb","WAMsgIdToMessageKey","WAMsgType","err"],(function(a,b,c,d,e,f,g){"use strict";b="image/jpeg";e="video/mp4";f="audio/wav";var h="image/gif",i="image/webp";function a(a){switch(a.type){case d("WAMsgType").MSG_TYPE.TEXT:return j(a);case d("WAMsgType").MSG_TYPE.REACTION:return k(a);case d("WAMsgType").MSG_TYPE.REVOKED:return l(a);default:return c("WAAssertUnreachable")(a.type)}}function j(a){var b={payload:{content:{messageText:{mentionedJid:[],text:a.msgContent.content}}}};if(a.specialTextSize!=null){a=a.specialTextSize===1?d("WAConsumerApplication.pb").CONSUMER_APPLICATION_METADATA_SPECIAL_TEXT_SIZE.SMALL:a.specialTextSize===2?d("WAConsumerApplication.pb").CONSUMER_APPLICATION_METADATA_SPECIAL_TEXT_SIZE.MEDIUM:d("WAConsumerApplication.pb").CONSUMER_APPLICATION_METADATA_SPECIAL_TEXT_SIZE.LARGE;b.metadata={specialTextSize:a}}return b}function k(a){if(a.reactToMsgId==null)throw c("err")("cannot send reaction that reacts to no message");var b=d("WAMsgIdToMessageKey").msgIdToMessageKey(a.reactToMsgId);b={groupingKey:a.groupingKey==null?void 0:a.groupingKey,key:b,senderTimestampMs:a.ts,text:a.reaction==null?void 0:a.reaction};return{payload:{content:{reactionMessage:b}}}}function l(a){a={remoteJid:a.id.chat,fromMe:!0,id:a.revokedExternalId};return{payload:{applicationData:{revoke:{key:a}}}}}g.IMAGE_MIME_TYPE=b;g.VIDEO_MIME_TYPE=e;g.AUDIO_MIME_TYPE=f;g.GIF_MIME_TYPE=h;g.STICKER_MIME_TYPE=i;g.asConsumerApplication=a;g.encodeTextMessage=j;g.encodeReactionMessage=k}),98);
__d("WAFranking",["$InternalEnum","WACryptoDependencies","WACryptoHmac","WACryptoUtils","WAFrankingTypes","WAGlobals","WAPREList","WAPREMetrics"],(function(a,b,c,d,e,f,g){"use strict";var h=32,i=0,j=b("$InternalEnum").Mirrored(["KEEP","DROP"]);function a(){var a=new Uint8Array(h);d("WACryptoDependencies").getCrypto().getRandomValues(a);return d("WAFrankingTypes").castToFrankingKey(a)}function c(a){return a!=null?a:i}function e(a,b){return d("WACryptoHmac").hmacSha256(a,b).then(function(a){return d("WAFrankingTypes").castToFrankingTag(new Uint8Array(a))})}async function k(a,b,c,e){switch(e){case void 0:case 0:e=await d("WACryptoHmac").hmacSha256(b,a);return d("WACryptoUtils").uint8ArraysEqual(new Uint8Array(e),c);default:return!0}}async function f(a,b){var c,e=d("WAGlobals").getConfig().isFrankingDropOnInvalid();if((b==null?void 0:b.frankingTag)!=null&&((c=a.metadata)==null?void 0:c.frankingKey)==null){b.frankingTag=null;b.reportingTag=null;return{decision:j.KEEP,updatedReportingMeta:b}}if((b==null?void 0:b.frankingTag)!=null&&a.version==="v3"&&a.type==="subprotocol"&&((c=a.metadata)==null?void 0:c.frankingKey)!=null&&a.frankingContent!=null){c=b.frankingTag;var f=a.frankingContent,g=a.metadata.frankingVersion;a=d("WAFrankingTypes").castToFrankingKey(new Uint8Array(a.metadata.frankingKey));var h=d("WAPREMetrics").startMetric(d("WAPREList").PRE_METRIC.FRANKING_VALIDATION);if(a==null){h.endFail("tagButNoKey");return e?{decision:j.DROP,updatedReportingMeta:b}:{decision:j.KEEP,updatedReportingMeta:b}}if(!await k(new Uint8Array(f),a,c,g)){h.endFail("tagMismatch");return e?{decision:j.DROP,updatedReportingMeta:b}:{decision:j.KEEP,updatedReportingMeta:b}}b.frankingKey=a;b.reportingContent=f;h.endSuccess();return{decision:j.KEEP,updatedReportingMeta:b}}return d("WAGlobals").getConfig().isFrankingDropOnMissing()?{decision:j.DROP,updatedReportingMeta:b}:{decision:j.KEEP,updatedReportingMeta:b}}g.FrankingDecision=j;g.createFrankingKey=a;g.getFrankingVersion=c;g.genFrankingTag=e;g.validateFrankingTag=k;g.handleAndValidateFrankingFromIncomingMsg=f}),98);
__d("WAAsMessageApplication",["WAAsConsumerApplication","WAConsumerApplication.pb","WAFranking","WAMsgApplication.pb","encodeProtobuf"],(function(a,b,c,d,e,f,g){"use strict";function a(a){var b;switch(a.type){default:b=d("WAAsConsumerApplication").asConsumerApplication(a)}var c=a.forwardingScore!=null?a.forwardingScore:0;a=a.isForwarded!=null?a.isForwarded:!1;c={metadata:{chatEphemeralSetting:null,forwardingScore:c,frankingKey:d("WAFranking").createFrankingKey(),frankingVersion:d("WAFranking").getFrankingVersion(),isForwarded:a,quotedMessage:null}};if(b!=null){a=d("encodeProtobuf").encodeProtobuf(d("WAConsumerApplication.pb").ConsumerApplicationSpec,b);c.payload={subProtocol:{consumerMessage:{payload:a.readBuffer(),version:1}}}}return d("encodeProtobuf").encodeProtobuf(d("WAMsgApplication.pb").MessageApplicationSpec,c).readByteArrayView()}function b(a){return a}function c(a){return a.buffer}g.asMessageApplication=a;g.castToMessageApplicationBytes=b;g.castMessageApplicationBytesToBytes=c}),98);
__d("WAGetAgeBucketForMediaKeyTimestamp",["WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";function a(a){if(a==null)return"Missing";if(d("WATimeUtils").isInFuture(a))switch(!0){case d("WATimeUtils").happenedWithin(a,1*d("WATimeUtils").DAY_SECONDS):return"< 1 day in future";case d("WATimeUtils").happenedWithin(a,7*d("WATimeUtils").DAY_SECONDS):return"1-7 days in future";default:return"> 7 days in future"}switch(!0){case d("WATimeUtils").happenedWithin(a,1*d("WATimeUtils").DAY_SECONDS):return"< 1 day";case d("WATimeUtils").happenedWithin(a,7*d("WATimeUtils").DAY_SECONDS):return"1-7 days";case d("WATimeUtils").happenedWithin(a,14*d("WATimeUtils").DAY_SECONDS):return"7-14 days";case d("WATimeUtils").happenedWithin(a,21*d("WATimeUtils").DAY_SECONDS):return"14-21 days";case d("WATimeUtils").happenedWithin(a,30*d("WATimeUtils").DAY_SECONDS):return"21-30 days";case d("WATimeUtils").happenedWithin(a,40*d("WATimeUtils").DAY_SECONDS):return"30-40 days";case d("WATimeUtils").happenedWithin(a,50*d("WATimeUtils").DAY_SECONDS):return"40-50 days";case d("WATimeUtils").happenedWithin(a,60*d("WATimeUtils").DAY_SECONDS):return"50-60 days";default:return"> 60 days"}}g.getAgeBucketForMediaKeyTimestamp=a}),98);
__d("WAMapContentTypeToFbType",[],(function(a,b,c,d,e,f){"use strict";function a(a){switch(a){case"text":return"text";case"media":return"media";case"reaction":return"reaction";case"live_location":case"pay":case"product_list":case"poll_creation":case"poll_vote":case"scheduled_call":return"text";default:return"text"}}f.mapContentTypeToFbType=a}),66);
__d("WAPersistedQueueCache",["WAResolvable","WAShiftTimer","WATagsLogger"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a,b,c){var e=d("WATagsLogger").TAGS(["PersistedQueue",a,"cache"]),f=[],g=new(d("WAResolvable").Resolvable)(),i=c!=null?c:{},j=new(d("WAShiftTimer").ShiftTimer)(function(){void m()});return{commit:function(){return m()},add:function(a){f.push(a);a=g;k();l();return a.promise},config:function(a){i=a}};function k(){i.cacheSize!=null&&f.length>=i.cacheSize&&void m()}function l(){if(i.maxDelay!=null){var a=i.maxDelay;j.cancel();j.onOrAfter(a)}}async function m(){if(f.length===0)return;j.cancel();var a=f;f=[];var c=g;g=new(d("WAResolvable").Resolvable)();try{await b(a),c.resolve()}catch(a){e.ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Error during flush: ",""])),a);c.reject(a);throw a}}}g.makePersistedQueueCache=a}),98);
__d("WAPersistedQueue",["WALogger","WAPersistedQueueCache","WAPubSub"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k=function(){function a(a,b,c){var e=this;this.$1=d("WAPubSub").simplePubSub();this.$3=a;this.$4=b;this.$2=d("WAPersistedQueueCache").makePersistedQueueCache(a,function(c){return b.write(a,c).then(function(a){d("WALogger").DEV(h||(h=babelHelpers.taggedTemplateLiteralLoose(["[PersistedQueue] flush: ","}"])),c.length),e.$1.publish({type:"flush"})})},c)}var b=a.prototype;b.subscribe=function(a){return this.$1.subscribe(a)};b.index=function(a){return this.$4.index(this.$3,a)};b.keys=function(){return this.$4.keys(this.$3)};b.get=function(a){return this.$4.get(this.$3,a)};b.read=function(a){return this.$4.read(this.$3,a)};b.addAndCommit=function(a){var b=this;d("WALogger").DEV(i||(i=babelHelpers.taggedTemplateLiteralLoose(["[PersistedQueue] new entry & commit"])));this.$1.publish({type:"new_entity"});return this.$4.write(this.$3,a).then(function(c){d("WALogger").DEV(j||(j=babelHelpers.taggedTemplateLiteralLoose(["[PersistedQueue] flush: ","}"])),a.length);b.$1.publish({type:"flush"});return c})};b.commit=function(){return this.$2.commit()};b.ack=function(a){return this.$4.ack(this.$3,a)};b["delete"]=function(a){return this.$4["delete"](this.$3,a)};b.clear=function(){return this.$4.clear(this.$3)};return a}();function a(a,b,c){return new k(a,b,c)}g.PersistedQueue=k;g.initPersistedQueue=a}),98);
__d("WAProtocolQueue",["PersistedQueueApi","WAGlobals","WAJids","WALogger","WAMapContentTypeToFbType","WAPersistedQueue"],(function(a,b,c,d,e,f,g){"use strict";var h,i=5e3,j=null;function k(a){if(j!=null){d("WALogger").WARN(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Protocol Queue is already initialized"])));return j}a=d("WAPersistedQueue").initPersistedQueue("stanzaQueue",a,{cacheSize:null,maxDelay:i});j=a;return j}function l(){return!j?k(d("PersistedQueueApi").persistedQueueApi()):j}f=function(){function a(){this.$1=[],this.$2=[],this.$3=[]}var b=a.prototype;b.enqueue=function(a,b,c){this.$1.push(a),b&&this.$2.push(b),c&&this.$3.push(c)};b.flush=function(a,b,c,d,e){a=this.$1;var f=this.$2,g=this.$3;this.$1=[];this.$2=[];this.$3=[];return l().addAndCommit(a).then(function(){return f.forEach(function(a){return a()})})["catch"](function(a){return g.forEach(function(b){return b(a)})})};return a}();var m=new f();function a(a){return a.map(function(a){return a.type==="message"?n(a):babelHelpers["extends"]({},a)})}function n(a){switch(a.subtype){case"unavailable":var b=a,c=d("WAJids").extractUserJid(b.from);c={id:{author:d("WAGlobals").getMyUserJid()===c?"@me":c,chat:b.jid,externalId:b.stanzaId},ts:b.serverTs,type:"UnavailableMsg"};return{incomingType:"wa-incoming",jid:b.jid,message:{decrypted:c,details:{count:null,externalId:b.stanzaId,from:d("WAJids").switchOnMsgrChatJidType(b.jid,{group:function(a){return{author:b.from,chat:a,groupJid:a,type:"group"}},user:function(a){return{author:b.from,chat:a,deviceJid:b.from,type:"device"}}}),hideDecryptionFailure:!1,isInstamadillo:!1,offline:b.offline,recipient:b.recipient,reportingMeta:b.reportingMeta,retryCount:b.retryCount,ts:b.serverTs,type:d("WAMapContentTypeToFbType").mapContentTypeToFbType(b.contentType)}},priority:b.priority,stanzaId:b.stanzaId,stanzaQueueId:a.stanzaQueueId,type:b.type};case"armadillo":var e=a;c=d("WAJids").extractUserJid(e.from);c={folder:e.fbFolderId,id:{author:d("WAGlobals").getMyUserJid()===c?"@me":c,chat:e.jid,externalId:e.stanzaId},msg:e.message,recipientsCount:null,reportingMeta:e.reportingMeta,ts:e.serverTs,type:"IncomingMsg"};return{incomingType:a.incomingType,jid:e.jid,message:{decrypted:c,details:{count:null,externalId:e.stanzaId,from:d("WAJids").switchOnMsgrChatJidType(e.jid,{group:function(a){return{author:e.from,chat:a,groupJid:a,type:"group"}},user:function(a){return{author:e.from,chat:a,deviceJid:e.from,type:"device"}}}),hideDecryptionFailure:!1,isInstamadillo:!1,offline:e.offline,recipient:e.recipient,reportingMeta:e.reportingMeta,retryCount:e.retryCount,ts:e.serverTs,type:d("WAMapContentTypeToFbType").mapContentTypeToFbType(e.contentType)}},priority:e.priority,stanzaId:e.stanzaId,stanzaQueueId:a.stanzaQueueId,type:e.type,ebTimestampMs:e.ebTimestampMs};case"instamadillo":var f=a;c=d("WAJids").extractUserJid(f.from);c={folder:f.fbFolderId,id:{author:d("WAGlobals").getMyUserJid()===c?"@me":c,chat:f.jid,externalId:f.stanzaId},msg:f.message,recipientsCount:null,reportingMeta:f.reportingMeta,ts:f.serverTs,type:"InstamadilloMsg"};return{incomingType:"wa-incoming",jid:f.jid,message:{decrypted:c,details:{count:null,externalId:f.stanzaId,from:d("WAJids").switchOnMsgrChatJidType(f.jid,{group:function(a){return{author:f.from,chat:a,groupJid:a,type:"group"}},user:function(a){return{author:f.from,chat:a,deviceJid:f.from,type:"device"}}}),hideDecryptionFailure:!1,isInstamadillo:!0,offline:f.offline,recipient:f.recipient,reportingMeta:f.reportingMeta,retryCount:f.retryCount,ts:f.serverTs,type:d("WAMapContentTypeToFbType").mapContentTypeToFbType(f.contentType)}},priority:f.priority,stanzaId:f.stanzaId,stanzaQueueId:a.stanzaQueueId,type:f.type};case"ciphertext":c=function(){if(g.contentType==="reaction")return!1;return g.hideDecryptionFailure===!0?!1:!0};var g=a,h=d("WAJids").extractUserJid(g.from);c={createPlaceholder:c(),id:{author:d("WAGlobals").getMyUserJid()===h?"@me":h,chat:g.jid,externalId:g.stanzaId},ts:g.serverTs,type:"IncomingCiphertextMsg"};return{incomingType:"wa-incoming",jid:g.jid,message:{decrypted:c,details:{count:null,type:d("WAMapContentTypeToFbType").mapContentTypeToFbType(g.contentType),externalId:g.stanzaId,from:d("WAJids").switchOnMsgrChatJidType(g.jid,{group:function(a){return{author:g.from,chat:a,groupJid:a,type:"group"}},user:function(a){return{author:g.from,chat:a,deviceJid:g.from,type:"device"}}}),hideDecryptionFailure:!1,isInstamadillo:!1,offline:g.offline,recipient:g.recipient,reportingMeta:g.reportingMeta,retryCount:g.retryCount,ts:g.serverTs}},priority:g.priority,stanzaId:g.stanzaId,stanzaQueueId:a.stanzaQueueId,type:g.type};default:a;return babelHelpers["extends"]({},a)}}var o=9,p=7,q=5,r=2;function b(a){return a}function c(a){return a}function e(a){return a}g.initProtocolQueue=k;g.protocolQueue=l;g.PQFlushable=f;g.pqFlushable=m;g.mapProtocolEntriesV2toV1=a;g.mapProcolQueueMessageV2toV1=n;g.WAProtocolQueuePriorityHigh=o;g.WAProtocolQueuePriorityMid=p;g.WAProtocolQueuePriorityLow=q;g.WAProtocolQueuePriorityBackground=r;g.appdataApplicationProtocol=b;g.extractSubProtocolFromAppdataProtocol=c;g.numberToStanzaQueueId=e}),98);
__d("WASortedLists",[],(function(a,b,c,d,e,f){"use strict";function a(){return[]}function b(){return[]}function c(a,b){return a.filter(b)}function d(a,b){return l(a.map(b))}function e(a,b){var c=a.length===b.length;for(var d=0;c&&d<a.length;d++)a[d]!==b[d]&&(c=!1);return c}function g(a,b){for(var c=0;c<a.length;c++)if(a[c]===b)return a;return a.concat([b]).sort()}function h(a,b){if(a.length<b.length)return!1;var c=!0;for(var d=0,e=0;c&&e<b.length;e++)do c=a[d]===b[e];while(!c&&++d<a.length);return c}function i(a,b){var c=[];for(var d=0,e=0;d<a.length;d++){var f=a[d];while(e<b.length&&f>b[e])e++;(e===b.length||f<b[e])&&c.push(f)}return c}function j(a,b){var c=[],d=0,e=0;while(d<a.length&&e<b.length){var f=a[d],g=b[e];f<g?d++:f===g?(c.push(f),d++,e++):e++}return c}function k(a,b){var c=[],d=0,e=0;while(d<a.length&&e<b.length)a[d]<b[e]?c.push(a[d++]):a[d]===b[e]?(c.push(a[d++]),e++):c.push(b[e++]);while(d<a.length)c.push(a[d++]);while(e<b.length)c.push(b[e++]);return c}function l(a){return m(a.slice().sort())}function m(a){var b=!1;for(var c=0;c<a.length-1;c++)a[c]===a[c+1]&&(b=!0);if(!b)return a;c=[];for(b=0;b<a.length-1;b++)a[b]!==a[b+1]&&c.push(a[b]);c.push(a[a.length-1]);return c}function n(a){return Array.from(a).sort()}function o(a){return a.slice().sort()}function p(a,b,c){var d=null;for(var e=0;!d&&e<a.length;e++)a[e]===b&&(d=a.slice(),d[e]=c,d=m(d.sort()));return d||a}function q(a){return[a]}function r(a){return a.length<1}function s(a,b,c){return a.slice(b,c)}f.emptySet=a;f.emptyList=b;f.filter=c;f.map=d;f.areEqual=e;f.addToSet=g;f.contains=h;f.subtract=i;f.intersect=j;f.joinUniq=k;f.sortAndDedupe=l;f.asSortedSet=n;f.sort=o;f.swapIn=p;f.singleElement=q;f.isEmpty=r;f.slice=s}),66);